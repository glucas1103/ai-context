# User Story 1.7 : Refactorisation de la Structure du Codebase

## **Informations Générales**

| Champ | Valeur |
|-------|--------|
| **ID** | US-1.7 |
| **Titre** | Refactorisation de la Structure du Codebase |
| **Type** | Refactoring Technique |
| **Priorité** | Moyenne |
| **Story Points** | 8 |
| **Sprint** | Sprint 3 |
| **Assigné** | Équipe Frontend |

## **Contexte et Problématique**

La structure actuelle du codebase dans `apps/web/src/` présente plusieurs incohérences qui impactent la maintenabilité et l'évolutivité du projet :

### **Problèmes Identifiés**
1. **API Routes non standardisées** : Structure incohérente entre `github/repos` et `workspaces/[id]/context`
2. **Composants mal organisés** : Mélange de composants universels et spécifiques au même niveau
3. **Types dispersés** : Types éparpillés dans `lib/types/` au lieu d'être co-localisés
4. **Dossiers temporaires** : Présence de `test-docs/` non documenté
5. **Manque de conventions** : Absence de structure claire pour les utilitaires et constantes

### **Impact sur les Objectifs Produit**
- **Maintenabilité dégradée** : Difficulté à localiser et modifier le code
- **Onboarding ralenti** : Nouveaux développeurs perdent du temps à comprendre la structure
- **Risque d'erreurs** : Incohérences dans l'organisation augmentent les bugs
- **Vélocité réduite** : Temps de développement allongé pour les nouvelles fonctionnalités

## **User Story**

**En tant que** développeur frontend  
**Je veux** une structure de codebase cohérente et bien organisée  
**Afin de** améliorer la maintenabilité, faciliter l'onboarding et accélérer le développement

## **Critères d'Acceptation**

### **AC1 : Restructuration des API Routes**
- [ ] **Structure standardisée** : Toutes les API routes suivent le pattern `/api/{resource}/[id]/{action}`
- [ ] **Organisation logique** : Routes groupées par domaine fonctionnel
- [ ] **Nomenclature cohérente** : Noms de fichiers et endpoints standardisés
- [ ] **Documentation** : Chaque route a une documentation claire de son usage

### **AC2 : Réorganisation des Composants**
- [ ] **Séparation claire** : Composants universels vs spécifiques bien séparés
- [ ] **Groupement thématique** : Composants organisés par domaine (layout, ui, documentation, workspace)
- [ ] **Réutilisabilité** : Structure facilitant la réutilisation des composants
- **Structure cible :**
  ```
  components/
  ├── layout/           # Composants de mise en page
  ├── ui/              # Composants d'interface universels
  ├── documentation/   # Composants spécifiques à la documentation
  └── workspace/       # Composants spécifiques aux workspaces
  ```

### **AC3 : Restructuration des Types**
- [ ] **Co-localisation** : Types organisés par domaine d'usage
- [ ] **Séparation API/UI** : Types d'API séparés des types de composants
- [ ] **Nomenclature claire** : Conventions de nommage standardisées
- **Structure cible :**
  ```
  types/
  ├── api/             # Types pour les API
  ├── components/      # Types pour les composants
  ├── auth.ts          # Types d'authentification
  └── common.ts        # Types partagés
  ```

### **AC4 : Ajout de Dossiers Manquants**
- [ ] **Dossier constants** : Centralisation des constantes de l'application
- [ ] **Dossier utils** : Utilitaires réutilisables organisés par domaine
- [ ] **Hooks organisés** : Hooks personnalisés bien structurés

### **AC5 : Nettoyage et Documentation**
- [ ] **Suppression test-docs** : Dossier temporaire supprimé ou documenté
- [ ] **Mise à jour architecture.md** : Documentation technique à jour
- [ ] **Guide de conventions** : Document de bonnes pratiques créé

## **Détails Techniques**

### **Phase 1 : Nettoyage Immédiat**

#### **1.1 Suppression du Dossier test-docs**
```bash
# Vérifier le contenu et l'usage
ls -la apps/web/src/app/api/test-docs/
# Supprimer si non utilisé
rm -rf apps/web/src/app/api/test-docs/
```

#### **1.2 Restructuration des API Routes**
**Structure actuelle :**
```
api/
├── github/repos/
├── workspaces/[id]/
│   ├── analyze/
│   ├── context/
│   ├── documentation/
│   └── issues/
└── test-docs/  # À supprimer
```

**Structure cible :**
```
api/
├── auth/
│   ├── callback/
│   └── signout/
├── github/
│   └── repos/
├── workspaces/
│   ├── route.ts                    # GET /api/workspaces
│   └── [id]/
│       ├── route.ts               # GET/PUT/DELETE /api/workspaces/[id]
│       ├── analyze/
│       │   └── route.ts           # POST /api/workspaces/[id]/analyze
│       ├── context/
│       │   ├── route.ts           # GET /api/workspaces/[id]/context
│       │   ├── tree/
│       │   │   └── route.ts       # GET /api/workspaces/[id]/context/tree
│       │   └── file-content/
│       │       └── route.ts       # GET /api/workspaces/[id]/context/file-content
│       ├── documentation/
│       │   ├── route.ts           # GET /api/workspaces/[id]/documentation
│       │   ├── tree/
│       │   │   └── route.ts       # GET /api/workspaces/[id]/documentation/tree
│       │   ├── files/
│       │   │   └── route.ts       # CRUD /api/workspaces/[id]/documentation/files
│       │   └── folders/
│       │       └── route.ts       # CRUD /api/workspaces/[id]/documentation/folders
│       └── issues/
│           └── route.ts           # GET/POST /api/workspaces/[id]/issues
└── health/
    └── route.ts                   # GET /api/health
```

### **Phase 2 : Restructuration des Composants**

#### **2.1 Création de la Nouvelle Structure**
```bash
# Créer les nouveaux dossiers
mkdir -p apps/web/src/components/{layout,ui,documentation,workspace}
mkdir -p apps/web/src/components/ui/universal
```

#### **2.2 Migration des Composants**
**Déplacements à effectuer :**

```typescript
// Déplacer les composants de layout
mv apps/web/src/components/ThreePanelsLayout.tsx apps/web/src/components/layout/
mv apps/web/src/components/ErrorScreen.tsx apps/web/src/components/ui/
mv apps/web/src/components/LoadingScreen.tsx apps/web/src/components/ui/

// Déplacer les composants universels
mv apps/web/src/components/universal/* apps/web/src/components/ui/universal/

// Déplacer les composants spécifiques
mv apps/web/src/components/documentation/* apps/web/src/components/documentation/
mv apps/web/src/components/RichTextEditor.tsx apps/web/src/components/documentation/

// Créer de nouveaux composants workspace
touch apps/web/src/components/workspace/WorkspaceSelector.tsx
touch apps/web/src/components/workspace/WorkspaceHeader.tsx
```

#### **2.3 Mise à Jour des Imports**
**Exemple de refactoring des imports :**

```typescript
// Avant
import { ThreePanelsLayout } from '@/components/ThreePanelsLayout'
import { UniversalChatPanel } from '@/components/universal/UniversalChatPanel'

// Après
import { ThreePanelsLayout } from '@/components/layout/ThreePanelsLayout'
import { UniversalChatPanel } from '@/components/ui/universal/UniversalChatPanel'
```

### **Phase 3 : Restructuration des Types**

#### **3.1 Création de la Nouvelle Structure**
```bash
# Créer les nouveaux dossiers de types
mkdir -p apps/web/src/types/{api,components}
```

#### **3.2 Migration des Types**
```typescript
// Déplacer et réorganiser les types
mv apps/web/src/lib/types/context.ts apps/web/src/types/api/workspace.ts
mv apps/web/src/lib/types/documentation.ts apps/web/src/types/api/documentation.ts
mv apps/web/src/lib/types/universal-components.ts apps/web/src/types/components/universal.ts

// Créer de nouveaux fichiers de types
touch apps/web/src/types/api/github.ts
touch apps/web/src/types/components/ui.ts
touch apps/web/src/types/auth.ts
```

#### **3.3 Exemple de Structure des Types**
```typescript
// types/api/workspace.ts
export interface Workspace {
  id: string;
  name: string;
  url: string;
  ownerId: string;
  knowledgeBaseId?: string;
}

// types/components/universal.ts
export interface ThreePanelsLayoutProps {
  leftPanel: React.ReactNode;
  centerPanel: React.ReactNode;
  rightPanel: React.ReactNode;
  layoutConfig?: LayoutConfig;
}
```

### **Phase 4 : Ajout de Dossiers Manquants**

#### **4.1 Dossier Constants**
```bash
mkdir -p apps/web/src/constants
touch apps/web/src/constants/api.ts
touch apps/web/src/constants/routes.ts
touch apps/web/src/constants/ui.ts
```

**Exemple de contenu :**
```typescript
// constants/api.ts
export const API_ENDPOINTS = {
  WORKSPACES: '/api/workspaces',
  GITHUB_REPOS: '/api/github/repos',
  AUTH_CALLBACK: '/api/auth/callback',
} as const;

// constants/routes.ts
export const ROUTES = {
  HOME: '/',
  LOGIN: '/login',
  WORKSPACES: '/workspaces',
  WORKSPACE_CONTEXT: (id: string) => `/workspaces/${id}/context`,
  WORKSPACE_DOCUMENTATION: (id: string) => `/workspaces/${id}/documentation`,
  WORKSPACE_ISSUES: (id: string) => `/workspaces/${id}/issues`,
} as const;
```

#### **4.2 Dossier Utils**
```bash
mkdir -p apps/web/src/utils
touch apps/web/src/utils/api.ts
touch apps/web/src/utils/auth.ts
touch apps/web/src/utils/formatting.ts
```

**Exemple de contenu :**
```typescript
// utils/api.ts
export const apiClient = {
  async get<T>(endpoint: string): Promise<T> {
    const response = await fetch(endpoint);
    if (!response.ok) throw new Error(`API Error: ${response.status}`);
    return response.json();
  },
  
  async post<T>(endpoint: string, data: any): Promise<T> {
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    if (!response.ok) throw new Error(`API Error: ${response.status}`);
    return response.json();
  },
};

// utils/formatting.ts
export const formatFileSize = (bytes: number): string => {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
};
```

### **Phase 5 : Documentation et Tests**

#### **5.1 Mise à Jour de l'Architecture**
```markdown
# Mettre à jour doc/architecture.md
- Ajouter la section "Structure du Codebase"
- Documenter les conventions de nommage
- Expliquer l'organisation des dossiers
```

#### **5.2 Création du Guide de Conventions**
```markdown
# docs/development/code-conventions.md
## Structure des Dossiers
## Conventions de Nommage
## Patterns d'API
## Organisation des Composants
## Gestion des Types
```

#### **5.3 Mise à Jour des Tests**
```bash
# Mettre à jour les imports dans les tests
find apps/web/src -name "*.test.ts" -exec sed -i '' 's/@\/components\/ThreePanelsLayout/@\/components\/layout\/ThreePanelsLayout/g' {} \;
```

## **Plan de Déploiement**

### **Étape 1 : Préparation (1 jour)**
- [ ] Créer une branche `refactor/structure-cleanup`
- [ ] Sauvegarder l'état actuel
- [ ] Créer un plan de rollback

### **Étape 2 : Nettoyage (1 jour)**
- [ ] Supprimer le dossier `test-docs/`
- [ ] Identifier tous les imports à mettre à jour
- [ ] Créer un script de migration

### **Étape 3 : Restructuration (3 jours)**
- [ ] Migrer les API routes
- [ ] Réorganiser les composants
- [ ] Restructurer les types
- [ ] Ajouter les dossiers manquants

### **Étape 4 : Tests et Validation (2 jours)**
- [ ] Mettre à jour tous les imports
- [ ] Exécuter la suite de tests complète
- [ ] Valider le fonctionnement de l'application
- [ ] Tester les parcours utilisateurs critiques

### **Étape 5 : Documentation (1 jour)**
- [ ] Mettre à jour l'architecture.md
- [ ] Créer le guide de conventions
- [ ] Documenter les changements

## **Risques et Mitigation**

### **Risque 1 : Casse de Build**
- **Mitigation** : Tests complets avant merge, rollback planifié
- **Détection** : CI/CD avec vérification automatique

### **Risque 2 : Imports Cassés**
- **Mitigation** : Script de migration automatisé, recherche globale
- **Détection** : TypeScript compiler, ESLint

### **Risque 3 : Régression Fonctionnelle**
- **Mitigation** : Tests E2E complets, validation manuelle
- **Détection** : Playwright tests, parcours utilisateurs

## **Métriques de Succès**

### **Métriques Techniques**
- [ ] **0 erreurs de build** après refactoring
- [ ] **100% des tests passent** (unitaires, intégration, E2E)
- [ ] **Temps de build inchangé** ou amélioré
- [ ] **Bundle size stable** ou réduit

### **Métriques Qualité**
- [ ] **Score ESLint** maintenu ou amélioré
- [ ] **Couverture de tests** maintenue
- [ ] **TypeScript strict mode** sans erreurs

### **Métriques Développement**
- [ ] **Temps de localisation de code** réduit de 30%
- [ ] **Nouveaux développeurs** peuvent naviguer efficacement en < 1h
- [ ] **Ajout de nouvelles fonctionnalités** accéléré de 20%

## **Dépendances**

### **Dépendances Techniques**
- **Aucune** : Refactoring autonome, pas de nouvelles dépendances

### **Dépendances Équipe**
- **Validation PO** : Approbation de la structure finale
- **Review Dev** : Code review de tous les changements
- **Tests QA** : Validation des parcours utilisateurs

## **Notes et Considérations**

### **Impact sur les Objectifs Produit**
Cette refactorisation contribue directement aux objectifs du PRD :
- **Réduction du temps d'onboarding** : Structure claire pour nouveaux développeurs
- **Amélioration de la vélocité** : Code plus maintenable et évolutif
- **Qualité du code** : Standards et conventions établis

### **Alignement avec l'Architecture**
La nouvelle structure respecte les principes définis dans `architecture.md` :
- **Monorepo** : Organisation claire dans `apps/web/`
- **Next.js 14** : Respect des conventions App Router
- **TypeScript** : Types bien organisés et typés

### **Évolutivité Future**
La structure proposée facilite :
- **Ajout de nouvelles fonctionnalités** : Organisation claire par domaine
- **Intégration de nouveaux services** : API routes standardisées
- **Équipes multiples** : Séparation claire des responsabilités

---

**Auteur :** Sarah (PO)  
**Date de création :** 2025-01-26  
**Version :** 1.0  
**Statut :** À implémenter
