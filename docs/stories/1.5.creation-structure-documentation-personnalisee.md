# Story 1.5: creation-structure-documentation-personnalisee

## Status
To Do

## Story
**As a** Gardien du Contexte (Tech Lead/CTO),
**I want** créer une page dédiée "Documentation" avec un éditeur de documentation personnalisée,
**so that** je puisse structurer et rédiger la documentation de ma codebase selon mes besoins métier et organisationnels spécifiques, avec un éditeur riche et une interface intuitive.

## Acceptance Criteria
1. Une nouvelle page "Documentation" est accessible depuis la navigation du workspace
2. L'interface utilise un triple panneau : navigation interactive à gauche, éditeur riche au centre, placeholder chat à droite
3. Le panneau gauche permet de créer, supprimer, renommer et réorganiser (drag & drop) des dossiers et fichiers (`.md`, `.doc`, etc.)
4. Le panneau central utilise TipTap pour l'édition de markdown avec support du rich text (H1, H2, gras, italique, listes, etc.)
5. La structure de documentation est persistée de manière sécurisée dans Supabase
6. Les opérations CRUD (Create, Read, Update, Delete) sont disponibles pour gérer la structure et le contenu
7. L'interface respecte l'identité visuelle définie (thème sombre, triple panneau)
8. L'auto-sauvegarde fonctionne en temps réel pour éviter la perte de données
9. Le panneau droit est préparé pour l'intégration future d'un chat

## Tasks / Subtasks
- [ ] Créer la page "Documentation" dans la navigation (AC: 1, 7)
  - [ ] Ajouter le lien "Documentation" dans le layout du workspace
  - [ ] Créer la page `/apps/web/app/(pages)/workspaces/[id]/documentation/page.tsx`
  - [ ] Implémenter le layout triple panneau avec thème sombre
  - [ ] Ajouter l'icône et le style cohérent avec l'identité visuelle
- [ ] Étendre le modèle de données pour la documentation personnalisée (AC: 5)
  - [ ] Créer la table `custom_documentation` dans Supabase
  - [ ] Définir les relations avec `workspaces` et `knowledge_bases`
  - [ ] Implémenter Row Level Security (RLS) pour l'isolation des données
  - [ ] Créer les index appropriés pour les performances
  - [ ] Ajouter les triggers pour `updated_at`
- [ ] Créer l'API de gestion de la documentation (AC: 3, 6)
  - [ ] Créer `POST /api/workspaces/[id]/documentation/folders` pour création de dossiers
  - [ ] Créer `POST /api/workspaces/[id]/documentation/files` pour création de fichiers
  - [ ] Créer `DELETE /api/workspaces/[id]/documentation/[itemId]` pour suppression
  - [ ] Créer `PUT /api/workspaces/[id]/documentation/[itemId]` pour renommage/déplacement
  - [ ] Créer `PUT /api/workspaces/[id]/documentation/[itemId]/content` pour sauvegarde contenu
  - [ ] Implémenter la validation des noms et de la hiérarchie
- [ ] Implémenter le panneau de navigation interactif (AC: 3, 7)
  - [ ] Créer un composant React Arborist modifié pour supporter les actions CRUD
  - [ ] Ajouter les boutons contextuels "Nouveau dossier" et "Nouveau fichier"
  - [ ] Implémenter les modales/formulaires de création avec validation
  - [ ] Intégrer le drag & drop pour réorganiser la structure
  - [ ] Ajouter les actions de suppression et renommage
  - [ ] Appliquer le thème sombre cohérent
- [ ] Intégrer TipTap dans le panneau central (AC: 4, 8)
  - [ ] Installer et configurer TipTap avec les extensions nécessaires
  - [ ] Créer un composant d'édition avec support markdown et rich text
  - [ ] Implémenter l'auto-sauvegarde en temps réel
  - [ ] Gérer l'affichage des fichiers vides et existants
  - [ ] Intégrer avec l'API de sauvegarde de contenu
- [ ] Préparer le panneau droit pour le chat (AC: 9)
  - [ ] Créer un composant placeholder avec design cohérent
  - [ ] Ajouter un message d'information sur la fonctionnalité à venir
  - [ ] Préparer la structure pour l'intégration future
- [ ] Gérer la persistance et la synchronisation (AC: 5, 6, 8)
  - [ ] Implémenter l'auto-sauvegarde lors des modifications de contenu
  - [ ] Gérer les conflits et la validation côté serveur
  - [ ] Implémenter le cache côté client pour les performances
  - [ ] Ajouter la gestion d'erreurs avec rollback en cas d'échec
  - [ ] Optimiser les performances pour les gros fichiers
- [ ] Optimiser l'expérience utilisateur (AC: 7, 8)
  - [ ] Ajouter des états de chargement pour les opérations CRUD
  - [ ] Implémenter les raccourcis clavier pour les actions fréquentes
  - [ ] Créer des tooltips et aide contextuelle
  - [ ] Ajouter des confirmations pour les actions destructives
  - [ ] Optimiser la réactivité de l'interface

## Dev Notes

### Documentations Pertinentes

**TipTap (Éditeur Rich Text) :**
- **Documentation officielle :** https://tiptap.dev/
- **Installation React :** `npm install @tiptap/react @tiptap/pm @tiptap/starter-kit`
- **Extensions principales :**
  - `@tiptap/starter-kit` : Extensions de base (paragraphe, titre, gras, italique, etc.)
  - `@tiptap/extension-heading` : Titres H1-H6
  - `@tiptap/extension-bold` : Texte en gras
  - `@tiptap/extension-italic` : Texte en italique
  - `@tiptap/extension-list-item` : Listes à puces et numérotées
  - `@tiptap/extension-blockquote` : Citations
  - `@tiptap/extension-code-block` : Blocs de code
  - `@tiptap/extension-link` : Liens
  - `@tiptap/extension-image` : Images
- **Configuration SSR :** Utiliser `immediatelyRender: false` pour Next.js
- **Auto-sauvegarde :** Utiliser `onUpdate` callback pour détecter les changements

**React Arborist (Navigation Arborescente) :**
- **Documentation officielle :** https://github.com/brimdata/react-arborist
- **Installation :** `npm install react-arborist`
- **Fonctionnalités clés :**
  - Drag & drop natif pour réorganiser la structure
  - Édition inline des noms de fichiers/dossiers
  - Sélection multiple avec Ctrl/Cmd + clic
  - Recherche et filtrage des nœuds
  - Rendu virtuel pour les grandes structures
  - Support des raccourcis clavier
- **Callbacks principaux :**
  - `onCreate` : Création de nouveaux éléments
  - `onRename` : Renommage d'éléments
  - `onMove` : Déplacement d'éléments
  - `onDelete` : Suppression d'éléments
  - `onSelect` : Gestion de la sélection
- **Personnalisation :**
  - `renderRow` : Personnalisation de l'affichage des lignes
  - `renderDragPreview` : Personnalisation de l'aperçu de drag
  - `renderCursor` : Personnalisation du curseur de drop

### Architecture Technique Pertinente
D'après les documents d'architecture, PRD et UX Spec, voici les éléments clés pour cette story :

**Nouveau Modèle de Données :**
Basé sur le schema existant dans `architecture.md`, nous créons une nouvelle table dédiée :

```sql
-- Nouvelle table pour la documentation personnalisée
CREATE TABLE custom_documentation (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES workspaces(id) ON DELETE CASCADE,
    parent_id UUID REFERENCES custom_documentation(id) ON DELETE CASCADE, -- NULL pour racine
    name TEXT NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('folder', 'file')), 
    path TEXT NOT NULL, -- chemin virtuel dans la structure (ex: "/architecture/database.md")
    content TEXT, -- contenu du fichier .md (NULL pour dossiers)
    metadata JSONB DEFAULT '{}', -- métadonnées additionnelles
    order_index INTEGER DEFAULT 0, -- pour l'ordre d'affichage
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- Index pour les performances
CREATE INDEX idx_custom_doc_workspace ON custom_documentation(workspace_id);
CREATE INDEX idx_custom_doc_parent ON custom_documentation(parent_id);
CREATE UNIQUE INDEX idx_custom_doc_path ON custom_documentation(workspace_id, path);

-- Trigger pour updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_custom_documentation_updated_at 
    BEFORE UPDATE ON custom_documentation 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

**Structure des API Routes :**
```
/apps/web/app/api/workspaces/[id]/documentation/
├── folders/route.ts                 # POST pour créer dossiers
├── files/route.ts                   # POST pour créer fichiers  
├── [itemId]/route.ts               # PUT/DELETE pour modifier/supprimer
├── [itemId]/content/route.ts       # PUT pour sauvegarder contenu
└── tree/route.ts                   # GET pour récupérer la structure complète
```

**Interface TypeScript :**
```typescript
interface DocumentationNode {
  id: string;
  name: string;
  type: 'folder' | 'file';
  path: string; // chemin virtuel (ex: "/architecture/database.md")
  content?: string; // pour fichiers .md, .doc, etc.
  fileExtension?: string; // extension du fichier (.md, .doc, etc.)
  parent_id?: string;
  children?: DocumentationNode[];
  metadata?: {
    created_by: string;
    description?: string;
    tags?: string[];
    last_edited?: string;
    mimeType?: string; // pour différencier les types de fichiers
  };
  order_index: number;
  created_at: string;
  updated_at: string;
}

interface DocumentationState {
  currentFile: DocumentationNode | null;
  isEditing: boolean;
  hasUnsavedChanges: boolean;
  autoSaveEnabled: boolean;
}
```

**Integration TipTap (Panneau Central) :**
Configuration TipTap avec les extensions nécessaires :
```typescript
import { useEditor, EditorContent } from '@tiptap/react'
import StarterKit from '@tiptap/starter-kit'
import { Heading } from '@tiptap/extension-heading'
import { Bold, Italic, Underline } from '@tiptap/extension-bold'
import { ListItem, BulletList, OrderedList } from '@tiptap/extension-list-item'
import { Blockquote } from '@tiptap/extension-blockquote'
import { CodeBlock } from '@tiptap/extension-code-block'
import { Link } from '@tiptap/extension-link'
import { Image } from '@tiptap/extension-image'

// Configuration avec extensions pour rich text
const editorConfig = {
  extensions: [
    StarterKit,
    Heading.configure({
      levels: [1, 2, 3, 4, 5, 6]
    }),
    Bold,
    Italic,
    Underline,
    ListItem,
    BulletList,
    OrderedList,
    Blockquote,
    CodeBlock,
    Link,
    Image
  ],
  content: '<p>Contenu initial...</p>',
  editorProps: {
    attributes: {
      class: 'prose prose-sm sm:prose lg:prose-lg xl:prose-2xl mx-auto focus:outline-none'
    }
  }
}
```

**Integration React Arborist Modifié (Panneau Gauche) :**
Extension du composant pour supporter les actions CRUD :
- Actions contextuelles (clic droit) : Nouveau dossier, Nouveau fichier, Renommer, Supprimer
- Drag & drop pour réorganiser la structure
- Boutons d'action visibles au survol
- Validation en temps réel des noms

```typescript
import { Tree } from 'react-arborist'

// Configuration React Arborist pour la navigation de documentation
const treeConfig = {
  data: documentationNodes,
  onCreate: ({ parentId, index, type }) => {
    // Logique de création de dossier/fichier
  },
  onRename: ({ id, name }) => {
    // Logique de renommage
  },
  onMove: ({ dragIds, parentId, index }) => {
    // Logique de déplacement
  },
  onDelete: ({ ids }) => {
    // Logique de suppression
  },
  renderRow: ({ node, style, dragHandle }) => (
    <div style={style} ref={dragHandle} className="flex items-center p-2 hover:bg-gray-700">
      <span className="mr-2">
        {node.isLeaf ? '📄' : '📁'}
      </span>
      <span>{node.data.name}</span>
      <div className="ml-auto opacity-0 group-hover:opacity-100">
        {/* Boutons d'action */}
      </div>
    </div>
  )
}
```

**Navigation et Routing :**
- Nouvelle route : `/workspaces/[id]/documentation`
- Ajout dans le layout du workspace avec icône appropriée
- Gestion de l'état de navigation active

**Messages UX Clés (d'après UX Spec) :**
- **Documentation dédiée** : "Créez et organisez votre documentation métier"
- **Édition riche** : "Rédigez avec un éditeur moderne et intuitif"
- **Structure flexible** : "Organisez selon votre logique, pas celle du code"

**Identité Visuelle (UX Spec) :**
- **Palette de Couleurs (Thème Sombre) :**
  - Fond : `#111827` (Gris foncé)
  - Panneaux : `#1F2937` (Gris moyen)  
  - Accent : `#3B82F6` (Bleu vif)
  - Texte : `#D1D5DB` / `#FFFFFF`
- **Iconographie :** Heroicons (document-text, folder, plus, trash, edit, chat-bubble)
- **Interactions :** Boutons contextuels, modales soignées, transitions fluides

**Validation et Contraintes :**
- Noms de fichiers/dossiers : validation regex (caractères autorisés, longueur 1-255)
- Profondeur maximale de hiérarchie : 10 niveaux
- Taille maximale des fichiers `.md` : 2MB
- Gestion des noms en conflit avec auto-incrémentation
- Auto-sauvegarde toutes les 3 secondes après arrêt de frappe

**Performance et Optimisation :**
- Debouncing pour l'auto-sauvegarde (300ms)
- Lazy loading des contenus de fichiers
- Cache côté client pour la structure
- Optimisation des requêtes Supabase avec pagination si nécessaire

**Integration avec l'Architecture Existante :**
- Réutilisation des clients Supabase configurés (`lib/supabase/client.ts`, `lib/supabase/server.ts`)
- Extension du pattern de navigation du workspace
- Utilisation des patterns d'authentification et sécurité de la Story 1.2
- Cohérence avec l'API workspace de la Story 1.3

### Testing
**Standards de Test (d'après l'architecture) :**
- **Tests Unitaires :** Jest pour les utilitaires CRUD et validation
- **Tests d'Intégration :** Jest/React Testing Library pour les API et composants
- **Tests E2E :** Playwright pour le parcours complet de création et édition
- **Tests de Performance :** Validation des opérations sur structures complexes

**Frameworks :**
- Jest (Latest) - déjà configuré
- React Testing Library - déjà configuré  
- Playwright (Latest) - déjà configuré

**Tests Spécifiques à cette Story :**
- Tests unitaires pour la validation des noms et hiérarchie
- Tests d'intégration pour les API CRUD avec Supabase
- Tests de persistence et auto-sauvegarde
- Tests E2E du flux complet (création → édition → sauvegarde)
- Tests des interactions drag & drop et raccourcis clavier
- Tests de performance TipTap avec gros contenus
- Tests de l'interface responsive et accessible

**Mock Strategy :**
- Mock des réponses Supabase pour tests isolés
- Mock des composants TipTap pour tests de logique pure
- Test datasets avec différentes structures et contenus
- Mock du localStorage pour tests de persistence

## Change Log
| Date       | Version | Description              | Auteur |
|------------|---------|--------------------------|--------|
| 12/01/2025 | 1.0     | Création initiale story  | Sarah  |
| 12/01/2025 | 2.0     | Refactorisation page séparée avec MDXEditor | Sarah  |
| 12/01/2025 | 3.0     | Réinitialisation - remise à zéro pour nouvelle implémentation | Sarah |

## Dev Agent Record

### Agent Model Used
- **Agent:** À définir (Full Stack Developer)
- **Model:** BMAD Core Dev Agent
- **Focus:** Implementation and testing of documentation system

### Debug Log References
*À venir lors de l'implémentation*

### Completion Notes List
*À compléter lors de l'implémentation*

### File List
**Fichiers à créer :**
- `apps/web/src/lib/types/documentation.ts` - Types TypeScript
- `apps/web/src/app/api/workspaces/[id]/documentation/tree/route.ts` - API arborescence
- `apps/web/src/app/api/workspaces/[id]/documentation/folders/route.ts` - API création dossiers
- `apps/web/src/app/api/workspaces/[id]/documentation/files/route.ts` - API création fichiers
- `apps/web/src/app/api/workspaces/[id]/documentation/[itemId]/route.ts` - API CRUD éléments
- `apps/web/src/app/api/workspaces/[id]/documentation/[itemId]/content/route.ts` - API contenu
- `apps/web/src/components/documentation/MarkdownEditor.tsx` - Éditeur TipTap
- `apps/web/src/components/documentation/DocumentationTree.tsx` - Navigation arborescente
- `apps/web/src/components/documentation/ChatPanel.tsx` - Panneau chat placeholder
- `apps/web/src/app/(pages)/workspaces/[id]/documentation/page.tsx` - Page principale

**Fichiers à modifier :**
- `apps/web/package.json` - Ajouter dépendances TipTap et React Arborist
- Layout du workspace - Ajouter navigation vers Documentation

## QA Results
*Results from QA Agent review will be populated here*
