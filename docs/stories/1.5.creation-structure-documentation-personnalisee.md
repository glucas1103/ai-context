# Story 1.5: creation-structure-documentation-personnalisee

## Status
To Do

## Story
**As a** Gardien du Contexte (Tech Lead/CTO),
**I want** cr√©er une page d√©di√©e "Documentation" avec un √©diteur de documentation personnalis√©e,
**so that** je puisse structurer et r√©diger la documentation de ma codebase selon mes besoins m√©tier et organisationnels sp√©cifiques, avec un √©diteur riche et une interface intuitive.

## Acceptance Criteria
1. Une nouvelle page "Documentation" est accessible depuis la navigation du workspace
2. L'interface utilise un triple panneau : navigation interactive √† gauche, √©diteur riche au centre, placeholder chat √† droite
3. Le panneau gauche permet de cr√©er, supprimer, renommer et r√©organiser (drag & drop) des dossiers et fichiers (`.md`, `.doc`, etc.)
4. Le panneau central utilise TipTap pour l'√©dition de markdown avec support du rich text (H1, H2, gras, italique, listes, etc.)
5. La structure de documentation est persist√©e de mani√®re s√©curis√©e dans Supabase
6. Les op√©rations CRUD (Create, Read, Update, Delete) sont disponibles pour g√©rer la structure et le contenu
7. L'interface respecte l'identit√© visuelle d√©finie (th√®me sombre, triple panneau)
8. L'auto-sauvegarde fonctionne en temps r√©el pour √©viter la perte de donn√©es
9. Le panneau droit est pr√©par√© pour l'int√©gration future d'un chat

## Tasks / Subtasks
- [ ] Cr√©er la page "Documentation" dans la navigation (AC: 1, 7)
  - [ ] Ajouter le lien "Documentation" dans le layout du workspace
  - [ ] Cr√©er la page `/apps/web/app/(pages)/workspaces/[id]/documentation/page.tsx`
  - [ ] Impl√©menter le layout triple panneau avec th√®me sombre
  - [ ] Ajouter l'ic√¥ne et le style coh√©rent avec l'identit√© visuelle
- [ ] √âtendre le mod√®le de donn√©es pour la documentation personnalis√©e (AC: 5)
  - [ ] Cr√©er la table `custom_documentation` dans Supabase
  - [ ] D√©finir les relations avec `workspaces` et `knowledge_bases`
  - [ ] Impl√©menter Row Level Security (RLS) pour l'isolation des donn√©es
  - [ ] Cr√©er les index appropri√©s pour les performances
  - [ ] Ajouter les triggers pour `updated_at`
- [ ] Cr√©er l'API de gestion de la documentation (AC: 3, 6)
  - [ ] Cr√©er `POST /api/workspaces/[id]/documentation/folders` pour cr√©ation de dossiers
  - [ ] Cr√©er `POST /api/workspaces/[id]/documentation/files` pour cr√©ation de fichiers
  - [ ] Cr√©er `DELETE /api/workspaces/[id]/documentation/[itemId]` pour suppression
  - [ ] Cr√©er `PUT /api/workspaces/[id]/documentation/[itemId]` pour renommage/d√©placement
  - [ ] Cr√©er `PUT /api/workspaces/[id]/documentation/[itemId]/content` pour sauvegarde contenu
  - [ ] Impl√©menter la validation des noms et de la hi√©rarchie
- [ ] Impl√©menter le panneau de navigation interactif (AC: 3, 7)
  - [ ] Cr√©er un composant React Arborist modifi√© pour supporter les actions CRUD
  - [ ] Ajouter les boutons contextuels "Nouveau dossier" et "Nouveau fichier"
  - [ ] Impl√©menter les modales/formulaires de cr√©ation avec validation
  - [ ] Int√©grer le drag & drop pour r√©organiser la structure
  - [ ] Ajouter les actions de suppression et renommage
  - [ ] Appliquer le th√®me sombre coh√©rent
- [ ] Int√©grer TipTap dans le panneau central (AC: 4, 8)
  - [ ] Installer et configurer TipTap avec les extensions n√©cessaires
  - [ ] Cr√©er un composant d'√©dition avec support markdown et rich text
  - [ ] Impl√©menter l'auto-sauvegarde en temps r√©el
  - [ ] G√©rer l'affichage des fichiers vides et existants
  - [ ] Int√©grer avec l'API de sauvegarde de contenu
- [ ] Pr√©parer le panneau droit pour le chat (AC: 9)
  - [ ] Cr√©er un composant placeholder avec design coh√©rent
  - [ ] Ajouter un message d'information sur la fonctionnalit√© √† venir
  - [ ] Pr√©parer la structure pour l'int√©gration future
- [ ] G√©rer la persistance et la synchronisation (AC: 5, 6, 8)
  - [ ] Impl√©menter l'auto-sauvegarde lors des modifications de contenu
  - [ ] G√©rer les conflits et la validation c√¥t√© serveur
  - [ ] Impl√©menter le cache c√¥t√© client pour les performances
  - [ ] Ajouter la gestion d'erreurs avec rollback en cas d'√©chec
  - [ ] Optimiser les performances pour les gros fichiers
- [ ] Optimiser l'exp√©rience utilisateur (AC: 7, 8)
  - [ ] Ajouter des √©tats de chargement pour les op√©rations CRUD
  - [ ] Impl√©menter les raccourcis clavier pour les actions fr√©quentes
  - [ ] Cr√©er des tooltips et aide contextuelle
  - [ ] Ajouter des confirmations pour les actions destructives
  - [ ] Optimiser la r√©activit√© de l'interface

## Dev Notes

### Documentations Pertinentes

**TipTap (√âditeur Rich Text) :**
- **Documentation officielle :** https://tiptap.dev/
- **Installation React :** `npm install @tiptap/react @tiptap/pm @tiptap/starter-kit`
- **Extensions principales :**
  - `@tiptap/starter-kit` : Extensions de base (paragraphe, titre, gras, italique, etc.)
  - `@tiptap/extension-heading` : Titres H1-H6
  - `@tiptap/extension-bold` : Texte en gras
  - `@tiptap/extension-italic` : Texte en italique
  - `@tiptap/extension-list-item` : Listes √† puces et num√©rot√©es
  - `@tiptap/extension-blockquote` : Citations
  - `@tiptap/extension-code-block` : Blocs de code
  - `@tiptap/extension-link` : Liens
  - `@tiptap/extension-image` : Images
- **Configuration SSR :** Utiliser `immediatelyRender: false` pour Next.js
- **Auto-sauvegarde :** Utiliser `onUpdate` callback pour d√©tecter les changements

**React Arborist (Navigation Arborescente) :**
- **Documentation officielle :** https://github.com/brimdata/react-arborist
- **Installation :** `npm install react-arborist`
- **Fonctionnalit√©s cl√©s :**
  - Drag & drop natif pour r√©organiser la structure
  - √âdition inline des noms de fichiers/dossiers
  - S√©lection multiple avec Ctrl/Cmd + clic
  - Recherche et filtrage des n≈ìuds
  - Rendu virtuel pour les grandes structures
  - Support des raccourcis clavier
- **Callbacks principaux :**
  - `onCreate` : Cr√©ation de nouveaux √©l√©ments
  - `onRename` : Renommage d'√©l√©ments
  - `onMove` : D√©placement d'√©l√©ments
  - `onDelete` : Suppression d'√©l√©ments
  - `onSelect` : Gestion de la s√©lection
- **Personnalisation :**
  - `renderRow` : Personnalisation de l'affichage des lignes
  - `renderDragPreview` : Personnalisation de l'aper√ßu de drag
  - `renderCursor` : Personnalisation du curseur de drop

### Architecture Technique Pertinente
D'apr√®s les documents d'architecture, PRD et UX Spec, voici les √©l√©ments cl√©s pour cette story :

**Nouveau Mod√®le de Donn√©es :**
Bas√© sur le schema existant dans `architecture.md`, nous cr√©ons une nouvelle table d√©di√©e :

```sql
-- Nouvelle table pour la documentation personnalis√©e
CREATE TABLE custom_documentation (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID REFERENCES workspaces(id) ON DELETE CASCADE,
    parent_id UUID REFERENCES custom_documentation(id) ON DELETE CASCADE, -- NULL pour racine
    name TEXT NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('folder', 'file')), 
    path TEXT NOT NULL, -- chemin virtuel dans la structure (ex: "/architecture/database.md")
    content TEXT, -- contenu du fichier .md (NULL pour dossiers)
    metadata JSONB DEFAULT '{}', -- m√©tadonn√©es additionnelles
    order_index INTEGER DEFAULT 0, -- pour l'ordre d'affichage
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- Index pour les performances
CREATE INDEX idx_custom_doc_workspace ON custom_documentation(workspace_id);
CREATE INDEX idx_custom_doc_parent ON custom_documentation(parent_id);
CREATE UNIQUE INDEX idx_custom_doc_path ON custom_documentation(workspace_id, path);

-- Trigger pour updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_custom_documentation_updated_at 
    BEFORE UPDATE ON custom_documentation 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

**Structure des API Routes :**
```
/apps/web/app/api/workspaces/[id]/documentation/
‚îú‚îÄ‚îÄ folders/route.ts                 # POST pour cr√©er dossiers
‚îú‚îÄ‚îÄ files/route.ts                   # POST pour cr√©er fichiers  
‚îú‚îÄ‚îÄ [itemId]/route.ts               # PUT/DELETE pour modifier/supprimer
‚îú‚îÄ‚îÄ [itemId]/content/route.ts       # PUT pour sauvegarder contenu
‚îî‚îÄ‚îÄ tree/route.ts                   # GET pour r√©cup√©rer la structure compl√®te
```

**Interface TypeScript :**
```typescript
interface DocumentationNode {
  id: string;
  name: string;
  type: 'folder' | 'file';
  path: string; // chemin virtuel (ex: "/architecture/database.md")
  content?: string; // pour fichiers .md, .doc, etc.
  fileExtension?: string; // extension du fichier (.md, .doc, etc.)
  parent_id?: string;
  children?: DocumentationNode[];
  metadata?: {
    created_by: string;
    description?: string;
    tags?: string[];
    last_edited?: string;
    mimeType?: string; // pour diff√©rencier les types de fichiers
  };
  order_index: number;
  created_at: string;
  updated_at: string;
}

interface DocumentationState {
  currentFile: DocumentationNode | null;
  isEditing: boolean;
  hasUnsavedChanges: boolean;
  autoSaveEnabled: boolean;
}
```

**Integration TipTap (Panneau Central) :**
Configuration TipTap avec les extensions n√©cessaires :
```typescript
import { useEditor, EditorContent } from '@tiptap/react'
import StarterKit from '@tiptap/starter-kit'
import { Heading } from '@tiptap/extension-heading'
import { Bold, Italic, Underline } from '@tiptap/extension-bold'
import { ListItem, BulletList, OrderedList } from '@tiptap/extension-list-item'
import { Blockquote } from '@tiptap/extension-blockquote'
import { CodeBlock } from '@tiptap/extension-code-block'
import { Link } from '@tiptap/extension-link'
import { Image } from '@tiptap/extension-image'

// Configuration avec extensions pour rich text
const editorConfig = {
  extensions: [
    StarterKit,
    Heading.configure({
      levels: [1, 2, 3, 4, 5, 6]
    }),
    Bold,
    Italic,
    Underline,
    ListItem,
    BulletList,
    OrderedList,
    Blockquote,
    CodeBlock,
    Link,
    Image
  ],
  content: '<p>Contenu initial...</p>',
  editorProps: {
    attributes: {
      class: 'prose prose-sm sm:prose lg:prose-lg xl:prose-2xl mx-auto focus:outline-none'
    }
  }
}
```

**Integration React Arborist Modifi√© (Panneau Gauche) :**
Extension du composant pour supporter les actions CRUD :
- Actions contextuelles (clic droit) : Nouveau dossier, Nouveau fichier, Renommer, Supprimer
- Drag & drop pour r√©organiser la structure
- Boutons d'action visibles au survol
- Validation en temps r√©el des noms

```typescript
import { Tree } from 'react-arborist'

// Configuration React Arborist pour la navigation de documentation
const treeConfig = {
  data: documentationNodes,
  onCreate: ({ parentId, index, type }) => {
    // Logique de cr√©ation de dossier/fichier
  },
  onRename: ({ id, name }) => {
    // Logique de renommage
  },
  onMove: ({ dragIds, parentId, index }) => {
    // Logique de d√©placement
  },
  onDelete: ({ ids }) => {
    // Logique de suppression
  },
  renderRow: ({ node, style, dragHandle }) => (
    <div style={style} ref={dragHandle} className="flex items-center p-2 hover:bg-gray-700">
      <span className="mr-2">
        {node.isLeaf ? 'üìÑ' : 'üìÅ'}
      </span>
      <span>{node.data.name}</span>
      <div className="ml-auto opacity-0 group-hover:opacity-100">
        {/* Boutons d'action */}
      </div>
    </div>
  )
}
```

**Navigation et Routing :**
- Nouvelle route : `/workspaces/[id]/documentation`
- Ajout dans le layout du workspace avec ic√¥ne appropri√©e
- Gestion de l'√©tat de navigation active

**Messages UX Cl√©s (d'apr√®s UX Spec) :**
- **Documentation d√©di√©e** : "Cr√©ez et organisez votre documentation m√©tier"
- **√âdition riche** : "R√©digez avec un √©diteur moderne et intuitif"
- **Structure flexible** : "Organisez selon votre logique, pas celle du code"

**Identit√© Visuelle (UX Spec) :**
- **Palette de Couleurs (Th√®me Sombre) :**
  - Fond : `#111827` (Gris fonc√©)
  - Panneaux : `#1F2937` (Gris moyen)  
  - Accent : `#3B82F6` (Bleu vif)
  - Texte : `#D1D5DB` / `#FFFFFF`
- **Iconographie :** Heroicons (document-text, folder, plus, trash, edit, chat-bubble)
- **Interactions :** Boutons contextuels, modales soign√©es, transitions fluides

**Validation et Contraintes :**
- Noms de fichiers/dossiers : validation regex (caract√®res autoris√©s, longueur 1-255)
- Profondeur maximale de hi√©rarchie : 10 niveaux
- Taille maximale des fichiers `.md` : 2MB
- Gestion des noms en conflit avec auto-incr√©mentation
- Auto-sauvegarde toutes les 3 secondes apr√®s arr√™t de frappe

**Performance et Optimisation :**
- Debouncing pour l'auto-sauvegarde (300ms)
- Lazy loading des contenus de fichiers
- Cache c√¥t√© client pour la structure
- Optimisation des requ√™tes Supabase avec pagination si n√©cessaire

**Integration avec l'Architecture Existante :**
- R√©utilisation des clients Supabase configur√©s (`lib/supabase/client.ts`, `lib/supabase/server.ts`)
- Extension du pattern de navigation du workspace
- Utilisation des patterns d'authentification et s√©curit√© de la Story 1.2
- Coh√©rence avec l'API workspace de la Story 1.3

### Testing
**Standards de Test (d'apr√®s l'architecture) :**
- **Tests Unitaires :** Jest pour les utilitaires CRUD et validation
- **Tests d'Int√©gration :** Jest/React Testing Library pour les API et composants
- **Tests E2E :** Playwright pour le parcours complet de cr√©ation et √©dition
- **Tests de Performance :** Validation des op√©rations sur structures complexes

**Frameworks :**
- Jest (Latest) - d√©j√† configur√©
- React Testing Library - d√©j√† configur√©  
- Playwright (Latest) - d√©j√† configur√©

**Tests Sp√©cifiques √† cette Story :**
- Tests unitaires pour la validation des noms et hi√©rarchie
- Tests d'int√©gration pour les API CRUD avec Supabase
- Tests de persistence et auto-sauvegarde
- Tests E2E du flux complet (cr√©ation ‚Üí √©dition ‚Üí sauvegarde)
- Tests des interactions drag & drop et raccourcis clavier
- Tests de performance TipTap avec gros contenus
- Tests de l'interface responsive et accessible

**Mock Strategy :**
- Mock des r√©ponses Supabase pour tests isol√©s
- Mock des composants TipTap pour tests de logique pure
- Test datasets avec diff√©rentes structures et contenus
- Mock du localStorage pour tests de persistence

## Change Log
| Date       | Version | Description              | Auteur |
|------------|---------|--------------------------|--------|
| 12/01/2025 | 1.0     | Cr√©ation initiale story  | Sarah  |
| 12/01/2025 | 2.0     | Refactorisation page s√©par√©e avec MDXEditor | Sarah  |
| 12/01/2025 | 3.0     | R√©initialisation - remise √† z√©ro pour nouvelle impl√©mentation | Sarah |

## Dev Agent Record

### Agent Model Used
- **Agent:** √Ä d√©finir (Full Stack Developer)
- **Model:** BMAD Core Dev Agent
- **Focus:** Implementation and testing of documentation system

### Debug Log References
*√Ä venir lors de l'impl√©mentation*

### Completion Notes List
*√Ä compl√©ter lors de l'impl√©mentation*

### File List
**Fichiers √† cr√©er :**
- `apps/web/src/lib/types/documentation.ts` - Types TypeScript
- `apps/web/src/app/api/workspaces/[id]/documentation/tree/route.ts` - API arborescence
- `apps/web/src/app/api/workspaces/[id]/documentation/folders/route.ts` - API cr√©ation dossiers
- `apps/web/src/app/api/workspaces/[id]/documentation/files/route.ts` - API cr√©ation fichiers
- `apps/web/src/app/api/workspaces/[id]/documentation/[itemId]/route.ts` - API CRUD √©l√©ments
- `apps/web/src/app/api/workspaces/[id]/documentation/[itemId]/content/route.ts` - API contenu
- `apps/web/src/components/documentation/MarkdownEditor.tsx` - √âditeur TipTap
- `apps/web/src/components/documentation/DocumentationTree.tsx` - Navigation arborescente
- `apps/web/src/components/documentation/ChatPanel.tsx` - Panneau chat placeholder
- `apps/web/src/app/(pages)/workspaces/[id]/documentation/page.tsx` - Page principale

**Fichiers √† modifier :**
- `apps/web/package.json` - Ajouter d√©pendances TipTap et React Arborist
- Layout du workspace - Ajouter navigation vers Documentation

## QA Results
*Results from QA Agent review will be populated here*
