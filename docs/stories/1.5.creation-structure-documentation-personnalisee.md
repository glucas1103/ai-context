# Story 1.5: creation-structure-documentation-personnalisee

## Status
Draft

## Story
**As a** Gardien du Contexte (Tech Lead/CTO),
**I want** créer ma propre arborescence de dossiers et fichiers `.md` vides dans une vue "personnalisée",
**so that** je puisse structurer la documentation de ma codebase selon mes besoins métier et organisationnels spécifiques, indépendamment de la structure du code source.

## Acceptance Criteria
1. L'interface fournit des boutons pour créer de nouveaux dossiers et fichiers `.md` dans une vue "personnalisée"
2. L'utilisateur peut basculer entre la vue "par défaut" (structure miroir du code) et la vue "personnalisée" (structure libre)
3. La création de dossiers permet de définir une hiérarchie personnalisée avec validation des noms
4. La création de fichiers `.md` génère des fichiers vides avec métadonnées appropriées
5. L'arborescence personnalisée est persistée de manière sécurisée dans Supabase
6. Les opérations CRUD (Create, Read, Update, Delete) sont disponibles pour gérer la structure personnalisée
7. L'interface respecte l'identité visuelle définie (thème sombre, triple panneau)
8. La navigation entre les deux vues est fluide et intuitive avec des indicateurs visuels clairs

## Tasks / Subtasks
- [ ] Étendre le modèle de données pour supporter la structure personnalisée (AC: 5)
  - [ ] Créer la table `custom_knowledge_structure` dans Supabase
  - [ ] Définir les relations avec `knowledge_bases` et `workspaces`
  - [ ] Implémenter Row Level Security (RLS) pour l'isolation des données
  - [ ] Créer les index appropriés pour les performances
- [ ] Créer l'API de gestion de la structure personnalisée (AC: 1, 4, 6)
  - [ ] Créer `POST /api/workspaces/[id]/custom-structure/folders` pour création de dossiers
  - [ ] Créer `POST /api/workspaces/[id]/custom-structure/files` pour création de fichiers
  - [ ] Créer `DELETE /api/workspaces/[id]/custom-structure/[itemId]` pour suppression
  - [ ] Créer `PUT /api/workspaces/[id]/custom-structure/[itemId]` pour renommage/déplacement
  - [ ] Implémenter la validation des noms et de la hiérarchie
- [ ] Implémenter le sélecteur de vue dans l'interface (AC: 2, 8)
  - [ ] Ajouter un toggle/switch "Vue par défaut" vs "Vue personnalisée"
  - [ ] Implémenter la persistance de la préférence utilisateur
  - [ ] Ajouter des indicateurs visuels pour distinguer les deux modes
  - [ ] Gérer les transitions fluides entre les vues
- [ ] Créer l'interface de création dans le panneau de navigation (AC: 1, 3, 7)
  - [ ] Ajouter des boutons contextuels "Nouveau dossier" et "Nouveau fichier"
  - [ ] Implémenter les modales/formulaires de création avec validation
  - [ ] Intégrer les actions CRUD dans l'arborescence React Arborist
  - [ ] Appliquer le thème sombre cohérent aux nouveaux composants
- [ ] Gérer la persistance et la synchronisation (AC: 5, 6)
  - [ ] Implémenter l'auto-sauvegarde lors des modifications
  - [ ] Gérer les conflits et la validation côté serveur
  - [ ] Implémenter le cache côté client pour les performances
  - [ ] Ajouter la gestion d'erreurs avec rollback en cas d'échec
- [ ] Optimiser l'expérience utilisateur (AC: 7, 8)
  - [ ] Ajouter des états de chargement pour les opérations CRUD
  - [ ] Implémenter drag & drop pour réorganiser la structure
  - [ ] Ajouter des raccourcis clavier pour les actions fréquentes
  - [ ] Créer des tooltips et aide contextuelle

## Dev Notes

### Architecture Technique Pertinente
D'après les documents d'architecture, PRD et UX Spec, voici les éléments clés pour cette story :

**Extension du Modèle de Données :**
Basé sur le schema existant dans `architecture.md`, nous devons étendre la base de données :

```sql
-- Nouvelle table pour la structure personnalisée
CREATE TABLE custom_knowledge_structure (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    knowledge_base_id UUID REFERENCES knowledge_bases(id) ON DELETE CASCADE,
    parent_id UUID REFERENCES custom_knowledge_structure(id) ON DELETE CASCADE, -- NULL pour racine
    name TEXT NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('folder', 'file')), 
    path TEXT NOT NULL, -- chemin virtuel dans la structure personnalisée
    content TEXT, -- contenu du fichier .md (NULL pour dossiers)
    metadata JSONB, -- métadonnées additionnelles
    order_index INTEGER DEFAULT 0, -- pour l'ordre d'affichage
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- Index pour les performances
CREATE INDEX idx_custom_structure_knowledge_base ON custom_knowledge_structure(knowledge_base_id);
CREATE INDEX idx_custom_structure_parent ON custom_knowledge_structure(parent_id);
CREATE UNIQUE INDEX idx_custom_structure_path ON custom_knowledge_structure(knowledge_base_id, path);
```

**Integration avec l'Architecture Existante :**
- Réutilisation des clients Supabase configurés (`lib/supabase/client.ts`, `lib/supabase/server.ts`)
- Extension du triple panneau existant (React Arborist + Monaco Editor)
- Utilisation des patterns d'authentification et sécurité de la Story 1.2
- Extension de l'API workspace de la Story 1.3

**Structure des API Routes :**
```
/apps/web/app/api/workspaces/[id]/custom-structure/
├── folders/route.ts                 # POST pour créer dossiers
├── files/route.ts                   # POST pour créer fichiers  
├── [itemId]/route.ts               # PUT/DELETE pour modifier/supprimer
└── tree/route.ts                   # GET pour récupérer la structure complète
```

**Interface TypeScript :**
```typescript
interface CustomStructureNode {
  id: string;
  name: string;
  type: 'folder' | 'file';
  path: string; // chemin virtuel (ex: "/architecture/database.md")
  content?: string; // pour fichiers .md uniquement
  parent_id?: string;
  children?: CustomStructureNode[];
  metadata?: {
    created_by: string;
    description?: string;
    tags?: string[];
  };
}

interface ViewMode {
  current: 'default' | 'custom';
  preference: 'default' | 'custom'; // préférence sauvegardée
}
```

**Integration React Arborist (Panneau Gauche) :**
Extension du composant existant pour supporter deux modes de données :
- Mode "défaut" : données de `FileTreeNode` (Story 1.3)  
- Mode "personnalisé" : données de `CustomStructureNode`

Le composant doit gérer les actions contextuelles (clic droit, boutons) pour les opérations CRUD.

**Integration Monaco Editor (Panneau Central) :**
Le panneau central doit :
- Afficher le contenu des fichiers `.md` personnalisés
- Permettre l'édition en temps réel avec sauvegarde automatique
- Gérer les nouveaux fichiers vides créés

**Préférences Utilisateur :**
Stockage de la préférence de vue dans :
- LocalStorage côté client pour persistence
- Potentiellement dans Supabase `user_metadata` pour sync multi-device

**Messages UX Clés (d'après UX Spec) :**
- **Flexibilité documentaire** : "Organisez votre documentation selon votre logique métier"
- **Indépendance structure** : "Créez une structure qui reflète vos besoins, pas votre code"
- **Collaboration équipe** : "Structurez la connaissance pour votre équipe"

**Identité Visuelle (UX Spec) :**
- **Palette de Couleurs (Thème Sombre) :**
  - Fond : `#111827` (Gris foncé)
  - Panneaux : `#1F2937` (Gris moyen)  
  - Accent : `#3B82F6` (Bleu vif)
  - Texte : `#D1D5DB` / `#FFFFFF`
- **Iconographie :** Heroicons (folder, document-text, plus, trash, edit)
- **Interactions :** Boutons contextuels, modales soignées, transitions fluides

**Validation et Contraintes :**
- Noms de fichiers/dossiers : validation regex (caractères autorisés, longueur)
- Profondeur maximale de hiérarchie : 10 niveaux
- Taille maximale des fichiers `.md` : 1MB
- Gestion des noms en conflit avec auto-incrémentation

**Integration Story 1.3 :**
Cette story étend directement le contexte viewer créé dans Story 1.3 :
- Même page `/apps/web/app/(pages)/workspaces/[id]/context/page.tsx`
- Extension du système de navigation existant
- Réutilisation des composants React Arborist et Monaco Editor

### Testing
**Standards de Test (d'après l'architecture) :**
- **Tests Unitaires :** Jest pour les utilitaires CRUD et validation
- **Tests d'Intégration :** Jest/React Testing Library pour les API et composants
- **Tests E2E :** Playwright pour le parcours complet de création de structure
- **Tests de Performance :** Validation des opérations sur structures complexes

**Frameworks :**
- Jest (Latest) - déjà configuré
- React Testing Library - déjà configuré  
- Playwright (Latest) - déjà configuré

**Tests Spécifiques à cette Story :**
- Tests unitaires pour la validation des noms et hiérarchie
- Tests d'intégration pour les API CRUD avec Supabase
- Tests de persistence et synchronisation des données
- Tests E2E du flux complet (switch de vue → création → édition)
- Tests des interactions drag & drop et raccourcis clavier

**Mock Strategy :**
- Mock des réponses Supabase pour tests isolés
- Mock des composants React Arborist pour tests de logique pure
- Test datasets avec différentes structures de complexité variable

## Change Log
| Date       | Version | Description              | Auteur |
|------------|---------|--------------------------|--------|
| 12/01/2025 | 1.0     | Création initiale story  | Sarah  |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*
