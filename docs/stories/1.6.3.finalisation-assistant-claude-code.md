# Story 1.6.3: Finalisation Assistant Claude Code - Corrections de Bugs

## Status
üöß **EN COURS** - Fondations solides en place, bugs critiques √† corriger

## Story
**As a** D√©veloppeur utilisant l'assistant Claude Code,
**I want** un assistant fonctionnel et stable qui peut investiguer ma codebase sans bugs d'interface ou de session,
**so that** je puisse poser des questions sur mon code et obtenir des r√©ponses fiables dans une interface utilisateur coh√©rente.

## Context et Accomplissements

### ‚úÖ **Fondations Solides Construites (Stories 1.6.1 & 1.6.2)**

#### **1. Interface Utilisateur Compl√®te (Story 1.6.1)**
- **UniversalChatPanel** : Composant de chat avec onglets et streaming ‚úÖ
- **Interface Cursor-style** : Bulles utilisateur, flux libre assistant ‚úÖ
- **Gestion des onglets** : Sessions multiples avec persistance ‚úÖ
- **Components r√©utilisables** : MessageList, MessageInput, ChatHeader ‚úÖ
- **Types TypeScript complets** : ChatMessage, ChatSession, ClaudeCodeContext ‚úÖ
- **Services de persistance** : Supabase avec chat_sessions et chat_messages ‚úÖ

#### **2. Int√©gration Claude Code SDK (Story 1.6.2)**
- **Claude Code SDK int√©gr√©** : Version simplifi√©e et fonctionnelle ‚úÖ
- **Service ultra-simple** : `simple-claude-code-service.ts` (78 lignes) ‚úÖ
- **Hook optimis√©** : `useSimpleClaudeCode.ts` (90 lignes) ‚úÖ
- **API route configur√©e** : `/api/workspaces/[id]/chat/claude-code/route.ts` ‚úÖ
- **Outils Claude Code activ√©s** : Read, Grep, Glob, LS ‚úÖ
- **Architecture native** : Utilise directement `claude().query().asText()` ‚úÖ

#### **3. Configuration Technique Valid√©e**
- **Base de donn√©es √©tendue** : Tables Supabase avec support Claude Code ‚úÖ
- **API Key configuration** : Lecture s√©curis√©e depuis environment ‚úÖ
- **Workspace detection** : R√©cup√©ration dynamique des donn√©es workspace ‚úÖ
- **CLI installation** : Claude Code CLI install√© et accessible ‚úÖ
- **Tests** : Suite de tests validant l'int√©gration ‚úÖ

## Acceptance Criteria

### **AC1 : Correction Bug Session Management** üî¥ **CRITIQUE**
- **R√àGLE STRICTE** : 1 onglet = 1 session - Seule la cr√©ation d'onglet peut cr√©er une session
- **SUPPRIMER** toute logique de cr√©ation automatique de session dans l'API Claude Code
- L'utilisateur √©crit TOUJOURS dans une session existante (celle de l'onglet actif)
- L'API doit uniquement r√©cup√©rer la session ID de l'onglet actif, jamais en cr√©er
- Validation que `activeTab?.sessionId` est correctement transmise √† l'API

### **AC2 : Affichage Flux de R√©flexion Claude Code** üî¥ **CRITIQUE**
- **M√©tadonn√©es en temps r√©el** : Afficher quand Claude Code utilise un outil (Read, Grep, etc.)
- **Flux de r√©flexion visible** : Montrer les √©tapes de raisonnement pendant l'investigation
- **Indicateurs d'actions** : "Claude Code lit le fichier X...", "Recherche patterns...", etc.
- **Progression streaming** : Affichage progressif du processus de r√©flexion

### **AC3 : Correction Affichage Messages Utilisateur** üî¥ **HAUTE**
- Les questions de l'utilisateur doivent s'afficher en bulles bleues
- Les r√©ponses de Claude Code doivent s'afficher en flux libre (sans bulle)
- Interface coh√©rente avec le design Cursor-style de la Story 1.6.1
- Timestamps et indicateurs de statut fonctionnels

### **AC4 : Contexte Workspace Correct** üî¥ **CRITIQUE**
- **Contexte bas√© sur workspace ID** : Claude Code doit analyser le repo du workspace s√©lectionn√©
- **PAS le repo local** : Ne pas utiliser le contexte du repo en cours de d√©veloppement
- **Workspace-specific** : Investigation_context doit √™tre fonction de l'ID du workspace
- **Configuration dynamique** : Path et contexte d√©termin√©s par le workspace √† analyser

### **AC5 : Stabilisation Flow Conversationnel** üü° **MOYENNE**
- Flow Question ‚Üí Transmission ‚Üí Claude Code ‚Üí R√©ponse ‚Üí Affichage fonctionnel
- Gestion d'erreurs gracieuse avec messages informatifs
- Indicateurs de chargement pendant le traitement Claude Code
- Validation que chaque onglet maintient sa propre conversation

### **AC6 : Tests et Validation Compl√®te** üü¢ **BASSE**
- Tests E2E pour les sc√©narios de cr√©ation onglet ‚Üí question ‚Üí r√©ponse
- Tests de r√©gression pour s'assurer que les corrections n'impactent pas l'existant
- Validation de l'isolation entre onglets multiples
- Documentation des flows utilisateur valid√©s

## Tasks / Subtasks - R√âVISION COMPL√àTE AVEC SDK OFFICIEL

### **Phase 0: Nettoyage et Migration SDK Officiel** üî¥ **CRITIQUE**
- [ ] **D√âSINSTALLER SDK non-officiel** : `npm uninstall @instantlyeasy/claude-code-sdk-ts`
- [ ] **INSTALLER SDK officiel** : `npm install -g @anthropic-ai/claude-code`
- [ ] **SUPPRIMER fichiers non-officiels** :
  - [ ] `simple-claude-code-service.ts` (340 lignes ‚Üí SUPPRIMER)
  - [ ] `useSimpleClaudeCode.ts` (90 lignes ‚Üí SUPPRIMER)
  - [ ] Toute logique personnalis√©e d'orchestration
- [ ] **NETTOYER dependencies** : Enlever toutes r√©f√©rences au SDK non-officiel

### **Phase 1: Impl√©mentation SDK Officiel** üî¥ **CRITIQUE**
- [ ] **Cr√©er service officiel** : `official-claude-code-service.ts` (50 lignes max)
  ```typescript
  import { ClaudeCode } from '@anthropic-ai/claude-code';
  // Configuration officielle selon documentation
  ```
- [ ] **Cr√©er hook officiel** : `useOfficialClaudeCode.ts` (30 lignes max)
- [ ] **R√©√©crire API route** : Utiliser SDK officiel en mode headless
- [ ] **Configuration workspace** : Bas√© sur workspace ID, pas repo local

### **Phase 2: Int√©gration Mode Headless** üî¥ **CRITIQUE**
Selon [la documentation headless](https://docs.anthropic.com/en/docs/claude-code/headless-mode) :
- [ ] **Configuration headless** : `claude --headless --workspace /path/to/workspace`
- [ ] **Streaming natif** : Utiliser le streaming int√©gr√© du SDK officiel
- [ ] **M√©tadonn√©es automatiques** : SDK officiel expose actions/outils automatiquement
- [ ] **Pas de surcouche** : Laisser le SDK g√©rer investigation et raisonnement

### **Phase 3: Common Workflows Integration** üü° **MOYENNE**
Selon [la documentation workflows](https://docs.anthropic.com/en/docs/claude-code/common-workflows) :
- [ ] **Build features from descriptions** : Int√©grer workflow officiel
- [ ] **Debug and fix issues** : Utiliser capacit√©s natives de debug
- [ ] **Navigate codebase** : Exploiter awareness native du projet
- [ ] **Automate tasks** : Configurer t√¢ches automatis√©es

### **Phase 4: Interface Utilisateur avec M√©tadonn√©es Natives** üü° **MOYENNE**
- [ ] **Flux de r√©flexion natif** : Afficher m√©tadonn√©es du SDK officiel
- [ ] **Indicateurs d'actions** : Utiliser les hooks natifs du SDK
- [ ] **Streaming progressif** : Int√©grer le streaming natif
- [ ] **Corrections interface** : Bulles utilisateur et affichage r√©ponses

### **Phase 5: Tests avec SDK Officiel** üü¢ **BASSE**
- [ ] **Tests int√©gration** : Valider SDK officiel fonctionne
- [ ] **Tests E2E** : Sc√©narios complets avec vrai Claude Code
- [ ] **Performance** : Mesurer am√©lioration avec SDK officiel
- [ ] **Documentation** : Guide d'utilisation SDK officiel

### **üéØ OBJECTIF : WRAPPING MINIMAL DU SDK OFFICIEL**

**Ce que nous cr√©ons :**
- ‚úÖ **Interface web** pour Claude Code (UniversalChatPanel r√©utilis√©)
- ‚úÖ **Persistance sessions** (tables Supabase existantes)
- ‚úÖ **Wrapper minimal** du SDK officiel (‚â§100 lignes total)

**Ce que nous NE cr√©ons PAS :**
- ‚ùå Logique d'investigation personnalis√©e (SDK officiel g√®re)
- ‚ùå Prompts personnalis√©s (SDK officiel g√®re)
- ‚ùå Gestion d'outils personnalis√©e (SDK officiel g√®re)
- ‚ùå Raisonnement multi-√©tapes personnalis√© (SDK officiel g√®re)
- ‚ùå M√©tadonn√©es personnalis√©es (SDK officiel expose)

## Technical Context - Documentation Officielle Claude Code

### **üéØ IMPL√âMENTATION OFFICIELLE CLAUDE CODE**

Bas√© sur [la documentation officielle Claude Code](https://docs.anthropic.com/en/docs/claude-code/overview), voici l'architecture recommand√©e :

#### **Installation et Configuration Standard**
```bash
# Installation Claude Code officielle
npm install -g @anthropic-ai/claude-code

# Utilisation en mode headless (pour int√©gration application)
claude --headless --workspace /path/to/workspace
```

#### **SDK TypeScript Officiel**
Selon [la documentation SDK TypeScript](https://docs.anthropic.com/en/docs/claude-code/typescript), l'int√©gration recommand√©e est :

```typescript
import { ClaudeCode } from '@anthropic-ai/claude-code';

// Configuration officielle
const claude = new ClaudeCode({
  apiKey: process.env.ANTHROPIC_API_KEY,
  workspacePath: workspacePath,
  mode: 'headless'
});

// Utilisation directe - pas de surcouche
const response = await claude.query(message);
```

#### **Mode Headless pour Applications Web**
Pour int√©grer Claude Code dans une application web, [la documentation headless](https://docs.anthropic.com/en/docs/claude-code/headless-mode) recommande :

- **Pas d'interface terminal** : Mode headless pour int√©gration silencieuse
- **API directe** : Communication via API sans interface CLI
- **Streaming natif** : Flux de r√©ponses int√©gr√©
- **M√©tadonn√©es compl√®tes** : Actions et outils utilis√©s expos√©s automatiquement

### **üö® R√âVISION COMPL√àTE N√âCESSAIRE**

#### **PROBL√àME IDENTIFI√â : Impl√©mentation Non-Officielle**
Notre impl√©mentation actuelle utilise un SDK non-officiel `@instantlyeasy/claude-code-sdk-ts` au lieu du SDK officiel `@anthropic-ai/claude-code`.

#### **MIGRATION REQUISE : SDK Officiel**
- **SUPPRIMER** : `@instantlyeasy/claude-code-sdk-ts` (non-officiel)
- **INSTALLER** : `@anthropic-ai/claude-code` (officiel)
- **R√â√âCRIRE** : Service pour utiliser l'API officielle
- **SIMPLIFIER** : Utiliser directement les fonctionnalit√©s natives

### **Architecture Cible (Officielle)**
```
src/lib/services/
‚îú‚îÄ‚îÄ chatService.ts                    # ‚úÖ GARDER (Story 1.6.1)
‚îî‚îÄ‚îÄ official-claude-code-service.ts   # üÜï CR√âER avec SDK officiel

src/hooks/
‚îú‚îÄ‚îÄ useChatSession.ts                 # ‚úÖ GARDER (Story 1.6.1)
‚îú‚îÄ‚îÄ useChatMessages.ts                # ‚úÖ GARDER (Story 1.6.1)
‚îú‚îÄ‚îÄ useChatTabs.ts                    # ‚úÖ GARDER (Story 1.6.1)
‚îî‚îÄ‚îÄ useOfficialClaudeCode.ts          # üÜï CR√âER avec SDK officiel

src/components/universal/
‚îî‚îÄ‚îÄ UniversalChatPanel.tsx            # ‚úÖ ENRICHIR (Story 1.6.1)

api/workspaces/[id]/chat/
‚îî‚îÄ‚îÄ claude-code/route.ts              # üîÑ R√â√âCRIRE avec SDK officiel
```

### **MIGRATION PLAN - SDK Officiel**

#### **Phase 0 : Nettoyage Total (CRITIQUE)**
- [ ] **SUPPRIMER** `@instantlyeasy/claude-code-sdk-ts` du package.json
- [ ] **SUPPRIMER** `simple-claude-code-service.ts` (utilise SDK non-officiel)
- [ ] **SUPPRIMER** `useSimpleClaudeCode.ts` (utilise SDK non-officiel)
- [ ] **SUPPRIMER** toute logique personnalis√©e de gestion d'outils
- [ ] **INSTALLER** `@anthropic-ai/claude-code` (SDK officiel)

#### **Phase 1 : Service Officiel Claude Code**
```typescript
// üÜï official-claude-code-service.ts - Bas√© sur documentation officielle
import { ClaudeCode } from '@anthropic-ai/claude-code';

export class OfficialClaudeCodeService {
  private claude: ClaudeCode;

  constructor(workspacePath: string) {
    this.claude = new ClaudeCode({
      apiKey: process.env.ANTHROPIC_API_KEY,
      workspacePath,
      mode: 'headless'
    });
  }

  // Une seule m√©thode - SDK officiel g√®re tout
  async query(message: string): Promise<string> {
    return await this.claude.query(message);
  }

  // Streaming natif - SDK officiel g√®re tout
  async *streamQuery(message: string): AsyncGenerator<string> {
    yield* this.claude.streamQuery(message);
  }
}
```

#### **Phase 2 : Hook Officiel**
```typescript
// üÜï useOfficialClaudeCode.ts - Wrapper minimal
export const useOfficialClaudeCode = (workspacePath: string) => {
  const [service] = useState(() => new OfficialClaudeCodeService(workspacePath));
  
  return {
    query: service.query.bind(service),
    streamQuery: service.streamQuery.bind(service)
  };
};
```

#### **Phase 3 : API Route Officielle**
```typescript
// üîÑ API route r√©√©crite avec SDK officiel
import { OfficialClaudeCodeService } from '@/lib/services/official-claude-code-service';

export async function POST(request: Request) {
  const service = new OfficialClaudeCodeService(workspacePath);
  
  // SDK officiel g√®re streaming, m√©tadonn√©es, outils automatiquement
  const response = service.streamQuery(message);
  
  return new Response(response);
}
```

### **Base de Donn√©es (Pr√™te)**
```sql
-- Tables existantes √©tendues avec support Claude Code
-- chat_sessions : title, tab_order, is_active, claude_session_id, investigation_context
-- chat_messages : claude_actions, investigation_steps, reasoning_steps
```

### **Configuration (Valid√©e)**
- **Claude Code CLI** : Install√© dans `/Users/lucasgaillard/.npm-global/bin/claude`
- **API Key** : Configur√©e dans `ANTHROPIC_API_KEY` environment variable
- **Workspace Detection** : R√©cup√©ration automatique depuis Supabase
- **Outils** : Read, Grep, Glob, LS activ√©s et fonctionnels

## Diagnostic Complet - Impl√©mentation Non-Officielle

### **üö® PROBL√àME MAJEUR : SDK NON-OFFICIEL UTILIS√â**

#### **Constat Critique**
Notre impl√©mentation utilise `@instantlyeasy/claude-code-sdk-ts` qui est un SDK **non-officiel**. Selon [la documentation officielle Claude Code](https://docs.anthropic.com/en/docs/claude-code/overview), le SDK officiel est `@anthropic-ai/claude-code`.

#### **Implications**
- **Fonctionnalit√©s manquantes** : SDK non-officiel n'a pas toutes les capacit√©s natives
- **Maintenance risqu√©e** : Pas de support officiel Anthropic
- **M√©tadonn√©es incompl√®tes** : Flux de r√©flexion et actions non expos√©s correctement
- **Performance sous-optimale** : Pas d'optimisations officielles

### **üî¥ Bugs R√©sultant de l'Impl√©mentation Non-Officielle**

#### **1. Flux de R√©flexion Invisible**
- **Cause R√©elle** : SDK non-officiel n'expose pas les m√©tadonn√©es natives
- **Solution** : Migration vers SDK officiel avec m√©tadonn√©es automatiques

#### **2. Session Management Complexe**
- **Cause R√©elle** : Surcouche personnalis√©e au lieu d'utiliser session native
- **Solution** : Utiliser gestion de session native du SDK officiel

#### **3. Contexte Workspace Incorrect**
- **Cause R√©elle** : Configuration manuelle au lieu de workspace natif
- **Solution** : Utiliser `--workspace` natif du SDK officiel

#### **4. Streaming D√©faillant**
- **Cause R√©elle** : Streaming simul√© au lieu du streaming natif
- **Solution** : Utiliser `claude.streamQuery()` natif

### **‚úÖ Solution Unique : Migration SDK Officiel**

Tous les bugs identifi√©s sont r√©solus par la migration vers le SDK officiel car :
- **Streaming natif** : `claude.streamQuery()` g√®re tout automatiquement
- **M√©tadonn√©es natives** : Actions et outils expos√©s automatiquement
- **Session native** : Gestion de session int√©gr√©e
- **Workspace natif** : Configuration workspace simplifi√©e
- **Mode headless** : Int√©gration application web optimis√©e

## Dependencies et Pr√©requis - MIGRATION SDK OFFICIEL

### **üîÑ Changement de Pr√©requis**
- ‚úÖ **Story 1.6.1** : Termin√©e - Composant UniversalChatPanel op√©rationnel (GARDER)
- üîÑ **Story 1.6.2** : Refonte requise - Migration vers SDK officiel
- ‚ùå **SDK non-officiel** : `@instantlyeasy/claude-code-sdk-ts` √† SUPPRIMER
- ‚úÖ **SDK officiel** : `@anthropic-ai/claude-code` √† INSTALLER

### **üö® Nouveau Pr√©requis Critique**
Selon [la documentation officielle](https://docs.anthropic.com/en/docs/claude-code/overview) :

```bash
# Installation officielle requise
npm install -g @anthropic-ai/claude-code

# Configuration headless pour applications web
export ANTHROPIC_API_KEY=your_api_key
claude --headless --workspace /path/to/workspace
```

### **üìã Infrastructure √† Migrer**
- ‚úÖ **Base de donn√©es Supabase** : Tables existantes GARD√âES
- ‚úÖ **API Keys** : ANTHROPIC_API_KEY d√©j√† configur√©e
- üîÑ **CLI Installation** : Migration vers CLI officiel
- üîÑ **Services** : R√©√©criture avec SDK officiel
- üîÑ **Hooks** : Refonte avec SDK officiel

## Success Criteria - SDK Officiel

### **Crit√®res de Succ√®s Technique avec SDK Officiel**
- [ ] **SDK officiel int√©gr√©** : `@anthropic-ai/claude-code` fonctionne en mode headless
- [ ] **Streaming natif** : R√©ponses progressives avec m√©tadonn√©es automatiques
- [ ] **Workspace correct** : Claude Code analyse le workspace s√©lectionn√©, pas repo local
- [ ] **Sessions isol√©es** : Chaque onglet = session unique + workspace sp√©cifique
- [ ] **Performance optimale** : Temps de r√©ponse ‚â§ 5 secondes (am√©lioration vs SDK non-officiel)

### **Crit√®res de Succ√®s Utilisateur**
- [ ] **Flux de r√©flexion visible** : Utilisateur voit les actions Claude Code en temps r√©el
- [ ] **Investigation transparente** : "Claude Code lit le fichier X", "Recherche patterns Y"
- [ ] **R√©ponses contextuelles** : Analyses pertinentes du workspace s√©lectionn√©
- [ ] **Interface coh√©rente** : Bulles utilisateur + flux libre assistant
- [ ] **Exp√©rience fluide** : Pas d'erreurs de session ou de configuration

### **Crit√®res de Conformit√© Documentation Officielle**
- [ ] **Installation conforme** : Utilise `npm install -g @anthropic-ai/claude-code`
- [ ] **Mode headless** : Configuration `claude --headless --workspace`
- [ ] **Workflows natifs** : Exploitation des [common workflows](https://docs.anthropic.com/en/docs/claude-code/common-workflows)
- [ ] **Pas de surcouche** : Wrapper minimal ‚â§100 lignes total
- [ ] **Fonctionnalit√©s natives** : Toutes capacit√©s Claude Code disponibles

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Cr√©ation Story 1.6.3 - Finalisation Assistant Claude Code | Sarah (PO) |
| 2025-01-27 | 2.0 | **R√âVISION MAJEURE** - Migration vers SDK officiel `@anthropic-ai/claude-code` | Sarah (PO) |

## Notes - R√âVISION MAJEURE

### **üö® Changement d'Approche Fondamental**
Suite √† l'analyse de [la documentation officielle Claude Code](https://docs.anthropic.com/en/docs/claude-code/overview), cette story **CHANGE COMPL√àTEMENT D'OBJECTIF** :

**Avant (v1.0)** : Corriger bugs d'une impl√©mentation avec SDK non-officiel  
**Maintenant (v2.0)** : **Migration compl√®te vers SDK officiel** avec refonte

### **üéØ Nouvelle Approche : Wrapper Minimal**
Conform√©ment √† la philosophie Unix de Claude Code : "**composable et scriptable**"

**Notre r√¥le** : Cr√©er un wrapper web minimal du CLI officiel Claude Code
- ‚úÖ **Interface web** : UniversalChatPanel (r√©utilis√©)
- ‚úÖ **Persistance** : Sessions Supabase (gard√©e)
- ‚úÖ **Wrapper ‚â§100 lignes** : Service minimal sur SDK officiel

### **üîÑ Nouvelles Priorit√©s**
1. **Migration SDK** : Remplacer SDK non-officiel par officiel
2. **Mode Headless** : Configuration pour int√©gration web
3. **Streaming Natif** : Utiliser capacit√©s natives
4. **M√©tadonn√©es Automatiques** : Flux de r√©flexion natif
5. **Tests avec SDK Officiel** : Validation fonctionnement

### **üèÜ Definition of Done R√©vis√©e**
- SDK officiel `@anthropic-ai/claude-code` int√©gr√© et fonctionnel
- Mode headless configur√© pour application web
- Streaming natif avec m√©tadonn√©es automatiques
- Wrapper minimal ‚â§100 lignes total
- Conformit√© totale avec documentation officielle Claude Code
- Assistant simple, fiable et maintenable

### **üìö R√©f√©rences Officielles**
Toute l'impl√©mentation DOIT suivre :
- [Overview](https://docs.anthropic.com/en/docs/claude-code/overview)
- [Headless Mode](https://docs.anthropic.com/en/docs/claude-code/headless-mode) 
- [TypeScript SDK](https://docs.anthropic.com/en/docs/claude-code/typescript)
- [Common Workflows](https://docs.anthropic.com/en/docs/claude-code/common-workflows)
