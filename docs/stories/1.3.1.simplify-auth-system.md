# Story 1.3.1: Simplify Auth System

## Status
Draft

## Story
**As a** développeur utilisant l'application,
**I want** un système d'authentification simple et fiable,
**so that** je peux me connecter sans rencontrer de boucles infinies ou de redirections en boucle

## Acceptance Criteria
1. Given je suis sur la page de login, when je clique sur 'Se connecter avec GitHub', then je suis redirigé vers GitHub pour l'authentification, and après authentification, je suis redirigé vers la page des dépôts
2. Given mon token GitHub a expiré, when j'essaie d'accéder à mes dépôts, then je suis redirigé vers la page de login avec un message clair, and je peux me reconnecter sans boucle infinie
3. Given je suis déjà connecté, when j'accède à la page de login, then je suis automatiquement redirigé vers la page des dépôts
4. Given je ne suis pas connecté, when j'accède à une page protégée, then je suis redirigé vers la page de login une seule fois
5. Given une erreur d'authentification se produit, when le système la détecte, then un message d'erreur clair est affiché à l'utilisateur
6. Given le système d'authentification fonctionne, when je navigue entre les pages, then aucune boucle infinie ne se produit

## Tasks / Subtasks
- [ ] Analyser le système d'authentification actuel (AC: 1-6)
  - [ ] Identifier les boucles infinies dans le code
  - [ ] Documenter les problèmes de gestion des tokens
  - [ ] Analyser les redirections multiples
- [ ] Simplifier le hook useAuth (AC: 1-6)
  - [ ] Supprimer providerToken du state
  - [ ] Utiliser directement les tokens depuis la session Supabase
  - [ ] Éliminer la logique de refresh automatique
- [ ] Corriger la gestion des provider tokens (AC: 2, 5)
  - [ ] Implémenter la gestion correcte selon la documentation Supabase
  - [ ] Tester les tokens avec des appels API simples
  - [ ] Gérer les erreurs de tokens expirés
- [ ] Simplifier les redirections (AC: 1-4, 6)
  - [ ] Éliminer les redirections multiples
  - [ ] Implémenter des redirections uniques et prévisibles
  - [ ] Améliorer la gestion des états d'erreur
- [ ] Améliorer l'expérience utilisateur (AC: 2, 5)
  - [ ] Ajouter des messages d'erreur clairs
  - [ ] Implémenter des états de chargement appropriés
  - [ ] Améliorer les messages de reconnexion
- [ ] Tests et validation (AC: 1-6)
  - [ ] Tests de reconnexion
  - [ ] Tests d'expiration de token
  - [ ] Tests de révocation d'accès
  - [ ] Tests de rate limit GitHub

## Dev Notes

### Relevant Source Tree
- `apps/web/src/hooks/useAuth.ts` - Hook d'authentification principal
- `apps/web/src/lib/supabase/token-utils.ts` - Utilitaires de gestion des tokens
- `apps/web/src/app/(pages)/repos/page.tsx` - Page des dépôts avec logique d'authentification
- `apps/web/src/app/(pages)/login/page.tsx` - Page de login
- `apps/web/src/middleware.ts` - Middleware d'authentification
- `apps/web/src/app/auth/callback/route.ts` - Callback OAuth

### Architecture Notes
- Le système utilise Supabase Auth pour l'authentification utilisateur
- GitHub OAuth est utilisé pour accéder aux API GitHub
- Les provider tokens sont gérés manuellement (non supporté par Supabase)
- Le système actuel tente de refresh automatiquement les provider tokens (incorrect)

### Testing Standards
- **Test file location**: `apps/web/src/hooks/__tests__/useAuth.test.ts`
- **Test standards**: Tests unitaires avec Jest et React Testing Library
- **Testing frameworks**: Jest, React Testing Library, Playwright pour E2E
- **Specific requirements**: 
  - Tester les scénarios de boucles infinies
  - Tester la gestion des tokens expirés
  - Tester les redirections multiples
  - Tester les erreurs GitHub API

### Previous Story Notes
- Le système d'authentification a été migré vers `@supabase/ssr` dans la story 1.2.1
- Des corrections pour les boucles infinies ont été apportées dans BUGFIX-infinite-loop.md
- Le problème persiste malgré les corrections précédentes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-XX | 1.0 | Initial story creation | PO |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- Analyse du code d'authentification actuel
- Documentation Supabase sur les provider tokens
- Identification des boucles infinies

### Completion Notes List
- Story en cours d'analyse et de planification

### File List
- `bmad-core/tasks/simplify-auth-system.md` - Analyse détaillée du problème
- `docs/stories/1.3.1.simplify-auth-system.md` - Cette user story

## QA Results
- Story en cours de développement
