# Story 1.7.1: Tests de Refacto et Validation Complète

## Status
Ready for Development (Dépend de Story 1.7 - Refactorisation)

## Story
**As a** Product Owner,
**I want** une suite de tests complète et robuste qui valide tous les critères d'acceptation des stories précédentes dans le contexte de la refactorisation,
**so that** je puisse m'assurer que la refactorisation n'a pas introduit de régressions et que toutes les fonctionnalités existantes fonctionnent correctement avec la nouvelle architecture.

## Acceptance Criteria

### **AC1 : Tests de Validation de la Refactorisation**
- [ ] **Tests de structure** : Validation que la nouvelle organisation des dossiers est respectée
- [ ] **Tests d'imports** : Vérification que tous les imports utilisent les nouveaux chemins
- [ ] **Tests de compilation** : Validation que TypeScript compile sans erreurs avec la nouvelle structure
- [ ] **Tests de build** : Confirmation que l'application se build correctement en production
- [ ] **Tests de linting** : Vérification que le code respecte les nouvelles conventions

### **AC2 : Tests des Composants Universels (Story 1.5.2)**
- [ ] **Tests ThreePanelsLayout** : Validation du layout à 3 panneaux redimensionnables
- [ ] **Tests UniversalTreePanel** : Tests des modes readonly et editable avec drag & drop
- [ ] **Tests UniversalContentPanel** : Tests des types code (Monaco) et document (TipTap)
- [ ] **Tests UniversalChatPanel** : Tests des agents analysis et documentation
- [ ] **Tests d'intégration** : Validation que les composants fonctionnent ensemble

### **AC3 : Tests de l'Architecture Universelle (Story 1.5.2)**
- [ ] **Tests de réutilisabilité** : Validation que les composants sont réutilisables
- [ ] **Tests de cohérence UX** : Vérification de l'interface unifiée
- [ ] **Tests d'extensibilité** : Validation que l'architecture supporte les futures fonctionnalités
- [ ] **Tests de maintenabilité** : Vérification que le code factorisé est plus maintenable

### **AC4 : Tests des Pages Context et Documentation (Stories 1.3, 1.5)**
- [ ] **Tests page Context** : Validation complète de la page context avec nouvelle architecture
- [ ] **Tests page Documentation** : Validation complète de la page documentation avec nouvelle architecture
- [ ] **Tests de navigation** : Vérification de la navigation entre les pages
- [ ] **Tests de persistance** : Validation de la sauvegarde et récupération des données

### **AC5 : Tests des API Routes Refactorisées (Story 1.7)**
- [ ] **Tests structure API** : Validation de la nouvelle structure `/api/{resource}/[id]/{action}`
- [ ] **Tests endpoints GitHub** : Validation des routes GitHub API
- [ ] **Tests endpoints Workspaces** : Validation des routes workspaces
- [ ] **Tests endpoints Documentation** : Validation des routes documentation
- [ ] **Tests gestion d'erreurs** : Validation de la gestion d'erreurs centralisée

### **AC6 : Tests des Utilitaires et Constants (Story 1.7)**
- [ ] **Tests apiClient** : Validation du client API centralisé
- [ ] **Tests constants** : Validation des constantes centralisées
- [ ] **Tests utilitaires** : Validation des utilitaires réutilisables
- [ ] **Tests gestion d'erreurs** : Validation des utilitaires d'erreur

### **AC7 : Tests de Performance et Fiabilité**
- [ ] **Tests de performance** : Validation que la refactorisation n'impacte pas les performances
- [ ] **Tests de mémoire** : Vérification de l'absence de fuites mémoire
- [ ] **Tests de stabilité** : Validation de la stabilité de l'application
- [ ] **Tests de régression** : Vérification qu'aucune fonctionnalité existante n'est cassée

### **AC8 : Tests E2E des Parcours Utilisateurs**
- [ ] **Tests parcours authentification** : Validation du flow OAuth GitHub
- [ ] **Tests parcours workspace** : Validation de la création et gestion des workspaces
- [ ] **Tests parcours context** : Validation de l'exploration de la codebase
- [ ] **Tests parcours documentation** : Validation de la création et édition de documentation
- [ ] **Tests parcours chat** : Validation des interactions avec les agents IA

## Tasks / Subtasks

### Phase 1: Tests de Validation de la Refactorisation (AC: 1)
- [ ] Créer tests de structure pour valider l'organisation des dossiers
- [ ] Créer tests d'imports pour vérifier les nouveaux chemins
- [ ] Configurer tests de compilation TypeScript
- [ ] Configurer tests de build production
- [ ] Configurer tests de linting avec nouvelles règles

### Phase 2: Tests des Composants Universels (AC: 2)
- [ ] Créer tests unitaires pour `ThreePanelsLayout`
- [ ] Créer tests unitaires pour `UniversalTreePanel` (modes readonly/editable)
- [ ] Créer tests unitaires pour `UniversalContentPanel` (types code/document)
- [ ] Créer tests unitaires pour `UniversalChatPanel` (agents analysis/documentation)
- [ ] Créer tests d'intégration pour les composants universels

### Phase 3: Tests de l'Architecture Universelle (AC: 3)
- [ ] Créer tests de réutilisabilité des composants
- [ ] Créer tests de cohérence UX
- [ ] Créer tests d'extensibilité de l'architecture
- [ ] Créer tests de maintenabilité du code factorisé

### Phase 4: Tests des Pages Context et Documentation (AC: 4)
- [ ] Créer tests E2E pour la page Context
- [ ] Créer tests E2E pour la page Documentation
- [ ] Créer tests de navigation entre les pages
- [ ] Créer tests de persistance des données

### Phase 5: Tests des API Routes Refactorisées (AC: 5)
- [ ] Créer tests pour la structure API standardisée
- [ ] Créer tests pour les endpoints GitHub
- [ ] Créer tests pour les endpoints Workspaces
- [ ] Créer tests pour les endpoints Documentation
- [ ] Créer tests pour la gestion d'erreurs centralisée

### Phase 6: Tests des Utilitaires et Constants (AC: 6)
- [ ] Créer tests pour `apiClient` centralisé
- [ ] Créer tests pour les constantes centralisées
- [ ] Créer tests pour les utilitaires réutilisables
- [ ] Créer tests pour la gestion d'erreurs

### Phase 7: Tests de Performance et Fiabilité (AC: 7)
- [ ] Créer tests de performance
- [ ] Créer tests de mémoire
- [ ] Créer tests de stabilité
- [ ] Créer tests de régression

### Phase 8: Tests E2E des Parcours Utilisateurs (AC: 8)
- [ ] Créer tests E2E pour le parcours authentification
- [ ] Créer tests E2E pour le parcours workspace
- [ ] Créer tests E2E pour le parcours context
- [ ] Créer tests E2E pour le parcours documentation
- [ ] Créer tests E2E pour le parcours chat

## Dev Notes

### Architecture Technique des Tests

**Structure de Fichiers de Tests :**
```
src/
├── __tests__/                    # Tests unitaires
│   ├── components/
│   │   ├── layout/
│   │   │   └── ThreePanelsLayout.test.tsx
│   │   ├── ui/
│   │   │   └── universal/
│   │   │       ├── UniversalTreePanel.test.tsx
│   │   │       ├── UniversalContentPanel.test.tsx
│   │   │       └── UniversalChatPanel.test.tsx
│   │   ├── documentation/
│   │   └── workspace/
│   ├── utils/
│   │   ├── api.test.ts
│   │   ├── auth.test.ts
│   │   └── formatting.test.ts
│   ├── constants/
│   │   ├── api.test.ts
│   │   ├── routes.test.ts
│   │   └── ui.test.ts
│   └── types/
│       ├── api.test.ts
│       └── components.test.ts
├── app/
│   └── api/
│       └── __tests__/            # Tests API routes
│           ├── github/
│           │   └── repos.test.ts
│           ├── workspaces/
│           │   ├── route.test.ts
│           │   ├── [id]/
│           │   │   ├── route.test.ts
│           │   │   ├── analyze.test.ts
│           │   │   ├── context.test.ts
│           │   │   └── documentation.test.ts
│           └── auth/
│               ├── callback.test.ts
│               └── signout.test.ts
└── e2e/                          # Tests E2E
    ├── auth-flow.spec.ts
    ├── workspace-flow.spec.ts
    ├── context-flow.spec.ts
    ├── documentation-flow.spec.ts
    └── chat-flow.spec.ts
```

**Configuration Jest :**
```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/__tests__/setup.ts'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.{ts,tsx}',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
}
```

**Configuration Playwright :**
```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

### Tests des Composants Universels

**Tests ThreePanelsLayout :**
```typescript
import { render, screen } from '@testing-library/react'
import { ThreePanelsLayout } from '@/components/layout/ThreePanelsLayout'

describe('ThreePanelsLayout', () => {
  it('renders three panels with correct structure', () => {
    render(
      <ThreePanelsLayout
        leftPanel={{ title: 'Tree', content: <div>Tree Content</div> }}
        centerPanel={{ title: 'Content', content: <div>Content</div> }}
        rightPanel={{ title: 'Chat', content: <div>Chat Content</div> }}
      />
    )

    expect(screen.getByText('Tree')).toBeInTheDocument()
    expect(screen.getByText('Content')).toBeInTheDocument()
    expect(screen.getByText('Chat')).toBeInTheDocument()
  })

  it('supports custom panel sizes', () => {
    const customSizes = [20, 60, 20]
    render(
      <ThreePanelsLayout
        sizes={customSizes}
        leftPanel={{ content: <div>Left</div> }}
        centerPanel={{ content: <div>Center</div> }}
        rightPanel={{ content: <div>Right</div> }}
      />
    )

    // Vérifier que les tailles sont appliquées
    const panels = screen.getAllByRole('region')
    expect(panels).toHaveLength(3)
  })
})
```

**Tests UniversalTreePanel :**
```typescript
import { render, screen, fireEvent } from '@testing-library/react'
import { UniversalTreePanel } from '@/components/ui/universal/UniversalTreePanel'

describe('UniversalTreePanel', () => {
  const mockData = [
    { id: '1', name: 'File 1', type: 'file' },
    { id: '2', name: 'Folder 1', type: 'folder', children: [] }
  ]

  it('renders in readonly mode correctly', () => {
    render(
      <UniversalTreePanel
        mode="readonly"
        data={mockData}
        onSelect={jest.fn()}
      />
    )

    expect(screen.getByText('File 1')).toBeInTheDocument()
    expect(screen.getByText('Folder 1')).toBeInTheDocument()
  })

  it('renders in editable mode with drag & drop', () => {
    render(
      <UniversalTreePanel
        mode="editable"
        data={mockData}
        onSelect={jest.fn()}
        onMove={jest.fn()}
      />
    )

    // Vérifier que les éléments sont draggables
    const draggableItems = screen.getAllByRole('treeitem')
    expect(draggableItems.length).toBeGreaterThan(0)
  })
})
```

### Tests des API Routes

**Tests API Routes :**
```typescript
import { GET, POST } from '@/app/api/workspaces/route'
import { NextRequest } from 'next/server'

describe('API Routes', () => {
  describe('GET /api/workspaces', () => {
    it('returns workspaces for authenticated user', async () => {
      // Mock Supabase client
      const mockSupabase = {
        auth: { getUser: jest.fn().mockResolvedValue({ data: { user: { id: '1' } } }) },
        from: jest.fn().mockReturnValue({
          select: jest.fn().mockResolvedValue({ data: [], error: null })
        })
      }

      const request = new NextRequest('http://localhost:3000/api/workspaces')
      const response = await GET(request)
      const data = await response.json()

      expect(response.status).toBe(200)
      expect(data.success).toBe(true)
    })
  })

  describe('POST /api/workspaces', () => {
    it('creates new workspace', async () => {
      const request = new NextRequest('http://localhost:3000/api/workspaces', {
        method: 'POST',
        body: JSON.stringify({ name: 'Test Repo', url: 'https://github.com/test/repo' })
      })

      const response = await POST(request)
      const data = await response.json()

      expect(response.status).toBe(201)
      expect(data.success).toBe(true)
    })
  })
})
```

### Tests E2E

**Tests E2E Parcours Utilisateur :**
```typescript
import { test, expect } from '@playwright/test'

test.describe('User Flows', () => {
  test('complete authentication flow', async ({ page }) => {
    await page.goto('/login')
    
    // Simuler l'authentification GitHub
    await page.click('[data-testid="github-login"]')
    
    // Vérifier la redirection vers GitHub
    await expect(page).toHaveURL(/github\.com/)
  })

  test('workspace creation and navigation', async ({ page }) => {
    await page.goto('/repos')
    
    // Sélectionner un repo
    await page.click('[data-testid="repo-item"]')
    
    // Vérifier la navigation vers le workspace
    await expect(page).toHaveURL(/\/workspaces\/[^/]+/)
  })

  test('context page functionality', async ({ page }) => {
    await page.goto('/workspaces/test-id/context')
    
    // Vérifier la structure à 3 panneaux
    await expect(page.locator('[data-testid="tree-panel"]')).toBeVisible()
    await expect(page.locator('[data-testid="content-panel"]')).toBeVisible()
    await expect(page.locator('[data-testid="chat-panel"]')).toBeVisible()
    
    // Tester la sélection de fichier
    await page.click('[data-testid="file-item"]')
    await expect(page.locator('[data-testid="file-content"]')).toBeVisible()
  })

  test('documentation page functionality', async ({ page }) => {
    await page.goto('/workspaces/test-id/documentation')
    
    // Tester la création de dossier
    await page.click('[data-testid="create-folder"]')
    await page.fill('[data-testid="folder-name"]', 'Test Folder')
    await page.click('[data-testid="save-folder"]')
    
    // Vérifier que le dossier est créé
    await expect(page.locator('text=Test Folder')).toBeVisible()
  })
})
```

### Tests de Performance

**Tests de Performance :**
```typescript
import { test, expect } from '@playwright/test'

test.describe('Performance Tests', () => {
  test('page load performance', async ({ page }) => {
    const startTime = Date.now()
    
    await page.goto('/workspaces/test-id/context')
    
    const loadTime = Date.now() - startTime
    
    // Vérifier que le temps de chargement est acceptable
    expect(loadTime).toBeLessThan(3000) // 3 secondes max
  })

  test('memory usage', async ({ page }) => {
    await page.goto('/workspaces/test-id/context')
    
    // Simuler plusieurs navigations
    for (let i = 0; i < 10; i++) {
      await page.click('[data-testid="file-item"]')
      await page.waitForTimeout(100)
    }
    
    // Vérifier qu'il n'y a pas de fuite mémoire
    const memoryInfo = await page.evaluate(() => performance.memory)
    expect(memoryInfo.usedJSHeapSize).toBeLessThan(50 * 1024 * 1024) // 50MB max
  })
})
```

### Tests de Régression

**Tests de Régression :**
```typescript
import { test, expect } from '@playwright/test'

test.describe('Regression Tests', () => {
  test('all existing functionality still works', async ({ page }) => {
    // Test 1: Authentification
    await page.goto('/login')
    await expect(page.locator('[data-testid="github-login"]')).toBeVisible()
    
    // Test 2: Navigation
    await page.goto('/repos')
    await expect(page.locator('[data-testid="repo-list"]')).toBeVisible()
    
    // Test 3: Workspace
    await page.goto('/workspaces/test-id/context')
    await expect(page.locator('[data-testid="three-panels"]')).toBeVisible()
    
    // Test 4: Documentation
    await page.goto('/workspaces/test-id/documentation')
    await expect(page.locator('[data-testid="rich-editor"]')).toBeVisible()
  })

  test('drag and drop functionality', async ({ page }) => {
    await page.goto('/workspaces/test-id/documentation')
    
    // Tester le drag & drop
    const source = page.locator('[data-testid="draggable-item"]').first()
    const target = page.locator('[data-testid="drop-zone"]').first()
    
    await source.dragTo(target)
    
    // Vérifier que l'élément a été déplacé
    await expect(target.locator('[data-testid="draggable-item"]')).toBeVisible()
  })
})
```

### Scripts de Test

**Package.json Scripts :**
```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:headed": "playwright test --headed",
    "test:regression": "jest --testNamePattern='regression'",
    "test:performance": "playwright test --grep='Performance'",
    "test:api": "jest --testPathPattern='api'",
    "test:components": "jest --testPathPattern='components'",
    "test:utils": "jest --testPathPattern='utils'"
  }
}
```

### Métriques de Qualité

**Objectifs de Couverture :**
- **Tests Unitaires** : 80% minimum
- **Tests d'Intégration** : 70% minimum
- **Tests E2E** : 90% des parcours critiques
- **Tests de Performance** : 100% des métriques critiques
- **Tests de Régression** : 100% des fonctionnalités existantes

**Métriques de Performance :**
- **Temps de chargement initial** : < 3 secondes
- **Temps de réponse API** : < 500ms
- **Utilisation mémoire** : < 50MB
- **Temps de build** : < 5 minutes

## Dependencies et Prérequis
- **CRITIQUE :** Story 1.7 doit être complètement terminée (refactorisation)
- Stories 1.0 à 1.5.3 doivent être implémentées et fonctionnelles
- Configuration Jest et Playwright en place
- Base de données de test configurée
- Variables d'environnement de test configurées

## Stratégie d'Implémentation

**Ordre de Développement :**
1. **Tests de Validation Refactorisation** : Vérifier que la refactorisation est correcte
2. **Tests des Composants Universels** : Valider les nouveaux composants
3. **Tests des API Routes** : Vérifier les endpoints refactorisés
4. **Tests des Utilitaires** : Valider les nouveaux utilitaires
5. **Tests E2E** : Valider les parcours utilisateurs complets
6. **Tests de Performance** : Vérifier les performances
7. **Tests de Régression** : S'assurer qu'aucune fonctionnalité n'est cassée

**Avantages de cette Approche :**
- Validation complète de la refactorisation
- Assurance de la qualité du code
- Prévention des régressions
- Documentation des tests pour les futurs développeurs
- Base solide pour les futures fonctionnalités

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Création initiale de la story 1.7.1 | Sarah (PO) |

## Dev Agent Record
*Section à remplir par l'agent de développement lors de l'implémentation*
