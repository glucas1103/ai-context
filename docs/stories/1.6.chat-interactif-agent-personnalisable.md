# Story 1.6: Chat Interactif avec Agent Personnalisable pour Investigation Autonome de Code

## Status
Draft (Aligné avec architecture universelle Stories 1.5.1 & 1.5.2)

## Story
**As a** Gardien du Contexte (Tech Lead/CTO),
**I want** pouvoir discuter avec un agent AI personnalisable qui comprend ma base de code et peut investiguer automatiquement les informations nécessaires via le Claude Code SDK,
**so that** je puisse obtenir des réponses précises sur mon code, générer de la documentation automatiquement, et bénéficier d'un assistant de développement intelligent adapté à mon projet sans utiliser LangChain.

## Acceptance Criteria

1. **Intégration avec UniversalChatPanel (Stories 1.5.1 & 1.5.2)**
   - Le composant `UniversalChatPanel` supporte les agents contextuels (analysis/documentation)
   - Les deux pages (Context et Documentation) utilisent le même système de chat avec agents différenciés
   - Interface de chat fonctionnelle avec streaming des réponses en temps réel
   - L'historique des conversations est maintenu et persisté dans Supabase
   - Support markdown et coloration syntaxique du code dans les réponses

2. **Système d'Agents Contextuels avec Claude Code SDK**
   - Agent `analysis` pour la page Context (exploration et analyse de code)
   - Agent `documentation` pour la page Documentation (génération et enrichissement)
   - Sélecteur d'agent dynamique dans l'interface UniversalChatPanel
   - Configuration des agents via des fichiers YAML/JSON avec Claude Code SDK TypeScript
   - Permissions d'outils ajustées selon le contexte (readonly vs editable)

3. **Investigation Autonome de la Base de Code**
   - L'agent peut rechercher automatiquement dans la base de code en utilisant les outils Claude Code (Read, Grep, Glob, LS)
   - L'agent peut lire et analyser les fichiers pertinents sans demander d'autorisation explicite pour la lecture
   - L'agent peut explorer l'arborescence des fichiers et comprendre la structure du projet
   - L'agent peut identifier les dépendances et relations entre les composants
   - L'agent affiche de manière transparente les actions d'investigation entreprises

4. **Génération Intelligente de Documentation (Agent Documentation)**
   - L'agent documentation peut analyser les commandes (ex: "Remplis ce document avec l'architecture d'authentification")
   - Investigation automatique via Claude Code SDK pour identifier les informations pertinentes
   - Génération de contenu structuré et insertion via UniversalContentPanel (mode document)
   - Intégration avec TipTap Editor pour auto-sauvegarde dans la structure existante
   - Support génération diagrammes Mermaid et code examples

5. **Analyse de Code Avancée (Agent Analysis)**
   - L'agent analysis explore la codebase pour répondre aux questions techniques
   - Identification automatique des dépendances, patterns, et problèmes potentiels
   - Suggestions d'optimisation et recommandations architecturales
   - Affichage des résultats dans UniversalContentPanel (mode code) avec Monaco Editor
   - Actions transparentes d'investigation affichées à l'utilisateur

6. **Intégration Écosystème avec Architecture Universelle**
   - Utilisation des composants universels (ThreePanelsLayout, UniversalChatPanel)
   - Intégration seamless avec les API workspaces et documentation existantes
   - Respect authentification et permissions via middleware existant
   - Persistance conversations dans tables Supabase définies (chat_sessions, chat_messages)
   - Configuration agents partagée entre pages Context et Documentation

## Tasks / Subtasks

### Phase 1: Configuration Claude Code SDK et Services de Base (AC: 2, 3)
- [ ] Installer et configurer `@instantlyeasy/claude-code-sdk-ts`
- [ ] Créer `lib/services/claude-service.ts` avec gestion sessions et modèles
- [ ] Créer `lib/services/codebase-analyzer.ts` pour orchestration investigations
- [ ] Configurer outils Claude Code (Read, Grep, Glob, LS) avec permissions
- [ ] Implémenter cache investigations et gestion erreurs

### Phase 2: Agents Contextuels et Configuration (AC: 2, 4, 5)
- [ ] Créer architecture agents dans `lib/agents/` avec types `AgentType`
- [ ] Implémenter `AnalysisAgent` pour page Context (exploration code)
- [ ] Implémenter `DocumentationAgent` pour page Documentation (génération docs)
- [ ] Créer configurations agents YAML/JSON avec prompts spécialisés
- [ ] Développer `DocumentationGenerator` pour insertion auto via TipTap

### Phase 3: Enhancement UniversalChatPanel (AC: 1)
- [ ] Étendre `UniversalChatPanel` avec sélecteur d'agents dynamique
- [ ] Intégrer Claude Code SDK dans UniversalChatPanel
- [ ] Implémenter streaming des réponses avec WebSocket/SSE
- [ ] Ajouter support markdown avec `react-markdown` et coloration syntaxique
- [ ] Créer indicateurs visuels pour actions d'investigation en cours

### Phase 4: API et Persistance (AC: 6)
- [ ] Créer endpoints `/api/workspaces/[id]/chat/` (message, stream, configure)
- [ ] Utiliser tables Supabase existantes (chat_sessions, chat_messages)
- [ ] Implémenter persistance conversations et configurations agents
- [ ] Intégrer authentification et permissions middleware existant
- [ ] Valider intégration APIs workspaces et documentation

### Phase 5: Intégration avec Pages et Composants Universels (AC: 1, 6)
- [ ] Intégrer agents dans configuration UniversalChatPanel des deux pages
- [ ] Configurer agent `analysis` pour page Context avec ThreePanelsLayout
- [ ] Configurer agent `documentation` pour page Documentation avec ThreePanelsLayout
- [ ] Ajouter actions contextuelles dans UniversalTreePanel pour déclencher agents
- [ ] Valider intégration seamless avec UniversalContentPanel (Monaco + TipTap)

### Phase 6: Tests et Optimisations (AC: 4, 5, 6)
- [ ] Tests unitaires agents et services Claude Code SDK
- [ ] Tests intégration UniversalChatPanel avec agents contextuels
- [ ] Tests E2E workflows complets (investigation + génération)
- [ ] Validation performance et cache investigations
- [ ] Documentation utilisation agents pour les développeurs

## Dev Notes

### Architecture Technique Alignée avec Stories 1.5.1 & 1.5.2

**Technologies Utilisées :**
- **Claude Code SDK TypeScript** (`@instantlyeasy/claude-code-sdk-ts`) - Interface principale avec Claude
- **Architecture Universelle** - Réutilise ThreePanelsLayout et UniversalChatPanel
- **React Query** - Gestion des états et cache pour les conversations
- **Supabase** - Tables existantes (chat_sessions, chat_messages) pour persistance
- **Composants Universels** - UniversalContentPanel pour insertion automatique

**Structure de Fichiers Alignée :**
```
apps/web/src/
├── lib/
│   ├── services/
│   │   ├── claude-service.ts          # Service principal Claude Code SDK
│   │   ├── codebase-analyzer.ts       # Orchestration des investigations
│   │   └── documentation-generator.ts # Génération via UniversalContentPanel
│   ├── agents/
│   │   ├── base-agent.ts             # Interface AgentType commune
│   │   ├── analysis-agent.ts         # Agent pour page Context
│   │   └── documentation-agent.ts    # Agent pour page Documentation
│   └── types/
│       ├── universal-components.ts   # Extension types universels (Story 1.5.2)
│       ├── agents.ts                 # Types AgentType, AgentConfig
│       └── claude.ts                 # Types pour Claude SDK
├── components/
│   ├── universal/
│   │   ├── ThreePanelsLayout.tsx     # Déjà défini (Story 1.5.2)
│   │   ├── UniversalChatPanel.tsx    # Enhanced avec agents contextuels
│   │   ├── UniversalContentPanel.tsx # Déjà défini (Story 1.5.2)
│   │   └── UniversalTreePanel.tsx    # Déjà défini (Story 1.5.2)
│   └── chat/
│       ├── AgentSelector.tsx         # Sélecteur d'agent pour UniversalChatPanel
│       └── InvestigationIndicator.tsx # Indicateur des actions Claude Code
└── app/api/workspaces/[id]/
    └── chat/
        ├── message/route.ts          # Endpoint pour messages
        ├── stream/route.ts           # Endpoint streaming
        └── agent/configure/route.ts  # Configuration d'agents
```

**Intégration avec Architecture Universelle :**
- Utilise `ThreePanelsLayout` et composants universels définis dans Story 1.5.2
- `UniversalChatPanel` enhanced avec agents contextuels (analysis/documentation)
- Insertion automatique via `UniversalContentPanel` (Monaco + TipTap selon le mode)
- Réutilise authentification, APIs, et tables Supabase existantes
- Compatible avec migrations futures des pages Context et Documentation

### Configuration des Agents Claude Code SDK

**Agents Contextuels Alignés (Stories 1.5.2) :**
```typescript
type AgentType = 'analysis' | 'documentation' // Aligné avec UniversalChatPanel

interface AgentConfig {
  name: string;
  type: AgentType;
  model: 'sonnet' | 'opus' | 'haiku';
  tools: ClaudeCodeTool[];
  systemPrompt: string;
  temperature: number;
  maxTokens: number;
  capabilities: AgentCapability[];
}
```

**Configuration Agent Analysis (Page Context) :**
```typescript
const analysisAgent: AgentConfig = {
  name: 'Code Analysis Specialist',
  type: 'analysis',
  model: 'sonnet',
  tools: ['Read', 'Grep', 'Glob', 'LS'], // Lecture seule - exploration code
  systemPrompt: `Tu es un expert en analyse de code. Explore la codebase pour identifier patterns, dépendances, et problèmes potentiels.`,
  temperature: 0.2,
  maxTokens: 4000,
  capabilities: ['code_exploration', 'dependency_analysis', 'pattern_detection']
}
```

**Configuration Agent Documentation (Page Documentation) :**
```typescript
const documentationAgent: AgentConfig = {
  name: 'Documentation Generator',
  type: 'documentation',
  model: 'sonnet',
  tools: ['Read', 'Grep', 'Glob', 'LS'], // Investigation + génération
  systemPrompt: `Tu es un expert en documentation technique. Analyse le code et génère une documentation structurée et complète.`,
  temperature: 0.3,
  maxTokens: 4000,
  capabilities: ['documentation_generation', 'content_structuring', 'mermaid_diagrams']
}
```

### Workflow Intégré avec Composants Universels

**Séquence Investigation + Génération (Agent Documentation) :**
1. Utilisateur sélectionne fichier dans `UniversalTreePanel` (mode editable)
2. Utilisateur envoie commande dans `UniversalChatPanel` (ex: "Enrichis ce document avec l'architecture d'auth")
3. Agent documentation utilise Claude Code SDK pour investigation automatique
4. Agent génère contenu structuré et l'insère via `UniversalContentPanel` (mode document)
5. Auto-sauvegarde via TipTap Editor dans la structure documentation existante

**Séquence Analysis + Exploration (Agent Analysis) :**
1. Utilisateur sélectionne fichier dans `UniversalTreePanel` (mode readonly) 
2. Utilisateur pose question dans `UniversalChatPanel` (ex: "Analyse les dépendances de ce composant")
3. Agent analysis investigue la codebase via Claude Code SDK
4. Résultats affichés dans `UniversalContentPanel` (mode code) avec Monaco Editor
5. Actions d'investigation transparentes affichées dans le chat

**Outils Claude Code Utilisés :**
- **Read** : Lecture fichiers avec contexte du workspace
- **Grep** : Recherche patterns pour identifier code pertinent
- **Glob** : Recherche fichiers par patterns (ex: `**/*auth*`, `**/*.config.*`)
- **LS** : Exploration arborescence pour structure projet
- **TodoWrite** : Création listes tâches pour analyses complexes

### Base de Données - Utilisation Tables Existantes

**Tables Supabase Existantes (déjà définies) :**
```sql
-- Table pour les sessions de chat (déjà existante)
CREATE TABLE chat_sessions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users(id),
  agent_id text NOT NULL, -- 'analysis' | 'documentation'  
  title text,
  context jsonb DEFAULT '{}'::jsonb, -- workspace_id, selectedFile, etc.
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- Table pour les messages de chat (déjà existante)
CREATE TABLE chat_messages (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id uuid REFERENCES chat_sessions(id),
  role text CHECK (role = ANY (ARRAY['user', 'assistant', 'system'])),
  content text NOT NULL,
  metadata jsonb DEFAULT '{}'::jsonb, -- Actions Claude Code, fichiers lus, etc.
  created_at timestamptz DEFAULT now()
);

-- Extension utilisation context pour metadata :
-- {
--   "workspace_id": "uuid",
--   "selected_file": "path/to/file",
--   "agent_type": "analysis|documentation",
--   "claude_actions": ["Read", "Grep", "Glob"],
--   "investigation_files": ["file1.ts", "file2.ts"]
-- }
```

### Testing

**Standards de Test :**
- Tests unitaires avec Jest pour les services Claude et les agents
- Tests d'intégration pour les WebSocket/SSE de streaming
- Tests E2E avec Playwright pour les workflows de chat complets
- Mocks du Claude Code SDK pour les tests automatisés

**Fichiers de Test :**
```
src/lib/services/__tests__/
├── claude-service.test.ts
├── codebase-analyzer.test.ts
└── documentation-generator.test.ts

src/components/chat/__tests__/
├── ChatInterface.test.tsx
├── AgentSelector.test.tsx
└── MessageList.test.tsx

e2e/
├── chat-documentation-flow.spec.ts
├── agent-configuration.spec.ts
└── code-investigation.spec.ts
```

**Patterns de Test :**
- Factory Pattern pour créer des configurations d'agents de test
- Fixtures réalistes pour les réponses Claude Code SDK
- Tests de régression pour s'assurer de la cohérence des agents
- Tests de performance pour les investigations de grandes codebases

## Dependencies et Prérequis
- **CRITIQUE :** Story 1.5.2 doit être terminée (composants universels avec ThreePanelsLayout)
- Story 1.5.1 doit être complètement terminée (migration Documentation vers panels)
- Tables Supabase chat_sessions et chat_messages déjà créées et fonctionnelles
- Validation architecture universelle avec UniversalChatPanel support agents

## Stratégie d'Implémentation Séquentielle

**Ordre de Développement Recommandé :**
1. **Story 1.5.1** : Migration Documentation vers architecture modulaire
2. **Story 1.5.2** : Création composants universels (ThreePanelsLayout, UniversalChatPanel, etc.)
3. **Story 1.6** : Enhancement UniversalChatPanel avec agents Claude Code SDK

**Avantages Approche Séquentielle :**
- Composants universels d'abord = foundation solide pour agents
- UniversalChatPanel déjà en place pour intégration Claude Code SDK
- Architecture cohérente entre pages avant ajout fonctionnalités IA
- Réutilisation maximale des patterns établis

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Création initiale de la story 1.6 | Sarah (PO) |
| 2024-12-19 | 1.1 | Alignement avec architecture universelle (Stories 1.5.1 & 1.5.2) | Sarah (PO) |

## Dev Agent Record
*Section à remplir par l'agent de développement lors de l'implémentation*

### Testing

**Test Standards to Follow:**
- Tests unitaires : Coverage minimum 80% pour les services critiques
- Tests d'intégration : Tous les endpoints API doivent être testés
- Tests E2E : Workflows complets de chat et génération de documentation
- Tests de charge : Performance avec de grandes codebases (10k+ fichiers)

**Test File Locations:**
- Unit tests : `src/**/__tests__/**/*.test.ts`
- Integration tests : `src/app/api/**/__tests__/**/*.test.ts`
- E2E tests : `e2e/**/*.spec.ts`

**Testing Frameworks:**
- Jest pour les tests unitaires et d'intégration
- React Testing Library pour les composants
- Playwright pour les tests E2E
- MSW (Mock Service Worker) pour mocker les API externes
