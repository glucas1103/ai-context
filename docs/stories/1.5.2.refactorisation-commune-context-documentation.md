# Story 1.5.2: refactorisation-commune-context-documentation

## Status
Draft (Mise à jour post-investigation implémentation)

## Story
**As a** Développeur,
**I want** factoriser les composants communs entre les pages context et documentation en créant un système de composants universels,
**so that** je puisse maintenir une UI cohérente, réutiliser le pattern 3-panneaux, et différencier les comportements IA selon le contexte.

## Acceptance Criteria
1. Composant `ThreePanelsLayout` créé pour standardiser la structure PanelGroup des deux pages
2. Composant `UniversalTreePanel` créé, configurable pour context (readonly) et documentation (editable)
3. Composant `UniversalContentPanel` créé, supportant Monaco (context) et TipTap (documentation)
4. Composant `UniversalChatPanel` créé avec système d'agents contextuels (analysis vs documentation)
5. Les deux pages migrent vers les composants universels avec configurations spécifiques
6. Aucune régression fonctionnelle dans context ou documentation après migration
7. Interface IA différenciée prête pour Story 1.6 (agents analysis vs documentation)
8. Architecture extensible pour futures pages utilisant le pattern 3-panneaux

## Business Value
- **Réutilisabilité :** Composants universels utilisables dans multiples contextes
- **Cohérence UX :** Interface utilisateur unifiée à travers l'application
- **IA Contextuelle :** Prompts et comportements IA adaptés au contexte d'usage
- **Maintenabilité :** Code factorísé plus facile à maintenir et faire évoluer
- **Extensibilité :** Architecture préparée pour futures fonctionnalités (Epic 2, 3, 4)

## Tasks / Subtasks

### Phase 1: Composant ThreePanelsLayout (AC: 1)
- [ ] Créer `components/universal/ThreePanelsLayout.tsx` (~60 lignes)
- [ ] Encapsuler PanelGroup, Panel, PanelResizeHandle de react-resizable-panels
- [ ] Configuration des tailles par défaut et contraintes (min/max)
- [ ] Props pour personnaliser les panneaux (titles, content, actions)
- [ ] Support configuration layout (sizes, orientation, persistence)

### Phase 2: Architecture des Composants Universels (AC: 2, 3, 4)
- [ ] Créer `lib/types/universal-components.ts` avec interfaces communes
- [ ] Définir `PanelMode` (readonly/editable) et `ContentType` (code/document) 
- [ ] Définir `AgentType` (analysis/documentation) pour Story 1.6
- [ ] Analyser les props communes entre TreeContext/TreePanel, FileContext/ContentPanel, etc.

### Phase 3: Composant UniversalTreePanel (AC: 2)
- [ ] Créer `components/universal/UniversalTreePanel.tsx` (~120 lignes)
- [ ] Mode `readonly` : utilise TreeContext existant (context page)
- [ ] Mode `editable` : utilise DocumentationTreePanel existant (documentation page)
- [ ] Interface commune pour sélection et callbacks
- [ ] Configuration icônes, actions, headers selon le mode

### Phase 4: Composant UniversalContentPanel (AC: 3)
- [ ] Créer `components/universal/UniversalContentPanel.tsx` (~100 lignes)
- [ ] Type `code` : intègre Monaco Editor (FileContext)
- [ ] Type `document` : intègre TipTap Editor (DocumentationContentPanel existant)
- [ ] Gestion états communs (loading, content, saving)
- [ ] Headers et actions contextuels selon le type

### Phase 5: Composant UniversalChatPanel (AC: 4, 7)
- [ ] Créer `components/universal/UniversalChatPanel.tsx` (~80 lignes)
- [ ] Agent `analysis` : configuration pour exploration code
- [ ] Agent `documentation` : configuration pour assistance documentation
- [ ] Interface préparée pour Story 1.6 (different prompts/behaviors)
- [ ] Réutilise ChatPanel existant avec configurations

### Phase 6: Migration Page Context (AC: 5)
- [ ] Migrer page context vers ThreePanelsLayout + composants universels
- [ ] Configuration : TreePanel(readonly), ContentPanel(code), ChatPanel(analysis)
- [ ] Maintenir la logique d'état et callbacks existants
- [ ] Valider UX identique avec panels redimensionnables

### Phase 7: Migration Page Documentation (AC: 5)
- [ ] Migrer page documentation vers ThreePanelsLayout + composants universels  
- [ ] Configuration : TreePanel(editable), ContentPanel(document), ChatPanel(documentation)
- [ ] Maintenir toutes fonctionnalités CRUD et auto-save (déjà fonctionnelles)
- [ ] Valider UX cohérente avec page context

### Phase 8: Tests et Validation (AC: 6, 8)
- [ ] Tests unitaires composants universels
- [ ] Tests d'intégration avec configurations différentes
- [ ] Validation absence de régressions fonctionnelles
- [ ] Tests d'extensibilité pour futures pages
- [ ] Documentation pattern d'utilisation ThreePanelsLayout

## Dev Notes

### Analyse Post-Investigation

**Réalité Implémentation :**
- **Context Page :** Déjà bien structurée avec PanelGroup + composants modulaires (178 lignes)
- **Documentation Page :** ✅ Refactorisée avec architecture modulaire et panels redimensionnables (274 lignes)
- **Composants Existants :** TreeContext, FileContext, ChatContext, DocumentationTreePanel, DocumentationContentPanel, DocumentationChatPanel, ChatPanel

**Similitudes Identifiées (factorisation possible) :**
- Pattern 3-panneaux (gauche: arbre, centre: contenu, droite: chat)
- Structure react-resizable-panels déjà utilisée dans Context ET Documentation
- Composants tree, content, chat dans les deux pages
- Gestion états selectedFile/selectedNode similaire
- Interface de chat pour assistance IA

**Différences à Préserver (configuration) :**
- **TreePanel :** readonly (context) vs editable (documentation)
- **ContentPanel :** Monaco (code) vs TipTap (markdown)
- **ChatPanel :** agent analysis vs agent documentation (Story 1.6)
- **Types :** FileTreeNode vs DocumentationNode (interface commune TreeNodeBase)

### Architecture Universelle Cible

**Structure Après Factorisation :**
```
apps/web/src/
├── lib/types/
│   ├── universal-components.ts            # Types composants universels
│   ├── common.ts                         # TreeNodeBase interface commune
│   ├── context.ts                        # Types context (existant)
│   └── documentation.ts                  # Types documentation (existant)
├── components/
│   ├── universal/                        # Composants factorísés
│   │   ├── ThreePanelsLayout.tsx         # Layout standard 3-panneaux
│   │   ├── UniversalTreePanel.tsx        # Tree configurable (readonly/editable)
│   │   ├── UniversalContentPanel.tsx     # Content dual (Monaco/TipTap)
│   │   └── UniversalChatPanel.tsx        # Chat avec agents contextuels
│   ├── [Composants Context]              # TreeContext, FileContext, ChatContext (existants)
│   ├── [Composants Documentation]        # DocumentationTree, ChatPanel (existants)
│   └── [Autres composants spécialisés]
└── app/(pages)/workspaces/[id]/
    ├── context/page.tsx                  # Utilise ThreePanelsLayout + readonly/code/analysis
    └── documentation/page.tsx            # Utilise ThreePanelsLayout + editable/document/documentation
```

### Spécifications des Composants Universels

#### 1. `ThreePanelsLayout.tsx` - Layout Standard (~60 lignes)

**Responsabilités :**
- Encapsule PanelGroup/Panel/PanelResizeHandle pattern
- Configuration standardisée des tailles et contraintes
- Persistance optionnelle des layouts utilisateur
- Interface cohérente pour toutes pages 3-panneaux

**Props Interface :**
```typescript
interface ThreePanelsLayoutProps {
  leftPanel: React.ReactNode
  centerPanel: React.ReactNode  
  rightPanel: React.ReactNode
  config?: {
    defaultSizes?: [number, number, number] // ex: [25, 50, 25]
    minSizes?: [number, number, number]     // ex: [15, 30, 15] 
    maxSizes?: [number, number, number]     // ex: [40, 70, 40]
    persistKey?: string                     // pour sauvegarde layout
  }
  className?: string
}
```

#### 2. `UniversalTreePanel.tsx` - Arborescence Configurable (~120 lignes)

**Configuration Mode :**
```typescript
type TreePanelMode = 'readonly' | 'editable'

interface UniversalTreePanelProps<T extends TreeNodeBase> {
  data: T[]
  selectedId?: string
  mode: TreePanelMode
  onSelect: (node: T | null) => void
  
  // Conditionnel selon mode
  crudActions?: TreeCRUDActions<T>  // Si mode = 'editable'
  
  // Configuration UI
  config: {
    title: string
    showCount: boolean
    icons: TreeIconConfig
    contextActions?: TreeContextAction[]
  }
}
```

#### 3. `UniversalContentPanel.tsx` - Éditeur Dual (~100 lignes)

**Configuration Éditeur :**
```typescript
type ContentPanelMode = 'code' | 'document'

interface UniversalContentPanelProps {
  selectedItem: TreeNodeBase | null
  content: string
  mode: ContentPanelMode
  
  onChange: (content: string) => void
  onSave?: (content: string) => Promise<void>
  
  // Configuration selon mode
  editorConfig: MonacoConfig | TipTapConfig
  
  // États communs
  isLoading?: boolean
  isSaving?: boolean
}
```

#### 4. `UniversalChatPanel.tsx` - Chat Contextuel (~80 lignes)

**Configuration IA (Préparation Story 1.6) :**
```typescript
type AgentType = 'analysis' | 'documentation'

interface UniversalChatPanelProps {
  agentType: AgentType
  selectedItem?: TreeNodeBase | null
  workspaceId: string
  
  onSendMessage: (message: string) => Promise<void>
  messages: ChatMessage[]
  isLoading?: boolean
  
  // Configuration agent IA (Story 1.6)
  agentConfig?: {
    systemPrompt: string
    suggestions: string[]
    capabilities: AgentCapability[]
  }
}
```

### Système de Prompts Différenciés

**Context IA (Analysis/Exploration) :**
```typescript
const CONTEXT_PROMPTS = {
  systemPrompt: "Tu es un assistant IA spécialisé dans l'analyse de code...",
  contextPrompts: {
    fileSelected: "Analyse ce fichier {fileName} de type {language}...",
    suggestions: [
      "Explique-moi ce code",
      "Trouve les dépendances",
      "Identifie les problèmes potentiels",
      "Propose des améliorations"
    ]
  }
}
```

**Documentation IA (Documentation/Enrichissement) :**
```typescript
const DOCUMENTATION_PROMPTS = {
  systemPrompt: "Tu es un assistant IA spécialisé dans la création de documentation...",
  contextPrompts: {
    fileSelected: "Aide-moi à enrichir ce document {fileName}...",
    suggestions: [
      "Améliore cette documentation",
      "Ajoute des exemples",
      "Restructure le contenu",
      "Génère du contenu manquant"
    ]
  }
}
```

### Exemple d'Utilisation ThreePanelsLayout

**Page Context (Refactorisée) :**
```typescript
// apps/web/src/app/(pages)/workspaces/[id]/context/page.tsx
export default function WorkspaceContextPage({ params }) {
  // ... logique d'état existante ...
  
  return (
    <ThreePanelsLayout
      leftPanel={
        <UniversalTreePanel
          data={fileTree}
          mode="readonly"
          selectedId={selectedFile?.id}
          onSelect={loadFileContent}
          config={{
            title: 'Arborescence',
            showCount: true,
            icons: CODE_ICONS
          }}
        />
      }
      centerPanel={
        <UniversalContentPanel
          selectedItem={selectedFile}
          content={fileContent}
          mode="code"
          editorConfig={MONACO_CONFIG}
          isLoading={isLoadingContent}
        />
      }
      rightPanel={
        <UniversalChatPanel
          agentType="analysis"
          selectedItem={selectedFile}
          workspaceId={workspaceId}
          onSendMessage={handleSendMessage}
          messages={messages}
          agentConfig={ANALYSIS_AGENT_CONFIG}
        />
      }
      config={{
        defaultSizes: [25, 50, 25],
        persistKey: 'context-layout'
      }}
    />
  )
}
```

**Page Documentation (Refactorisée) :**
```typescript
// apps/web/src/app/(pages)/workspaces/[id]/documentation/page.tsx
export default function DocumentationPage({ params }) {
  // ... logique d'état existante ...
  
  return (
    <ThreePanelsLayout
      leftPanel={
        <UniversalTreePanel
          data={treeData}
          mode="editable"
          selectedId={selectedFile?.id}
          onSelect={handleSelectFile}
          crudActions={DOCUMENTATION_CRUD_ACTIONS}
          config={{
            title: 'Documentation',
            showCount: true,
            icons: DOC_ICONS
          }}
        />
      }
      centerPanel={
        <UniversalContentPanel
          selectedItem={selectedFile}
          content={fileContent}
          mode="document"
          onChange={handleContentChange}
          onSave={handleAutoSave}
          editorConfig={TIPTAP_CONFIG}
          isSaving={isSaving}
        />
      }
      rightPanel={
        <UniversalChatPanel
          agentType="documentation"
          selectedItem={selectedFile}
          workspaceId={workspaceId}
          onSendMessage={handleSendMessage}
          messages={messages}
          agentConfig={DOCUMENTATION_AGENT_CONFIG}
        />
      }
      config={{
        defaultSizes: [25, 50, 25],
        persistKey: 'documentation-layout'
      }}
    />
  )
}
```

### Avantages de la Factorisation

1. **Réutilisabilité Maximale**
   - Composants universels pour futures pages (ex: Epic 3 - Code Review)
   - Configuration flexible sans duplication
   - Patterns UI cohérents à travers l'app

2. **IA Contextuelle**
   - Prompts spécialisés selon le contexte d'usage
   - Comportements IA différenciés mais interface uniforme
   - Extensibilité pour nouveaux contextes IA

3. **Maintenabilité Optimale**
   - Corrections/améliorations bénéficient à toutes les pages
   - Tests centralisés sur composants universels
   - Évolution coordonnée de l'interface

4. **Architecture Extensible**
   - Pattern 3-panneaux réutilisable (Epic 2, 3, 4)
   - Système de configuration pour nouveaux modes
   - Foundation solide pour futures fonctionnalités

### Plan de Migration Sécurisé

1. **Phase 1 :** Création ThreePanelsLayout (foundation layout)
2. **Phase 2 :** Types et architecture composants universels
3. **Phase 3-5 :** Création composants universels configurable
4. **Phase 6 :** Migration Context (déjà bien structurée)
5. **Phase 7 :** Migration Documentation (après Story 1.5.1 ✅ Terminée)
6. **Phase 8 :** Validation et tests d'extensibilité

**Avantages Stratégiques :**
- **ThreePanelsLayout** : Pattern réutilisable pour toutes futures pages
- **Agents Contextuels** : Préparation optimale pour Story 1.6
- **Extensibilité** : Architecture prête pour Epic 2, 3, 4
- **Cohérence UX** : Interface unifiée à travers l'application

**Durée Estimée :** 3-4 jours de développement.
**Complexité :** Moyenne - factorisation progressive avec validation.

## Dependencies et Prérequis
- ✅ Story 1.5.1 complètement terminée (refactoring documentation)
- Story 1.3.1 doit être validée (refactoring context)
- Tests automatisés robustes en place pour détection régressions
- Validation équipe sur l'approche architecture universelle

## Acceptance Tests
1. **Test Context :** Comportement identical après migration vers composants universels
2. **Test Documentation :** Toutes fonctionnalités CRUD conservées après migration
3. **Test IA Différenciée :** Prompts et contextes IA appropriés selon la page
4. **Test Réutilisabilité :** Possibilité créer nouvelle page 3-panneaux facilement
5. **Test Performance :** Aucune dégradation performance après factorisation
