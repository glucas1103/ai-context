# Story 1.6.2: Agents Intelligents avec Claude Code SDK

## Status
Draft (DÃ©pend de Story 1.6.1) - **SQL Database Ready** âœ…

## ğŸš¨ CRITIQUE : FONDATIONS DE LA STORY 1.6.1 Ã€ UTILISER

**ATTENTION :** Cette story doit IMPÃ‰RATIVEMENT utiliser les composants et services dÃ©jÃ  construits dans la Story 1.6.1. Ne pas recrÃ©er de logique dupliquÃ©e.

### ğŸ“‹ Composants et Services Disponibles (Story 1.6.1)

#### 1. **Types et Interfaces TypeScript** âœ…
**Fichier :** `src/types/chat/universal.ts`
- **`UniversalChatPanelProps`** : Interface complÃ¨te pour la configuration du chat
- **`ChatMessage`** : Structure des messages avec mÃ©tadonnÃ©es Claude Code
- **`ChatSession`** : Gestion des sessions avec contexte Claude Code
- **`ClaudeCodeContext`** : Contexte d'investigation et workspace
- **`InvestigationStep`** : Ã‰tapes d'investigation avec outils utilisÃ©s
- **`ReasoningStep`** : Ã‰tapes de raisonnement multi-Ã©tapes
- **`InvestigationResult`** : RÃ©sultats d'investigation structurÃ©s

#### 2. **Composants UI Universels** âœ…
**Dossier :** `src/components/universal/chat/`
- **`UniversalChatPanel.tsx`** : Composant principal avec streaming et onglets
- **`Message.tsx`** : Affichage de messages avec mÃ©tadonnÃ©es Claude Code
- **`MessageList.tsx`** : Liste avec auto-scroll et gestion d'Ã©tat
- **`MessageInput.tsx`** : Zone de saisie avec support markdown
- **`ChatHeader.tsx`** : En-tÃªte avec statut et informations session
- **`ChatControls.tsx`** : ContrÃ´les (clear, export, settings)
- **`EnrichedMessage.tsx`** : Messages enrichis avec preview de code
- **`ClaudeCodeIndicator.tsx`** : Indicateurs visuels pour actions Claude Code

#### 3. **Hooks et Gestion d'Ã‰tat** âœ…
**Dossier :** `src/hooks/`
- **`useChatSession.ts`** : Gestion complÃ¨te des sessions Claude Code
- **`useChatMessages.ts`** : Gestion des messages avec persistance
- **`useChatTabs.ts`** : Gestion des onglets de conversation

#### 4. **Services Backend** âœ…
**Fichier :** `src/lib/services/chatService.ts`
- **API Routes** : `/api/workspaces/[id]/chat/sessions` et `/chat/message`
- **Persistance Supabase** : Tables `chat_sessions` et `chat_messages` Ã©tendues
- **Streaming** : Support des rÃ©ponses Claude Code en temps rÃ©el
- **Gestion d'erreurs** : Retry automatique et Ã©tats d'erreur

#### 5. **Base de DonnÃ©es Ã‰tendue** âœ…
**Tables Supabase dÃ©jÃ  configurÃ©es :**
```sql
-- chat_sessions Ã©tendue avec support Claude Code
ALTER TABLE chat_sessions ADD COLUMN title TEXT DEFAULT 'Nouvelle conversation';
ALTER TABLE chat_sessions ADD COLUMN tab_order INTEGER DEFAULT 0;
ALTER TABLE chat_sessions ADD COLUMN is_active BOOLEAN DEFAULT false;
ALTER TABLE chat_sessions ADD COLUMN is_dirty BOOLEAN DEFAULT false;
ALTER TABLE chat_sessions ADD COLUMN claude_session_id text;
ALTER TABLE chat_sessions ADD COLUMN investigation_context jsonb;

-- chat_messages Ã©tendue avec mÃ©tadonnÃ©es Claude Code
ALTER TABLE chat_messages ADD COLUMN claude_actions jsonb;
ALTER TABLE chat_messages ADD COLUMN investigation_steps jsonb;
ALTER TABLE chat_messages ADD COLUMN reasoning_steps jsonb;
```

#### 6. **FonctionnalitÃ©s AvancÃ©es** âœ…
- **Interface Cursor-style** : Onglets, bulles utilisateur, flux libre agent
- **Gestion des onglets** : Sessions multiples avec persistance
- **Preview de code** : Monaco Editor intÃ©grÃ© pour l'affichage de code
- **MÃ©tadonnÃ©es Claude Code** : Outils utilisÃ©s, fichiers analysÃ©s, investigations
- **Ã‰tats d'investigation** : Indicateurs visuels pour actions en cours
- **Streaming temps rÃ©el** : RÃ©ponses progressives avec indicateurs

### ğŸ¯ Comment Utiliser les Fondations (Story 1.6.2)

#### 1. **INTÃ‰GRATION OBLIGATOIRE**
```typescript
// UTILISER le composant existant, ne pas recrÃ©er
import { UniversalChatPanel } from '@/components/universal/UniversalChatPanel';

// UTILISER les types existants, ne pas redÃ©finir
import { 
  ChatMessage, 
  ClaudeCodeContext, 
  InvestigationStep 
} from '@/types/chat/universal';

// UTILISER les hooks existants, ne pas recrÃ©er
import { useChatSession, useChatMessages } from '@/hooks/useChatSession';
```

#### 2. **SERVICES Ã€ Ã‰TENDRE, PAS Ã€ RECRÃ‰ER**
```typescript
// Ã‰TENDRE le service existant, ne pas crÃ©er un nouveau
import { chatService } from '@/lib/services/chatService';

// Ajouter les mÃ©thodes Claude Code au service existant
export const claudeCodeService = {
  // NOUVELLES mÃ©thodes pour Claude Code SDK
  async investigateCodebase(query: string, context: ClaudeCodeContext) {
    // Utiliser les outils Claude Code SDK
  },
  
  // RÃ‰UTILISER les mÃ©thodes existantes
  createSession: chatService.createSession,
  addMessage: chatService.addMessage,
  getMessages: chatService.getMessages
};
```

#### 3. **COMPOSANTS Ã€ ENRICHIR, PAS Ã€ DUPLIQUER**
```typescript
// ENRICHIR le composant existant avec de nouvelles props
interface ClaudeCodeChatPanelProps extends UniversalChatPanelProps {
  // NOUVELLES props spÃ©cifiques Ã  Claude Code
  claudeCodeConfig?: ClaudeCodeConfig;
  onInvestigationStart?: (query: string) => void;
  onInvestigationComplete?: (results: InvestigationResult[]) => void;
}

// UTILISER le composant de base et ajouter les fonctionnalitÃ©s
export const ClaudeCodeChatPanel = (props: ClaudeCodeChatPanelProps) => {
  // RÃ‰UTILISER la logique existante
  const { messages, sendMessage } = useChatMessages(props.sessionId);
  
  // AJOUTER la logique Claude Code spÃ©cifique
  const { investigateCodebase } = useClaudeCodeInvestigation();
  
  return (
    <UniversalChatPanel
      {...props}
      onMessageSent={async (message) => {
        // Logique Claude Code + logique existante
        await sendMessage(message);
        await investigateCodebase(message.content);
      }}
    />
  );
};
```

#### 4. **TYPES Ã€ Ã‰TENDRE, PAS Ã€ REDÃ‰FINIR**
```typescript
// Ã‰TENDRE les types existants dans le mÃªme fichier
// src/types/chat/universal.ts

// AJOUTER les nouveaux types pour Claude Code SDK
interface ClaudeCodeTool {
  name: 'Read' | 'Grep' | 'Glob' | 'LS';
  permissions: string[];
  description: string;
}

interface ClaudeCodeConfig {
  model: 'sonnet' | 'opus' | 'haiku';
  tools: ClaudeCodeTool[];
  temperature: number;
  maxTokens: number;
  reasoningSteps: boolean;
}

// RÃ‰UTILISER les types existants
interface ChatMessage {
  // ... types existants ...
  metadata?: {
    // ... mÃ©tadonnÃ©es existantes ...
    // AJOUTER les nouvelles mÃ©tadonnÃ©es Claude Code
    claudeCodeActions?: ClaudeCodeAction[];
    investigationResults?: InvestigationResult[];
  };
}
```

### ğŸš« CE QU'IL NE FAUT PAS FAIRE

#### âŒ **NE PAS RECRÃ‰ER :**
- Composants de chat (UniversalChatPanel, Message, MessageList, etc.)
- Hooks de gestion d'Ã©tat (useChatSession, useChatMessages, useChatTabs)
- Services de persistance (chatService)
- Types de base (ChatMessage, ChatSession, ClaudeCodeContext)
- Tables de base de donnÃ©es (chat_sessions, chat_messages)
- Interface utilisateur (onglets, bulles, streaming)

#### âŒ **NE PAS DUPLIQUER :**
- Logique de gestion des sessions
- Logique de persistance Supabase
- Logique de streaming des rÃ©ponses
- Logique de gestion des onglets
- Logique d'affichage des messages
- Logique de gestion d'erreurs

### âœ… **CE QU'IL FAUT FAIRE :**

#### âœ… **EXTENDRE ET ENRICHIR :**
- Ajouter les mÃ©thodes Claude Code SDK au service existant
- Ã‰tendre les types avec les nouvelles mÃ©tadonnÃ©es Claude Code
- Enrichir le composant UniversalChatPanel avec les nouvelles props
- Ajouter les hooks spÃ©cifiques Ã  Claude Code
- CrÃ©er les nouveaux composants d'affichage pour les rÃ©sultats d'investigation

#### âœ… **INTÃ‰GRER ET CONNECTER :**
- Connecter le Claude Code SDK aux composants existants
- Utiliser les callbacks existants pour les nouvelles fonctionnalitÃ©s
- RÃ©utiliser la logique de streaming pour les rÃ©ponses Claude Code
- IntÃ©grer les mÃ©tadonnÃ©es Claude Code dans les messages existants

### ğŸ“ Structure de Fichiers RecommandÃ©e

```
src/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ chatService.ts              # âœ… EXISTANT - RÃ‰UTILISER
â”‚       â”œâ”€â”€ claude-code-sdk.ts          # ğŸ†• NOUVEAU - SDK Claude Code
â”‚       â””â”€â”€ claude-code-assistant.ts    # ğŸ†• NOUVEAU - Assistant unifiÃ©
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useChatSession.ts               # âœ… EXISTANT - RÃ‰UTILISER
â”‚   â”œâ”€â”€ useChatMessages.ts              # âœ… EXISTANT - RÃ‰UTILISER
â”‚   â”œâ”€â”€ useChatTabs.ts                  # âœ… EXISTANT - RÃ‰UTILISER
â”‚   â””â”€â”€ useClaudeCodeInvestigation.ts   # ğŸ†• NOUVEAU - Investigation Claude Code
â”œâ”€â”€ components/
â”‚   â””â”€â”€ universal/
â”‚       â”œâ”€â”€ UniversalChatPanel.tsx      # âœ… EXISTANT - ENRICHIR
â”‚       â””â”€â”€ chat/                       # âœ… EXISTANT - RÃ‰UTILISER
â””â”€â”€ types/
    â””â”€â”€ chat/
        â””â”€â”€ universal.ts                # âœ… EXISTANT - Ã‰TENDRE
```

### ğŸ¯ Objectif de la Story 1.6.2

**Transformer l'UniversalChatPanel existant en assistant Claude Code intelligent** en :
1. **Connectant** le Claude Code SDK aux composants existants
2. **Enrichissant** les types avec les mÃ©tadonnÃ©es d'investigation
3. **Ajoutant** les hooks pour l'investigation autonome
4. **CrÃ©ant** les services pour l'orchestration Claude Code
5. **IntÃ©grant** le raisonnement multi-Ã©tapes dans l'interface existante

**RÃ‰SULTAT :** Un assistant Claude Code complet qui utilise toutes les fondations de la Story 1.6.1 sans duplication.

## Story
**As a** Gardien du Contexte (Tech Lead/CTO),
**I want** un assistant Claude Code intelligent qui peut investiguer automatiquement ma base de code et raisonner de maniÃ¨re autonome en plusieurs Ã©tapes,
**so that** je puisse obtenir des rÃ©ponses prÃ©cises sur mon code, gÃ©nÃ©rer de la documentation automatiquement, et bÃ©nÃ©ficier d'un assistant de dÃ©veloppement intelligent qui affiche son raisonnement de maniÃ¨re transparente.

## Acceptance Criteria

1. **IntÃ©gration Claude Code SDK**
   - Installation et configuration de `@instantlyeasy/claude-code-sdk-ts`
   - Service centralisÃ© pour la gestion des sessions Claude
   - Configuration des outils Claude Code (Read, Grep, Glob, LS) avec permissions
   - Gestion des erreurs et retry automatique pour les appels API

2. **Assistant Claude Code UnifiÃ©**
   - IntÃ©gration directe avec Claude Code SDK sans agents configurables
   - Claude Code gÃ¨re automatiquement l'exploration et l'analyse selon la question
   - Pas de configuration YAML/JSON complexe - tout fonctionne avec des questions naturelles
   - Interface unifiÃ©e pour tous les types d'interactions (analyse, documentation, etc.)

3. **Investigation Autonome de la Base de Code**
   - L'agent peut rechercher automatiquement dans la codebase sans intervention utilisateur
   - Utilisation des outils Claude Code pour exploration (Read, Grep, Glob, LS)
   - Identification automatique des dÃ©pendances et relations entre composants
   - Cache des investigations pour optimiser les performances
   - Affichage transparent des actions d'investigation entreprises

4. **Raisonnement Multi-Ã‰tapes et Transparence**
   - L'agent peut raisonner de maniÃ¨re autonome en plusieurs Ã©tapes
   - Affichage du processus de raisonnement Ã©tape par Ã©tape
   - Indicateurs visuels pour les actions en cours (investigation, analyse, gÃ©nÃ©ration)
   - Choix automatique du format de rÃ©ponse appropriÃ©
   - Communication claire du plan d'action avant exÃ©cution

5. **GÃ©nÃ©ration Intelligente de Documentation**
   - Claude Code analyse automatiquement les commandes utilisateur
   - Investigation automatique via les outils Claude Code pour informations pertinentes
   - GÃ©nÃ©ration de contenu structurÃ© avec insertion via UniversalContentPanel
   - Support gÃ©nÃ©ration diagrammes Mermaid et exemples de code
   - Auto-sauvegarde dans la structure documentation existante

6. **Analyse de Code AvancÃ©e**
   - Claude Code explore automatiquement la codebase selon la question
   - Identification automatique des patterns, anti-patterns, et problÃ¨mes potentiels
   - Suggestions d'optimisation et recommandations architecturales
   - Analyse des dÃ©pendances et impact des changements
   - GÃ©nÃ©ration de rapports structurÃ©s avec prioritÃ©s

7. **IntÃ©gration avec UniversalChatPanel**
   - Utilisation du composant de chat universel (Story 1.6.1)
   - Streaming des rÃ©ponses en temps rÃ©el avec affichage progressif
   - Gestion des sessions de chat avec persistance dans Supabase
   - IntÃ©gration seamless avec les API workspaces et documentation existantes
   - **Affichage avancÃ© avec UniversalContentPanel pour le code**
   - **MÃ©tadonnÃ©es Claude Code et Ã©tats d'investigation**

## Tasks / Subtasks

### Phase 1: Configuration Claude Code SDK (AC: 1)
- [ ] Installer et configurer `@instantlyeasy/claude-code-sdk-ts`
- [ ] **Ã‰TENDRE** `lib/services/chatService.ts` avec mÃ©thodes Claude Code SDK
- [ ] Configurer outils Claude Code (Read, Grep, Glob, LS) avec permissions
- [ ] ImplÃ©menter cache investigations et gestion erreurs
- [ ] **Ã‰TENDRE** les types existants dans `src/types/chat/universal.ts`

### Phase 2: Assistant Claude Code UnifiÃ© (AC: 2)
- [ ] **Ã‰TENDRE** le service existant avec `ClaudeCodeAssistant` dans `lib/services/`
- [ ] **RÃ‰UTILISER** l'interface `UniversalChatPanelProps` existante
- [ ] Configurer les outils Claude Code (Read, Grep, Glob, LS) avec permissions
- [ ] **RÃ‰UTILISER** le systÃ¨me de gestion des sessions existant
- [ ] **Ã‰TENDRE** les types TypeScript existants pour l'intÃ©gration Claude Code

### Phase 3: Investigation Autonome (AC: 3)
- [ ] **Ã‰TENDRE** `lib/services/chatService.ts` avec `codebase-analyzer.ts` pour orchestration
- [ ] ImplÃ©menter investigation automatique avec outils Claude Code
- [ ] **RÃ‰UTILISER** le cache existant et l'Ã©tendre pour les investigations
- [ ] **RÃ‰UTILISER** les indicateurs visuels existants (`ClaudeCodeIndicator.tsx`)
- [ ] Optimiser performances pour grandes codebases

### Phase 4: Raisonnement Multi-Ã‰tapes (AC: 4)
- [ ] ImplÃ©menter systÃ¨me de raisonnement Ã©tape par Ã©tape
- [ ] **RÃ‰UTILISER** l'affichage transparent existant (`EnrichedMessage.tsx`)
- [ ] DÃ©velopper sÃ©lecteur automatique de format de rÃ©ponse
- [ ] **RÃ‰UTILISER** les indicateurs visuels existants pour Ã©tats de raisonnement
- [ ] ImplÃ©menter communication du plan d'action

### Phase 5: FonctionnalitÃ©s AvancÃ©es (AC: 5, 6)
- [ ] ImplÃ©menter gÃ©nÃ©ration intelligente de documentation via Claude Code
- [ ] **RÃ‰UTILISER** `UniversalContentPanel` existant pour insertion auto
- [ ] DÃ©velopper analyse avancÃ©e de code avec Claude Code
- [ ] **RÃ‰UTILISER** le support diagrammes Mermaid existant
- [ ] CrÃ©er systÃ¨me de suggestions et recommandations automatiques

### Phase 6: IntÃ©gration et Tests (AC: 7)
- [ ] **RÃ‰UTILISER** UniversalChatPanel existant (Story 1.6.1)
- [ ] **RÃ‰UTILISER** le streaming des rÃ©ponses en temps rÃ©el existant
- [ ] **Ã‰TENDRE** les endpoints API existants pour gestion des agents
- [ ] Tests unitaires et d'intÃ©gration complets

### Phase 7: Affichage AvancÃ© du Chat (AC: 7)
- [ ] **RÃ‰UTILISER** UniversalContentPanel existant pour l'affichage de code âœ…
- [ ] **RÃ‰UTILISER** le systÃ¨me de mÃ©tadonnÃ©es Claude Code existant âœ…
- [ ] **RÃ‰UTILISER** les Ã©tats d'investigation et indicateurs visuels existants âœ…
- [ ] **RÃ‰UTILISER** les messages enrichis existants âœ…
- [ ] **RÃ‰UTILISER** le preview de code Monaco Editor existant âœ…
- [ ] **RÃ‰UTILISER** les indicateurs d'actions Claude Code existants âœ…
- [ ] **RÃ‰UTILISER** les tests d'affichage existants âœ…
- [ ] Documentation utilisation agents pour dÃ©veloppeurs

## Dev Notes

### Architecture Technique

**Structure de Fichiers (Approche d'Extension) :**
```
src/lib/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ chatService.ts                 # âœ… EXISTANT - RÃ‰UTILISER ET Ã‰TENDRE
â”‚   â”œâ”€â”€ claude-code-sdk.ts             # ğŸ†• NOUVEAU - SDK Claude Code
â”‚   â””â”€â”€ claude-code-assistant.ts       # ğŸ†• NOUVEAU - Assistant unifiÃ©
â”œâ”€â”€ types/
â”‚   â””â”€â”€ chat/
â”‚       â””â”€â”€ universal.ts               # âœ… EXISTANT - Ã‰TENDRE avec nouveaux types
â””â”€â”€ utils/
    â””â”€â”€ claude-tools.ts                # ğŸ†• NOUVEAU - Utilitaires pour outils Claude Code
```

**Configuration Claude Code UnifiÃ© :**
```typescript
interface ClaudeCodeConfig {
  model: 'sonnet' | 'opus' | 'haiku';
  tools: ClaudeCodeTool[];
  temperature: number;
  maxTokens: number;
  reasoningSteps: boolean;
  transparencyLevel: 'minimal' | 'detailed' | 'full';
}

interface ClaudeCodeTool {
  name: 'Read' | 'Grep' | 'Glob' | 'LS';
  permissions: string[];
  description: string;
}
```

**Configuration Claude Code UnifiÃ© :**
```typescript
const claudeCodeConfig: ClaudeCodeConfig = {
  model: 'sonnet',
  tools: [
    { name: 'Read', permissions: ['read'], description: 'Lecture de fichiers' },
    { name: 'Grep', permissions: ['search'], description: 'Recherche de patterns' },
    { name: 'Glob', permissions: ['list'], description: 'Exploration de structure' },
    { name: 'LS', permissions: ['list'], description: 'Listage de fichiers' }
  ],
  temperature: 0.3,
  maxTokens: 4000,
  reasoningSteps: true,
  transparencyLevel: 'detailed'
};
```

### Workflow d'Investigation Autonome

**SÃ©quence Typique :**
1. **RÃ©ception de la Question** : L'utilisateur pose une question dans UniversalChatPanel
2. **Analyse Initiale** : L'agent analyse la question et dÃ©termine le plan d'investigation
3. **Communication du Plan** : Affichage du plan d'action Ã  l'utilisateur
4. **Investigation Automatique** :
   - Utilisation de `Glob` pour identifier fichiers pertinents
   - Utilisation de `Grep` pour rechercher patterns spÃ©cifiques
   - Utilisation de `Read` pour analyser le contenu des fichiers
   - Utilisation de `LS` pour explorer la structure
5. **Raisonnement Multi-Ã‰tapes** : Analyse des informations collectÃ©es Ã©tape par Ã©tape
6. **GÃ©nÃ©ration de la RÃ©ponse** : CrÃ©ation de la rÃ©ponse finale avec format appropriÃ©
7. **Affichage Transparent** : Communication de tout le processus Ã  l'utilisateur

**Exemple d'Interaction :**
```
Utilisateur: "Analyse les dÃ©pendances de ce composant"

Agent: "Je vais analyser les dÃ©pendances de ce composant. Voici mon plan :
1. Explorer la structure du fichier sÃ©lectionnÃ©
2. Identifier les imports et dÃ©pendances
3. Analyser les fichiers dÃ©pendants
4. CrÃ©er un diagramme de dÃ©pendances
5. GÃ©nÃ©rer un rapport structurÃ©

[Indicateur: ğŸ” Investigation en cours...]
- Lecture du fichier src/components/UserProfile.tsx
- Recherche des imports dans le projet
- Analyse des composants dÃ©pendants

[Indicateur: ğŸ¤” Analyse en cours...]
- Identification de 5 dÃ©pendances directes
- DÃ©tection de 3 dÃ©pendances circulaires potentielles

[Indicateur: ğŸ“Š GÃ©nÃ©ration en cours...]
- CrÃ©ation du diagramme de dÃ©pendances
- GÃ©nÃ©ration du rapport d'analyse

Voici mon analyse complÃ¨te..."
```

### IntÃ©gration avec Claude Code SDK

**Outils UtilisÃ©s :**
- **Read** : Lecture fichiers avec contexte du workspace
- **Grep** : Recherche patterns pour identifier code pertinent
- **Glob** : Recherche fichiers par patterns (ex: `**/*auth*`, `**/*.config.*`)
- **LS** : Exploration arborescence pour structure projet

**Gestion des Sessions Claude Code :**
```typescript
interface ClaudeCodeSession {
  id: string;
  workspaceId: string;
  context: {
    selectedFile?: string;
    currentDirectory?: string;
    investigationHistory?: InvestigationStep[];
    workspacePath?: string;
  };
  createdAt: Date;
  lastActivity: Date;
  config: ClaudeCodeConfig;
}

interface InvestigationStep {
  tool: string;
  query: string;
  result: any;
  timestamp: Date;
  duration: number;
}
```

### Base de DonnÃ©es

**Tables DÃ©jÃ  Ã‰tendues (Story 1.6.1) :**
```sql
-- âœ… DÃ‰JÃ€ IMPLÃ‰MENTÃ‰ dans Story 1.6.1
-- Extension de chat_sessions pour Claude Code
ALTER TABLE chat_sessions ADD COLUMN claude_session_id text;
ALTER TABLE chat_sessions ADD COLUMN investigation_context jsonb;

-- Extension de chat_messages pour actions Claude Code
ALTER TABLE chat_messages ADD COLUMN claude_actions jsonb;
ALTER TABLE chat_messages ADD COLUMN investigation_steps jsonb;
ALTER TABLE chat_messages ADD COLUMN reasoning_steps jsonb;
```

**Aucune migration supplÃ©mentaire requise** - Les tables sont dÃ©jÃ  configurÃ©es pour supporter Claude Code.

**MÃ©tadonnÃ©es des Messages Claude Code :**
```typescript
interface ClaudeCodeMessageMetadata {
  claudeActions?: string[];
  investigationSteps?: InvestigationStep[];
  reasoningSteps?: ReasoningStep[];
  filesAnalyzed?: string[];
  toolsUsed?: string[];
  workspacePath?: string;
}
```

### Testing

**Tests Requis :**
- Tests unitaires pour chaque agent et service
- Tests d'intÃ©gration pour les workflows complets
- Tests de performance avec grandes codebases
- Tests de rÃ©gression pour la cohÃ©rence des agents
- Tests E2E pour les interactions utilisateur

**Fichiers de Test :**
```
src/lib/services/__tests__/
â”œâ”€â”€ claude-code-assistant.test.ts
â”œâ”€â”€ claude-session-manager.test.ts
â””â”€â”€ documentation-generator.test.ts

e2e/
â”œâ”€â”€ claude-code-investigation-flow.spec.ts
â”œâ”€â”€ documentation-generation.spec.ts
â””â”€â”€ code-analysis-workflow.spec.ts
```

## Dependencies et PrÃ©requis
- **CRITIQUE :** Story 1.6.1 doit Ãªtre terminÃ©e (composant de chat universel)
- Story 1.5.2 doit Ãªtre complÃ¨tement terminÃ©e (composants universels)
- âœ… **Tables Supabase chat_sessions et chat_messages Ã©tendues avec support Claude Code**
- âœ… **Script SQL d'extension implÃ©mentÃ© et validÃ©**
- Configuration Claude Code SDK et API keys

## StratÃ©gie d'ImplÃ©mentation

**Ordre de DÃ©veloppement (Approche d'Extension) :**
1. **Claude Code SDK** : Configuration et extension du service existant
2. **Types Ã‰tendus** : Ajout des nouveaux types aux interfaces existantes
3. **Investigation Autonome** : Extension des hooks existants avec outils Claude Code
4. **Raisonnement Multi-Ã‰tapes** : IntÃ©gration dans les composants existants
5. **Services SpÃ©cialisÃ©s** : Extension du service existant avec nouvelles fonctionnalitÃ©s
6. **IntÃ©gration** : RÃ©utilisation d'UniversalChatPanel existant

**Avantages de cette Approche d'Extension :**
- **Aucune duplication** de logique existante
- **RÃ©utilisation complÃ¨te** des composants et services de la Story 1.6.1
- **CohÃ©rence** avec l'architecture existante
- **Maintenance simplifiÃ©e** - un seul point de vÃ©ritÃ©
- **Performance optimisÃ©e** - pas de re-crÃ©ation de composants
- **Tests existants** rÃ©utilisables et Ã©tendus
- **Interface utilisateur** cohÃ©rente et familiÃ¨re

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | CrÃ©ation initiale de la story 1.6.2 | Sarah (PO) |
| 2024-12-19 | 1.1 | âœ… Script SQL d'extension Claude Code implÃ©mentÃ© et validÃ© | Sarah (PO) |

## Dev Agent Record
*Section Ã  remplir par l'agent de dÃ©veloppement lors de l'implÃ©mentation*
