# Story 1.6.2: Agents Intelligents avec Claude Code SDK

## Status
Draft (D√©pend de Story 1.6.1) - **SQL Database Ready** ‚úÖ

## Story
**As a** Gardien du Contexte (Tech Lead/CTO),
**I want** un assistant Claude Code intelligent qui peut investiguer automatiquement ma base de code et raisonner de mani√®re autonome en plusieurs √©tapes,
**so that** je puisse obtenir des r√©ponses pr√©cises sur mon code, g√©n√©rer de la documentation automatiquement, et b√©n√©ficier d'un assistant de d√©veloppement intelligent qui affiche son raisonnement de mani√®re transparente.

## Acceptance Criteria

1. **Int√©gration Claude Code SDK**
   - Installation et configuration de `@instantlyeasy/claude-code-sdk-ts`
   - Service centralis√© pour la gestion des sessions Claude
   - Configuration des outils Claude Code (Read, Grep, Glob, LS) avec permissions
   - Gestion des erreurs et retry automatique pour les appels API

2. **Assistant Claude Code Unifi√©**
   - Int√©gration directe avec Claude Code SDK sans agents configurables
   - Claude Code g√®re automatiquement l'exploration et l'analyse selon la question
   - Pas de configuration YAML/JSON complexe - tout fonctionne avec des questions naturelles
   - Interface unifi√©e pour tous les types d'interactions (analyse, documentation, etc.)

3. **Investigation Autonome de la Base de Code**
   - L'agent peut rechercher automatiquement dans la codebase sans intervention utilisateur
   - Utilisation des outils Claude Code pour exploration (Read, Grep, Glob, LS)
   - Identification automatique des d√©pendances et relations entre composants
   - Cache des investigations pour optimiser les performances
   - Affichage transparent des actions d'investigation entreprises

4. **Raisonnement Multi-√âtapes et Transparence**
   - L'agent peut raisonner de mani√®re autonome en plusieurs √©tapes
   - Affichage du processus de raisonnement √©tape par √©tape
   - Indicateurs visuels pour les actions en cours (investigation, analyse, g√©n√©ration)
   - Choix automatique du format de r√©ponse appropri√©
   - Communication claire du plan d'action avant ex√©cution

5. **G√©n√©ration Intelligente de Documentation**
   - Claude Code analyse automatiquement les commandes utilisateur
   - Investigation automatique via les outils Claude Code pour informations pertinentes
   - G√©n√©ration de contenu structur√© avec insertion via UniversalContentPanel
   - Support g√©n√©ration diagrammes Mermaid et exemples de code
   - Auto-sauvegarde dans la structure documentation existante

6. **Analyse de Code Avanc√©e**
   - Claude Code explore automatiquement la codebase selon la question
   - Identification automatique des patterns, anti-patterns, et probl√®mes potentiels
   - Suggestions d'optimisation et recommandations architecturales
   - Analyse des d√©pendances et impact des changements
   - G√©n√©ration de rapports structur√©s avec priorit√©s

7. **Int√©gration avec UniversalChatPanel**
   - Utilisation du composant de chat universel (Story 1.6.1)
   - Streaming des r√©ponses en temps r√©el avec affichage progressif
   - Gestion des sessions de chat avec persistance dans Supabase
   - Int√©gration seamless avec les API workspaces et documentation existantes

## Tasks / Subtasks

### Phase 1: Configuration Claude Code SDK (AC: 1)
- [ ] Installer et configurer `@instantlyeasy/claude-code-sdk-ts`
- [ ] Cr√©er `lib/services/claude-service.ts` avec gestion sessions et mod√®les
- [ ] Configurer outils Claude Code (Read, Grep, Glob, LS) avec permissions
- [ ] Impl√©menter cache investigations et gestion erreurs
- [ ] Cr√©er les types TypeScript pour l'int√©gration Claude Code

### Phase 2: Assistant Claude Code Unifi√© (AC: 2)
- [ ] Cr√©er service unifi√© `ClaudeCodeAssistant` dans `lib/services/`
- [ ] Impl√©menter interface simple pour les interactions avec Claude Code
- [ ] Configurer les outils Claude Code (Read, Grep, Glob, LS) avec permissions
- [ ] D√©velopper syst√®me de gestion des sessions Claude Code
- [ ] Cr√©er types TypeScript pour l'int√©gration Claude Code

### Phase 3: Investigation Autonome (AC: 3)
- [ ] Cr√©er `lib/services/codebase-analyzer.ts` pour orchestration
- [ ] Impl√©menter investigation automatique avec outils Claude Code
- [ ] D√©velopper cache intelligent pour les investigations
- [ ] Cr√©er indicateurs visuels pour actions d'investigation
- [ ] Optimiser performances pour grandes codebases

### Phase 4: Raisonnement Multi-√âtapes (AC: 4)
- [ ] Impl√©menter syst√®me de raisonnement √©tape par √©tape
- [ ] Cr√©er affichage transparent du processus de pens√©e
- [ ] D√©velopper s√©lecteur automatique de format de r√©ponse
- [ ] Ajouter indicateurs visuels pour √©tats de raisonnement
- [ ] Impl√©menter communication du plan d'action

### Phase 5: Fonctionnalit√©s Avanc√©es (AC: 5, 6)
- [ ] Impl√©menter g√©n√©ration intelligente de documentation via Claude Code
- [ ] Cr√©er `DocumentationGenerator` pour insertion auto via UniversalContentPanel
- [ ] D√©velopper analyse avanc√©e de code avec Claude Code
- [ ] Ajouter support diagrammes Mermaid et exemples code
- [ ] Cr√©er syst√®me de suggestions et recommandations automatiques

### Phase 6: Int√©gration et Tests (AC: 7)
- [ ] Int√©grer agents avec UniversalChatPanel (Story 1.6.1)
- [ ] Impl√©menter streaming des r√©ponses en temps r√©el
- [ ] Cr√©er endpoints API pour gestion des agents
- [ ] Tests unitaires et d'int√©gration complets
- [ ] Documentation utilisation agents pour d√©veloppeurs

## Dev Notes

### Architecture Technique

**Structure de Fichiers :**
```
src/lib/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ claude-code-assistant.ts       # Service principal Claude Code unifi√©
‚îÇ   ‚îú‚îÄ‚îÄ claude-session-manager.ts      # Gestion des sessions Claude Code
‚îÇ   ‚îî‚îÄ‚îÄ documentation-generator.ts     # G√©n√©ration via UniversalContentPanel
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îú‚îÄ‚îÄ claude-code.ts                 # Types pour Claude Code SDK
‚îÇ   ‚îî‚îÄ‚îÄ claude-session.ts              # Types pour sessions Claude Code
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ claude-tools.ts                # Utilitaires pour outils Claude Code
```

**Configuration Claude Code Unifi√© :**
```typescript
interface ClaudeCodeConfig {
  model: 'sonnet' | 'opus' | 'haiku';
  tools: ClaudeCodeTool[];
  temperature: number;
  maxTokens: number;
  reasoningSteps: boolean;
  transparencyLevel: 'minimal' | 'detailed' | 'full';
}

interface ClaudeCodeTool {
  name: 'Read' | 'Grep' | 'Glob' | 'LS';
  permissions: string[];
  description: string;
}
```

**Configuration Claude Code Unifi√© :**
```typescript
const claudeCodeConfig: ClaudeCodeConfig = {
  model: 'sonnet',
  tools: [
    { name: 'Read', permissions: ['read'], description: 'Lecture de fichiers' },
    { name: 'Grep', permissions: ['search'], description: 'Recherche de patterns' },
    { name: 'Glob', permissions: ['list'], description: 'Exploration de structure' },
    { name: 'LS', permissions: ['list'], description: 'Listage de fichiers' }
  ],
  temperature: 0.3,
  maxTokens: 4000,
  reasoningSteps: true,
  transparencyLevel: 'detailed'
};
```

### Workflow d'Investigation Autonome

**S√©quence Typique :**
1. **R√©ception de la Question** : L'utilisateur pose une question dans UniversalChatPanel
2. **Analyse Initiale** : L'agent analyse la question et d√©termine le plan d'investigation
3. **Communication du Plan** : Affichage du plan d'action √† l'utilisateur
4. **Investigation Automatique** :
   - Utilisation de `Glob` pour identifier fichiers pertinents
   - Utilisation de `Grep` pour rechercher patterns sp√©cifiques
   - Utilisation de `Read` pour analyser le contenu des fichiers
   - Utilisation de `LS` pour explorer la structure
5. **Raisonnement Multi-√âtapes** : Analyse des informations collect√©es √©tape par √©tape
6. **G√©n√©ration de la R√©ponse** : Cr√©ation de la r√©ponse finale avec format appropri√©
7. **Affichage Transparent** : Communication de tout le processus √† l'utilisateur

**Exemple d'Interaction :**
```
Utilisateur: "Analyse les d√©pendances de ce composant"

Agent: "Je vais analyser les d√©pendances de ce composant. Voici mon plan :
1. Explorer la structure du fichier s√©lectionn√©
2. Identifier les imports et d√©pendances
3. Analyser les fichiers d√©pendants
4. Cr√©er un diagramme de d√©pendances
5. G√©n√©rer un rapport structur√©

[Indicateur: üîç Investigation en cours...]
- Lecture du fichier src/components/UserProfile.tsx
- Recherche des imports dans le projet
- Analyse des composants d√©pendants

[Indicateur: ü§î Analyse en cours...]
- Identification de 5 d√©pendances directes
- D√©tection de 3 d√©pendances circulaires potentielles

[Indicateur: üìä G√©n√©ration en cours...]
- Cr√©ation du diagramme de d√©pendances
- G√©n√©ration du rapport d'analyse

Voici mon analyse compl√®te..."
```

### Int√©gration avec Claude Code SDK

**Outils Utilis√©s :**
- **Read** : Lecture fichiers avec contexte du workspace
- **Grep** : Recherche patterns pour identifier code pertinent
- **Glob** : Recherche fichiers par patterns (ex: `**/*auth*`, `**/*.config.*`)
- **LS** : Exploration arborescence pour structure projet

**Gestion des Sessions Claude Code :**
```typescript
interface ClaudeCodeSession {
  id: string;
  workspaceId: string;
  context: {
    selectedFile?: string;
    currentDirectory?: string;
    investigationHistory?: InvestigationStep[];
    workspacePath?: string;
  };
  createdAt: Date;
  lastActivity: Date;
  config: ClaudeCodeConfig;
}

interface InvestigationStep {
  tool: string;
  query: string;
  result: any;
  timestamp: Date;
  duration: number;
}
```

### Base de Donn√©es

**Extensions Tables Existantes :**
```sql
-- Extension de chat_sessions pour Claude Code
ALTER TABLE chat_sessions ADD COLUMN claude_session_id text;
ALTER TABLE chat_sessions ADD COLUMN investigation_context jsonb;

-- Extension de chat_messages pour actions Claude Code
ALTER TABLE chat_messages ADD COLUMN claude_actions jsonb;
ALTER TABLE chat_messages ADD COLUMN investigation_steps jsonb;
ALTER TABLE chat_messages ADD COLUMN reasoning_steps jsonb;
```

**M√©tadonn√©es des Messages Claude Code :**
```typescript
interface ClaudeCodeMessageMetadata {
  claudeActions?: string[];
  investigationSteps?: InvestigationStep[];
  reasoningSteps?: ReasoningStep[];
  filesAnalyzed?: string[];
  toolsUsed?: string[];
  workspacePath?: string;
}
```

### Testing

**Tests Requis :**
- Tests unitaires pour chaque agent et service
- Tests d'int√©gration pour les workflows complets
- Tests de performance avec grandes codebases
- Tests de r√©gression pour la coh√©rence des agents
- Tests E2E pour les interactions utilisateur

**Fichiers de Test :**
```
src/lib/services/__tests__/
‚îú‚îÄ‚îÄ claude-code-assistant.test.ts
‚îú‚îÄ‚îÄ claude-session-manager.test.ts
‚îî‚îÄ‚îÄ documentation-generator.test.ts

e2e/
‚îú‚îÄ‚îÄ claude-code-investigation-flow.spec.ts
‚îú‚îÄ‚îÄ documentation-generation.spec.ts
‚îî‚îÄ‚îÄ code-analysis-workflow.spec.ts
```

## Dependencies et Pr√©requis
- **CRITIQUE :** Story 1.6.1 doit √™tre termin√©e (composant de chat universel)
- Story 1.5.2 doit √™tre compl√®tement termin√©e (composants universels)
- ‚úÖ **Tables Supabase chat_sessions et chat_messages √©tendues avec support Claude Code**
- ‚úÖ **Script SQL d'extension impl√©ment√© et valid√©**
- Configuration Claude Code SDK et API keys

## Strat√©gie d'Impl√©mentation

**Ordre de D√©veloppement :**
1. **Claude Code SDK** : Configuration et services de base
2. **Architecture Agents** : Structure modulaire et types
3. **Investigation Autonome** : Outils et orchestration
4. **Raisonnement Multi-√âtapes** : Transparence et processus
5. **Agents Sp√©cialis√©s** : Analysis et Documentation
6. **Int√©gration** : UniversalChatPanel et tests

**Avantages de cette Approche :**
- Assistant Claude Code unifi√© et simple √† utiliser
- Transparence totale du processus de pens√©e
- Investigation automatique sans intervention utilisateur
- Pas de configuration complexe - tout fonctionne avec des questions naturelles
- Performance optimis√©e avec cache intelligent
- R√©utilisabilit√© pour diff√©rentes pages de l'application

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Cr√©ation initiale de la story 1.6.2 | Sarah (PO) |
| 2024-12-19 | 1.1 | ‚úÖ Script SQL d'extension Claude Code impl√©ment√© et valid√© | Sarah (PO) |

## Dev Agent Record
*Section √† remplir par l'agent de d√©veloppement lors de l'impl√©mentation*
