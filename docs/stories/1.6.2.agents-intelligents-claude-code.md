# Story 1.6.2: Agents Intelligents avec Claude Code SDK

## Status
Draft (Dépend de Story 1.6.1) - **SQL Database Ready** ✅

## 🚨 CRITIQUE : FONDATIONS DE LA STORY 1.6.1 À UTILISER

**ATTENTION :** Cette story doit IMPÉRATIVEMENT utiliser les composants et services déjà construits dans la Story 1.6.1. Ne pas recréer de logique dupliquée.

### 📋 Composants et Services Disponibles (Story 1.6.1)

#### 1. **Types et Interfaces TypeScript** ✅
**Fichier :** `src/types/chat/universal.ts`
- **`UniversalChatPanelProps`** : Interface complète pour la configuration du chat
- **`ChatMessage`** : Structure des messages avec métadonnées Claude Code
- **`ChatSession`** : Gestion des sessions avec contexte Claude Code
- **`ClaudeCodeContext`** : Contexte d'investigation et workspace
- **`InvestigationStep`** : Étapes d'investigation avec outils utilisés
- **`ReasoningStep`** : Étapes de raisonnement multi-étapes
- **`InvestigationResult`** : Résultats d'investigation structurés

#### 2. **Composants UI Universels** ✅
**Dossier :** `src/components/universal/chat/`
- **`UniversalChatPanel.tsx`** : Composant principal avec streaming et onglets
- **`Message.tsx`** : Affichage de messages avec métadonnées Claude Code
- **`MessageList.tsx`** : Liste avec auto-scroll et gestion d'état
- **`MessageInput.tsx`** : Zone de saisie avec support markdown
- **`ChatHeader.tsx`** : En-tête avec statut et informations session
- **`ChatControls.tsx`** : Contrôles (clear, export, settings)
- **`EnrichedMessage.tsx`** : Messages enrichis avec preview de code
- **`ClaudeCodeIndicator.tsx`** : Indicateurs visuels pour actions Claude Code

#### 3. **Hooks et Gestion d'État** ✅
**Dossier :** `src/hooks/`
- **`useChatSession.ts`** : Gestion complète des sessions Claude Code
- **`useChatMessages.ts`** : Gestion des messages avec persistance
- **`useChatTabs.ts`** : Gestion des onglets de conversation

#### 4. **Services Backend** ✅
**Fichier :** `src/lib/services/chatService.ts`
- **API Routes** : `/api/workspaces/[id]/chat/sessions` et `/chat/message`
- **Persistance Supabase** : Tables `chat_sessions` et `chat_messages` étendues
- **Streaming** : Support des réponses Claude Code en temps réel
- **Gestion d'erreurs** : Retry automatique et états d'erreur

#### 5. **Base de Données Étendue** ✅
**Tables Supabase déjà configurées :**
```sql
-- chat_sessions étendue avec support Claude Code
ALTER TABLE chat_sessions ADD COLUMN title TEXT DEFAULT 'Nouvelle conversation';
ALTER TABLE chat_sessions ADD COLUMN tab_order INTEGER DEFAULT 0;
ALTER TABLE chat_sessions ADD COLUMN is_active BOOLEAN DEFAULT false;
ALTER TABLE chat_sessions ADD COLUMN is_dirty BOOLEAN DEFAULT false;
ALTER TABLE chat_sessions ADD COLUMN claude_session_id text;
ALTER TABLE chat_sessions ADD COLUMN investigation_context jsonb;

-- chat_messages étendue avec métadonnées Claude Code
ALTER TABLE chat_messages ADD COLUMN claude_actions jsonb;
ALTER TABLE chat_messages ADD COLUMN investigation_steps jsonb;
ALTER TABLE chat_messages ADD COLUMN reasoning_steps jsonb;
```

#### 6. **Fonctionnalités Avancées** ✅
- **Interface Cursor-style** : Onglets, bulles utilisateur, flux libre agent
- **Gestion des onglets** : Sessions multiples avec persistance
- **Preview de code** : Monaco Editor intégré pour l'affichage de code
- **Métadonnées Claude Code** : Outils utilisés, fichiers analysés, investigations
- **États d'investigation** : Indicateurs visuels pour actions en cours
- **Streaming temps réel** : Réponses progressives avec indicateurs

### 🎯 Comment Utiliser les Fondations (Story 1.6.2)

#### 1. **INTÉGRATION OBLIGATOIRE**
```typescript
// UTILISER le composant existant, ne pas recréer
import { UniversalChatPanel } from '@/components/universal/UniversalChatPanel';

// UTILISER les types existants, ne pas redéfinir
import { 
  ChatMessage, 
  ClaudeCodeContext, 
  InvestigationStep 
} from '@/types/chat/universal';

// UTILISER les hooks existants, ne pas recréer
import { useChatSession, useChatMessages } from '@/hooks/useChatSession';
```

#### 2. **SERVICES À ÉTENDRE, PAS À RECRÉER**
```typescript
// ÉTENDRE le service existant, ne pas créer un nouveau
import { chatService } from '@/lib/services/chatService';

// Ajouter les méthodes Claude Code au service existant
export const claudeCodeService = {
  // NOUVELLES méthodes pour Claude Code SDK
  async investigateCodebase(query: string, context: ClaudeCodeContext) {
    // Utiliser les outils Claude Code SDK
  },
  
  // RÉUTILISER les méthodes existantes
  createSession: chatService.createSession,
  addMessage: chatService.addMessage,
  getMessages: chatService.getMessages
};
```

#### 3. **COMPOSANTS À ENRICHIR, PAS À DUPLIQUER**
```typescript
// ENRICHIR le composant existant avec de nouvelles props
interface ClaudeCodeChatPanelProps extends UniversalChatPanelProps {
  // NOUVELLES props spécifiques à Claude Code
  claudeCodeConfig?: ClaudeCodeConfig;
  onInvestigationStart?: (query: string) => void;
  onInvestigationComplete?: (results: InvestigationResult[]) => void;
}

// UTILISER le composant de base et ajouter les fonctionnalités
export const ClaudeCodeChatPanel = (props: ClaudeCodeChatPanelProps) => {
  // RÉUTILISER la logique existante
  const { messages, sendMessage } = useChatMessages(props.sessionId);
  
  // AJOUTER la logique Claude Code spécifique
  const { investigateCodebase } = useClaudeCodeInvestigation();
  
  return (
    <UniversalChatPanel
      {...props}
      onMessageSent={async (message) => {
        // Logique Claude Code + logique existante
        await sendMessage(message);
        await investigateCodebase(message.content);
      }}
    />
  );
};
```

#### 4. **TYPES À ÉTENDRE, PAS À REDÉFINIR**
```typescript
// ÉTENDRE les types existants dans le même fichier
// src/types/chat/universal.ts

// AJOUTER les nouveaux types pour Claude Code SDK
interface ClaudeCodeTool {
  name: 'Read' | 'Grep' | 'Glob' | 'LS';
  permissions: string[];
  description: string;
}

interface ClaudeCodeConfig {
  model: 'sonnet' | 'opus' | 'haiku';
  tools: ClaudeCodeTool[];
  temperature: number;
  maxTokens: number;
  reasoningSteps: boolean;
}

// RÉUTILISER les types existants
interface ChatMessage {
  // ... types existants ...
  metadata?: {
    // ... métadonnées existantes ...
    // AJOUTER les nouvelles métadonnées Claude Code
    claudeCodeActions?: ClaudeCodeAction[];
    investigationResults?: InvestigationResult[];
  };
}
```

### 🚫 CE QU'IL NE FAUT PAS FAIRE

#### ❌ **NE PAS RECRÉER :**
- Composants de chat (UniversalChatPanel, Message, MessageList, etc.)
- Hooks de gestion d'état (useChatSession, useChatMessages, useChatTabs)
- Services de persistance (chatService)
- Types de base (ChatMessage, ChatSession, ClaudeCodeContext)
- Tables de base de données (chat_sessions, chat_messages)
- Interface utilisateur (onglets, bulles, streaming)

#### ❌ **NE PAS DUPLIQUER :**
- Logique de gestion des sessions
- Logique de persistance Supabase
- Logique de streaming des réponses
- Logique de gestion des onglets
- Logique d'affichage des messages
- Logique de gestion d'erreurs

### ✅ **CE QU'IL FAUT FAIRE :**

#### ✅ **EXTENDRE ET ENRICHIR :**
- Ajouter les méthodes Claude Code SDK au service existant
- Étendre les types avec les nouvelles métadonnées Claude Code
- Enrichir le composant UniversalChatPanel avec les nouvelles props
- Ajouter les hooks spécifiques à Claude Code
- Créer les nouveaux composants d'affichage pour les résultats d'investigation

#### ✅ **INTÉGRER ET CONNECTER :**
- Connecter le Claude Code SDK aux composants existants
- Utiliser les callbacks existants pour les nouvelles fonctionnalités
- Réutiliser la logique de streaming pour les réponses Claude Code
- Intégrer les métadonnées Claude Code dans les messages existants

### 📁 Structure de Fichiers Recommandée

```
src/
├── lib/
│   └── services/
│       ├── chatService.ts              # ✅ EXISTANT - RÉUTILISER
│       ├── claude-code-sdk.ts          # 🆕 NOUVEAU - SDK Claude Code
│       └── claude-code-assistant.ts    # 🆕 NOUVEAU - Assistant unifié
├── hooks/
│   ├── useChatSession.ts               # ✅ EXISTANT - RÉUTILISER
│   ├── useChatMessages.ts              # ✅ EXISTANT - RÉUTILISER
│   ├── useChatTabs.ts                  # ✅ EXISTANT - RÉUTILISER
│   └── useClaudeCodeInvestigation.ts   # 🆕 NOUVEAU - Investigation Claude Code
├── components/
│   └── universal/
│       ├── UniversalChatPanel.tsx      # ✅ EXISTANT - ENRICHIR
│       └── chat/                       # ✅ EXISTANT - RÉUTILISER
└── types/
    └── chat/
        └── universal.ts                # ✅ EXISTANT - ÉTENDRE
```

### 🎯 Objectif de la Story 1.6.2

**Transformer l'UniversalChatPanel existant en assistant Claude Code intelligent** en :
1. **Connectant** le Claude Code SDK aux composants existants
2. **Enrichissant** les types avec les métadonnées d'investigation
3. **Ajoutant** les hooks pour l'investigation autonome
4. **Créant** les services pour l'orchestration Claude Code
5. **Intégrant** le raisonnement multi-étapes dans l'interface existante

**RÉSULTAT :** Un assistant Claude Code complet qui utilise toutes les fondations de la Story 1.6.1 sans duplication.

## Story
**As a** Gardien du Contexte (Tech Lead/CTO),
**I want** un assistant Claude Code intelligent qui peut investiguer automatiquement ma base de code et raisonner de manière autonome en plusieurs étapes,
**so that** je puisse obtenir des réponses précises sur mon code, générer de la documentation automatiquement, et bénéficier d'un assistant de développement intelligent qui affiche son raisonnement de manière transparente.

## Acceptance Criteria

1. **Intégration Claude Code SDK**
   - Installation et configuration de `@instantlyeasy/claude-code-sdk-ts`
   - Service centralisé pour la gestion des sessions Claude
   - Configuration des outils Claude Code (Read, Grep, Glob, LS) avec permissions
   - Gestion des erreurs et retry automatique pour les appels API

2. **Assistant Claude Code Unifié**
   - Intégration directe avec Claude Code SDK sans agents configurables
   - Claude Code gère automatiquement l'exploration et l'analyse selon la question
   - Pas de configuration YAML/JSON complexe - tout fonctionne avec des questions naturelles
   - Interface unifiée pour tous les types d'interactions (analyse, documentation, etc.)

3. **Investigation Autonome de la Base de Code**
   - L'agent peut rechercher automatiquement dans la codebase sans intervention utilisateur
   - Utilisation des outils Claude Code pour exploration (Read, Grep, Glob, LS)
   - Identification automatique des dépendances et relations entre composants
   - Cache des investigations pour optimiser les performances
   - Affichage transparent des actions d'investigation entreprises

4. **Raisonnement Multi-Étapes et Transparence**
   - L'agent peut raisonner de manière autonome en plusieurs étapes
   - Affichage du processus de raisonnement étape par étape
   - Indicateurs visuels pour les actions en cours (investigation, analyse, génération)
   - Choix automatique du format de réponse approprié
   - Communication claire du plan d'action avant exécution

5. **Génération Intelligente de Documentation**
   - Claude Code analyse automatiquement les commandes utilisateur
   - Investigation automatique via les outils Claude Code pour informations pertinentes
   - Génération de contenu structuré avec insertion via UniversalContentPanel
   - Support génération diagrammes Mermaid et exemples de code
   - Auto-sauvegarde dans la structure documentation existante

6. **Analyse de Code Avancée**
   - Claude Code explore automatiquement la codebase selon la question
   - Identification automatique des patterns, anti-patterns, et problèmes potentiels
   - Suggestions d'optimisation et recommandations architecturales
   - Analyse des dépendances et impact des changements
   - Génération de rapports structurés avec priorités

7. **Intégration avec UniversalChatPanel**
   - Utilisation du composant de chat universel (Story 1.6.1)
   - Streaming des réponses en temps réel avec affichage progressif
   - Gestion des sessions de chat avec persistance dans Supabase
   - Intégration seamless avec les API workspaces et documentation existantes
   - **Affichage avancé avec UniversalContentPanel pour le code**
   - **Métadonnées Claude Code et états d'investigation**

## Tasks / Subtasks

### Phase 1: Configuration Claude Code SDK (AC: 1)
- [ ] Installer et configurer `@instantlyeasy/claude-code-sdk-ts`
- [ ] **ÉTENDRE** `lib/services/chatService.ts` avec méthodes Claude Code SDK
- [ ] Configurer outils Claude Code (Read, Grep, Glob, LS) avec permissions
- [ ] Implémenter cache investigations et gestion erreurs
- [ ] **ÉTENDRE** les types existants dans `src/types/chat/universal.ts`

### Phase 2: Assistant Claude Code Unifié (AC: 2)
- [ ] **ÉTENDRE** le service existant avec `ClaudeCodeAssistant` dans `lib/services/`
- [ ] **RÉUTILISER** l'interface `UniversalChatPanelProps` existante
- [ ] Configurer les outils Claude Code (Read, Grep, Glob, LS) avec permissions
- [ ] **RÉUTILISER** le système de gestion des sessions existant
- [ ] **ÉTENDRE** les types TypeScript existants pour l'intégration Claude Code

### Phase 3: Investigation Autonome (AC: 3)
- [ ] **ÉTENDRE** `lib/services/chatService.ts` avec `codebase-analyzer.ts` pour orchestration
- [ ] Implémenter investigation automatique avec outils Claude Code
- [ ] **RÉUTILISER** le cache existant et l'étendre pour les investigations
- [ ] **RÉUTILISER** les indicateurs visuels existants (`ClaudeCodeIndicator.tsx`)
- [ ] Optimiser performances pour grandes codebases

### Phase 4: Raisonnement Multi-Étapes (AC: 4)
- [ ] Implémenter système de raisonnement étape par étape
- [ ] **RÉUTILISER** l'affichage transparent existant (`EnrichedMessage.tsx`)
- [ ] Développer sélecteur automatique de format de réponse
- [ ] **RÉUTILISER** les indicateurs visuels existants pour états de raisonnement
- [ ] Implémenter communication du plan d'action

### Phase 5: Fonctionnalités Avancées (AC: 5, 6)
- [ ] Implémenter génération intelligente de documentation via Claude Code
- [ ] **RÉUTILISER** `UniversalContentPanel` existant pour insertion auto
- [ ] Développer analyse avancée de code avec Claude Code
- [ ] **RÉUTILISER** le support diagrammes Mermaid existant
- [ ] Créer système de suggestions et recommandations automatiques

### Phase 6: Intégration et Tests (AC: 7)
- [ ] **RÉUTILISER** UniversalChatPanel existant (Story 1.6.1)
- [ ] **RÉUTILISER** le streaming des réponses en temps réel existant
- [ ] **ÉTENDRE** les endpoints API existants pour gestion des agents
- [ ] Tests unitaires et d'intégration complets

### Phase 7: Affichage Avancé du Chat (AC: 7)
- [ ] **RÉUTILISER** UniversalContentPanel existant pour l'affichage de code ✅
- [ ] **RÉUTILISER** le système de métadonnées Claude Code existant ✅
- [ ] **RÉUTILISER** les états d'investigation et indicateurs visuels existants ✅
- [ ] **RÉUTILISER** les messages enrichis existants ✅
- [ ] **RÉUTILISER** le preview de code Monaco Editor existant ✅
- [ ] **RÉUTILISER** les indicateurs d'actions Claude Code existants ✅
- [ ] **RÉUTILISER** les tests d'affichage existants ✅
- [ ] Documentation utilisation agents pour développeurs

## Dev Notes

### Architecture Technique

**Structure de Fichiers (Approche d'Extension) :**
```
src/lib/
├── services/
│   ├── chatService.ts                 # ✅ EXISTANT - RÉUTILISER ET ÉTENDRE
│   ├── claude-code-sdk.ts             # 🆕 NOUVEAU - SDK Claude Code
│   └── claude-code-assistant.ts       # 🆕 NOUVEAU - Assistant unifié
├── types/
│   └── chat/
│       └── universal.ts               # ✅ EXISTANT - ÉTENDRE avec nouveaux types
└── utils/
    └── claude-tools.ts                # 🆕 NOUVEAU - Utilitaires pour outils Claude Code
```

**Configuration Claude Code Unifié :**
```typescript
interface ClaudeCodeConfig {
  model: 'sonnet' | 'opus' | 'haiku';
  tools: ClaudeCodeTool[];
  temperature: number;
  maxTokens: number;
  reasoningSteps: boolean;
  transparencyLevel: 'minimal' | 'detailed' | 'full';
}

interface ClaudeCodeTool {
  name: 'Read' | 'Grep' | 'Glob' | 'LS';
  permissions: string[];
  description: string;
}
```

**Configuration Claude Code Unifié :**
```typescript
const claudeCodeConfig: ClaudeCodeConfig = {
  model: 'sonnet',
  tools: [
    { name: 'Read', permissions: ['read'], description: 'Lecture de fichiers' },
    { name: 'Grep', permissions: ['search'], description: 'Recherche de patterns' },
    { name: 'Glob', permissions: ['list'], description: 'Exploration de structure' },
    { name: 'LS', permissions: ['list'], description: 'Listage de fichiers' }
  ],
  temperature: 0.3,
  maxTokens: 4000,
  reasoningSteps: true,
  transparencyLevel: 'detailed'
};
```

### Workflow d'Investigation Autonome

**Séquence Typique :**
1. **Réception de la Question** : L'utilisateur pose une question dans UniversalChatPanel
2. **Analyse Initiale** : L'agent analyse la question et détermine le plan d'investigation
3. **Communication du Plan** : Affichage du plan d'action à l'utilisateur
4. **Investigation Automatique** :
   - Utilisation de `Glob` pour identifier fichiers pertinents
   - Utilisation de `Grep` pour rechercher patterns spécifiques
   - Utilisation de `Read` pour analyser le contenu des fichiers
   - Utilisation de `LS` pour explorer la structure
5. **Raisonnement Multi-Étapes** : Analyse des informations collectées étape par étape
6. **Génération de la Réponse** : Création de la réponse finale avec format approprié
7. **Affichage Transparent** : Communication de tout le processus à l'utilisateur

**Exemple d'Interaction :**
```
Utilisateur: "Analyse les dépendances de ce composant"

Agent: "Je vais analyser les dépendances de ce composant. Voici mon plan :
1. Explorer la structure du fichier sélectionné
2. Identifier les imports et dépendances
3. Analyser les fichiers dépendants
4. Créer un diagramme de dépendances
5. Générer un rapport structuré

[Indicateur: 🔍 Investigation en cours...]
- Lecture du fichier src/components/UserProfile.tsx
- Recherche des imports dans le projet
- Analyse des composants dépendants

[Indicateur: 🤔 Analyse en cours...]
- Identification de 5 dépendances directes
- Détection de 3 dépendances circulaires potentielles

[Indicateur: 📊 Génération en cours...]
- Création du diagramme de dépendances
- Génération du rapport d'analyse

Voici mon analyse complète..."
```

### Intégration avec Claude Code SDK

**Outils Utilisés :**
- **Read** : Lecture fichiers avec contexte du workspace
- **Grep** : Recherche patterns pour identifier code pertinent
- **Glob** : Recherche fichiers par patterns (ex: `**/*auth*`, `**/*.config.*`)
- **LS** : Exploration arborescence pour structure projet

**Gestion des Sessions Claude Code :**
```typescript
interface ClaudeCodeSession {
  id: string;
  workspaceId: string;
  context: {
    selectedFile?: string;
    currentDirectory?: string;
    investigationHistory?: InvestigationStep[];
    workspacePath?: string;
  };
  createdAt: Date;
  lastActivity: Date;
  config: ClaudeCodeConfig;
}

interface InvestigationStep {
  tool: string;
  query: string;
  result: any;
  timestamp: Date;
  duration: number;
}
```

### Base de Données

**Tables Déjà Étendues (Story 1.6.1) :**
```sql
-- ✅ DÉJÀ IMPLÉMENTÉ dans Story 1.6.1
-- Extension de chat_sessions pour Claude Code
ALTER TABLE chat_sessions ADD COLUMN claude_session_id text;
ALTER TABLE chat_sessions ADD COLUMN investigation_context jsonb;

-- Extension de chat_messages pour actions Claude Code
ALTER TABLE chat_messages ADD COLUMN claude_actions jsonb;
ALTER TABLE chat_messages ADD COLUMN investigation_steps jsonb;
ALTER TABLE chat_messages ADD COLUMN reasoning_steps jsonb;
```

**Aucune migration supplémentaire requise** - Les tables sont déjà configurées pour supporter Claude Code.

**Métadonnées des Messages Claude Code :**
```typescript
interface ClaudeCodeMessageMetadata {
  claudeActions?: string[];
  investigationSteps?: InvestigationStep[];
  reasoningSteps?: ReasoningStep[];
  filesAnalyzed?: string[];
  toolsUsed?: string[];
  workspacePath?: string;
}
```

### Testing

**Tests Requis :**
- Tests unitaires pour chaque agent et service
- Tests d'intégration pour les workflows complets
- Tests de performance avec grandes codebases
- Tests de régression pour la cohérence des agents
- Tests E2E pour les interactions utilisateur

**Fichiers de Test :**
```
src/lib/services/__tests__/
├── claude-code-assistant.test.ts
├── claude-session-manager.test.ts
└── documentation-generator.test.ts

e2e/
├── claude-code-investigation-flow.spec.ts
├── documentation-generation.spec.ts
└── code-analysis-workflow.spec.ts
```

## Dependencies et Prérequis
- **CRITIQUE :** Story 1.6.1 doit être terminée (composant de chat universel)
- Story 1.5.2 doit être complètement terminée (composants universels)
- ✅ **Tables Supabase chat_sessions et chat_messages étendues avec support Claude Code**
- ✅ **Script SQL d'extension implémenté et validé**
- Configuration Claude Code SDK et API keys

## Stratégie d'Implémentation

**Ordre de Développement (Approche d'Extension) :**
1. **Claude Code SDK** : Configuration et extension du service existant
2. **Types Étendus** : Ajout des nouveaux types aux interfaces existantes
3. **Investigation Autonome** : Extension des hooks existants avec outils Claude Code
4. **Raisonnement Multi-Étapes** : Intégration dans les composants existants
5. **Services Spécialisés** : Extension du service existant avec nouvelles fonctionnalités
6. **Intégration** : Réutilisation d'UniversalChatPanel existant

**Avantages de cette Approche d'Extension :**
- **Aucune duplication** de logique existante
- **Réutilisation complète** des composants et services de la Story 1.6.1
- **Cohérence** avec l'architecture existante
- **Maintenance simplifiée** - un seul point de vérité
- **Performance optimisée** - pas de re-création de composants
- **Tests existants** réutilisables et étendus
- **Interface utilisateur** cohérente et familière

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Création initiale de la story 1.6.2 | Sarah (PO) |
| 2024-12-19 | 1.1 | ✅ Script SQL d'extension Claude Code implémenté et validé | Sarah (PO) |

## Dev Agent Record
*Section à remplir par l'agent de développement lors de l'implémentation*
