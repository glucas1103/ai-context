# Story 1.6.2: Agents Intelligents avec Claude Code SDK

## Status
Draft (D√©pend de Story 1.6.1)

## Story
**As a** Gardien du Contexte (Tech Lead/CTO),
**I want** des agents IA intelligents qui peuvent investiguer automatiquement ma base de code et raisonner de mani√®re autonome en plusieurs √©tapes,
**so that** je puisse obtenir des r√©ponses pr√©cises sur mon code, g√©n√©rer de la documentation automatiquement, et b√©n√©ficier d'un assistant de d√©veloppement intelligent qui affiche son raisonnement de mani√®re transparente.

## Acceptance Criteria

1. **Int√©gration Claude Code SDK**
   - Installation et configuration de `@instantlyeasy/claude-code-sdk-ts`
   - Service centralis√© pour la gestion des sessions Claude
   - Configuration des outils Claude Code (Read, Grep, Glob, LS) avec permissions
   - Gestion des erreurs et retry automatique pour les appels API

2. **Syst√®me d'Agents Contextuels**
   - Architecture modulaire pour les agents avec types `AgentType`
   - Agent `analysis` pour l'exploration et analyse de code
   - Agent `documentation` pour la g√©n√©ration et enrichissement de documentation
   - Configuration des agents via fichiers YAML/JSON avec prompts sp√©cialis√©s
   - S√©lecteur d'agent dynamique dans l'interface

3. **Investigation Autonome de la Base de Code**
   - L'agent peut rechercher automatiquement dans la codebase sans intervention utilisateur
   - Utilisation des outils Claude Code pour exploration (Read, Grep, Glob, LS)
   - Identification automatique des d√©pendances et relations entre composants
   - Cache des investigations pour optimiser les performances
   - Affichage transparent des actions d'investigation entreprises

4. **Raisonnement Multi-√âtapes et Transparence**
   - L'agent peut raisonner de mani√®re autonome en plusieurs √©tapes
   - Affichage du processus de raisonnement √©tape par √©tape
   - Indicateurs visuels pour les actions en cours (investigation, analyse, g√©n√©ration)
   - Choix automatique du format de r√©ponse appropri√©
   - Communication claire du plan d'action avant ex√©cution

5. **G√©n√©ration Intelligente de Documentation (Agent Documentation)**
   - Analyse des commandes utilisateur pour identifier les besoins
   - Investigation automatique via Claude Code SDK pour informations pertinentes
   - G√©n√©ration de contenu structur√© avec insertion via UniversalContentPanel
   - Support g√©n√©ration diagrammes Mermaid et exemples de code
   - Auto-sauvegarde dans la structure documentation existante

6. **Analyse de Code Avanc√©e (Agent Analysis)**
   - Exploration de la codebase pour r√©pondre aux questions techniques
   - Identification automatique des patterns, anti-patterns, et probl√®mes potentiels
   - Suggestions d'optimisation et recommandations architecturales
   - Analyse des d√©pendances et impact des changements
   - G√©n√©ration de rapports structur√©s avec priorit√©s

7. **Int√©gration avec UniversalChatPanel**
   - Utilisation du composant de chat universel (Story 1.6.1)
   - Streaming des r√©ponses en temps r√©el avec affichage progressif
   - Gestion des sessions de chat avec persistance dans Supabase
   - Int√©gration seamless avec les API workspaces et documentation existantes

## Tasks / Subtasks

### Phase 1: Configuration Claude Code SDK (AC: 1)
- [ ] Installer et configurer `@instantlyeasy/claude-code-sdk-ts`
- [ ] Cr√©er `lib/services/claude-service.ts` avec gestion sessions et mod√®les
- [ ] Configurer outils Claude Code (Read, Grep, Glob, LS) avec permissions
- [ ] Impl√©menter cache investigations et gestion erreurs
- [ ] Cr√©er les types TypeScript pour l'int√©gration Claude Code

### Phase 2: Architecture des Agents (AC: 2)
- [ ] Cr√©er architecture agents dans `lib/agents/` avec types `AgentType`
- [ ] Impl√©menter `BaseAgent` avec fonctionnalit√©s communes
- [ ] Cr√©er `AnalysisAgent` pour exploration et analyse de code
- [ ] Cr√©er `DocumentationAgent` pour g√©n√©ration de documentation
- [ ] D√©velopper syst√®me de configuration agents YAML/JSON

### Phase 3: Investigation Autonome (AC: 3)
- [ ] Cr√©er `lib/services/codebase-analyzer.ts` pour orchestration
- [ ] Impl√©menter investigation automatique avec outils Claude Code
- [ ] D√©velopper cache intelligent pour les investigations
- [ ] Cr√©er indicateurs visuels pour actions d'investigation
- [ ] Optimiser performances pour grandes codebases

### Phase 4: Raisonnement Multi-√âtapes (AC: 4)
- [ ] Impl√©menter syst√®me de raisonnement √©tape par √©tape
- [ ] Cr√©er affichage transparent du processus de pens√©e
- [ ] D√©velopper s√©lecteur automatique de format de r√©ponse
- [ ] Ajouter indicateurs visuels pour √©tats de raisonnement
- [ ] Impl√©menter communication du plan d'action

### Phase 5: Agents Sp√©cialis√©s (AC: 5, 6)
- [ ] Finaliser `DocumentationAgent` avec g√©n√©ration intelligente
- [ ] Impl√©menter `DocumentationGenerator` pour insertion auto
- [ ] Finaliser `AnalysisAgent` avec analyse avanc√©e
- [ ] Ajouter support diagrammes Mermaid et exemples code
- [ ] Cr√©er syst√®me de suggestions et recommandations

### Phase 6: Int√©gration et Tests (AC: 7)
- [ ] Int√©grer agents avec UniversalChatPanel (Story 1.6.1)
- [ ] Impl√©menter streaming des r√©ponses en temps r√©el
- [ ] Cr√©er endpoints API pour gestion des agents
- [ ] Tests unitaires et d'int√©gration complets
- [ ] Documentation utilisation agents pour d√©veloppeurs

## Dev Notes

### Architecture Technique

**Structure de Fichiers :**
```
src/lib/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ claude-service.ts              # Service principal Claude Code SDK
‚îÇ   ‚îú‚îÄ‚îÄ codebase-analyzer.ts           # Orchestration des investigations
‚îÇ   ‚îî‚îÄ‚îÄ documentation-generator.ts     # G√©n√©ration via UniversalContentPanel
‚îú‚îÄ‚îÄ agents/
‚îÇ   ‚îú‚îÄ‚îÄ base-agent.ts                  # Interface AgentType commune
‚îÇ   ‚îú‚îÄ‚îÄ analysis-agent.ts              # Agent pour exploration code
‚îÇ   ‚îú‚îÄ‚îÄ documentation-agent.ts         # Agent pour g√©n√©ration docs
‚îÇ   ‚îî‚îÄ‚îÄ configs/
‚îÇ       ‚îú‚îÄ‚îÄ analysis-agent.yaml        # Configuration agent analysis
‚îÇ       ‚îî‚îÄ‚îÄ documentation-agent.yaml   # Configuration agent documentation
‚îî‚îÄ‚îÄ types/
    ‚îú‚îÄ‚îÄ agents.ts                      # Types AgentType, AgentConfig
    ‚îî‚îÄ‚îÄ claude.ts                      # Types pour Claude SDK
```

**Configuration des Agents :**
```typescript
type AgentType = 'analysis' | 'documentation';

interface AgentConfig {
  name: string;
  type: AgentType;
  model: 'sonnet' | 'opus' | 'haiku';
  tools: ClaudeCodeTool[];
  systemPrompt: string;
  temperature: number;
  maxTokens: number;
  capabilities: AgentCapability[];
  reasoningSteps: boolean;
  transparencyLevel: 'minimal' | 'detailed' | 'full';
}

interface AgentCapability {
  name: string;
  description: string;
  tools: string[];
  examples: string[];
}
```

**Configuration Agent Analysis :**
```yaml
name: "Code Analysis Specialist"
type: "analysis"
model: "sonnet"
tools: ["Read", "Grep", "Glob", "LS"]
systemPrompt: |
  Tu es un expert en analyse de code. Tu peux explorer la codebase pour identifier patterns, 
  d√©pendances, et probl√®mes potentiels. Tu raisonnes √©tape par √©tape et affiches ton processus 
  de pens√©e de mani√®re transparente.
temperature: 0.2
maxTokens: 4000
capabilities:
  - name: "code_exploration"
    description: "Exploration automatique de la structure du code"
  - name: "dependency_analysis" 
    description: "Analyse des d√©pendances entre composants"
  - name: "pattern_detection"
    description: "Identification de patterns et anti-patterns"
reasoningSteps: true
transparencyLevel: "detailed"
```

**Configuration Agent Documentation :**
```yaml
name: "Documentation Generator"
type: "documentation"
model: "sonnet"
tools: ["Read", "Grep", "Glob", "LS"]
systemPrompt: |
  Tu es un expert en documentation technique. Tu analyses le code et g√©n√®res une documentation 
  structur√©e et compl√®te. Tu investigues automatiquement pour trouver les informations pertinentes.
temperature: 0.3
maxTokens: 4000
capabilities:
  - name: "documentation_generation"
    description: "G√©n√©ration de documentation structur√©e"
  - name: "content_structuring"
    description: "Organisation du contenu de mani√®re logique"
  - name: "mermaid_diagrams"
    description: "G√©n√©ration de diagrammes Mermaid"
reasoningSteps: true
transparencyLevel: "full"
```

### Workflow d'Investigation Autonome

**S√©quence Typique :**
1. **R√©ception de la Question** : L'utilisateur pose une question dans UniversalChatPanel
2. **Analyse Initiale** : L'agent analyse la question et d√©termine le plan d'investigation
3. **Communication du Plan** : Affichage du plan d'action √† l'utilisateur
4. **Investigation Automatique** :
   - Utilisation de `Glob` pour identifier fichiers pertinents
   - Utilisation de `Grep` pour rechercher patterns sp√©cifiques
   - Utilisation de `Read` pour analyser le contenu des fichiers
   - Utilisation de `LS` pour explorer la structure
5. **Raisonnement Multi-√âtapes** : Analyse des informations collect√©es √©tape par √©tape
6. **G√©n√©ration de la R√©ponse** : Cr√©ation de la r√©ponse finale avec format appropri√©
7. **Affichage Transparent** : Communication de tout le processus √† l'utilisateur

**Exemple d'Interaction :**
```
Utilisateur: "Analyse les d√©pendances de ce composant"

Agent: "Je vais analyser les d√©pendances de ce composant. Voici mon plan :
1. Explorer la structure du fichier s√©lectionn√©
2. Identifier les imports et d√©pendances
3. Analyser les fichiers d√©pendants
4. Cr√©er un diagramme de d√©pendances
5. G√©n√©rer un rapport structur√©

[Indicateur: üîç Investigation en cours...]
- Lecture du fichier src/components/UserProfile.tsx
- Recherche des imports dans le projet
- Analyse des composants d√©pendants

[Indicateur: ü§î Analyse en cours...]
- Identification de 5 d√©pendances directes
- D√©tection de 3 d√©pendances circulaires potentielles

[Indicateur: üìä G√©n√©ration en cours...]
- Cr√©ation du diagramme de d√©pendances
- G√©n√©ration du rapport d'analyse

Voici mon analyse compl√®te..."
```

### Int√©gration avec Claude Code SDK

**Outils Utilis√©s :**
- **Read** : Lecture fichiers avec contexte du workspace
- **Grep** : Recherche patterns pour identifier code pertinent
- **Glob** : Recherche fichiers par patterns (ex: `**/*auth*`, `**/*.config.*`)
- **LS** : Exploration arborescence pour structure projet

**Gestion des Sessions :**
```typescript
interface ClaudeSession {
  id: string;
  agentType: AgentType;
  workspaceId: string;
  context: {
    selectedFile?: string;
    currentDirectory?: string;
    investigationHistory?: InvestigationStep[];
  };
  createdAt: Date;
  lastActivity: Date;
}

interface InvestigationStep {
  tool: string;
  query: string;
  result: any;
  timestamp: Date;
  duration: number;
}
```

### Base de Donn√©es

**Extensions Tables Existantes :**
```sql
-- Extension de chat_sessions pour agents
ALTER TABLE chat_sessions ADD COLUMN agent_type text;
ALTER TABLE chat_sessions ADD COLUMN claude_session_id text;
ALTER TABLE chat_sessions ADD COLUMN investigation_context jsonb;

-- Extension de chat_messages pour actions Claude
ALTER TABLE chat_messages ADD COLUMN claude_actions jsonb;
ALTER TABLE chat_messages ADD COLUMN investigation_steps jsonb;
```

**M√©tadonn√©es des Messages :**
```typescript
interface MessageMetadata {
  agentType: AgentType;
  claudeActions?: string[];
  investigationSteps?: InvestigationStep[];
  reasoningSteps?: ReasoningStep[];
  filesAnalyzed?: string[];
  toolsUsed?: string[];
}
```

### Testing

**Tests Requis :**
- Tests unitaires pour chaque agent et service
- Tests d'int√©gration pour les workflows complets
- Tests de performance avec grandes codebases
- Tests de r√©gression pour la coh√©rence des agents
- Tests E2E pour les interactions utilisateur

**Fichiers de Test :**
```
src/lib/services/__tests__/
‚îú‚îÄ‚îÄ claude-service.test.ts
‚îú‚îÄ‚îÄ codebase-analyzer.test.ts
‚îî‚îÄ‚îÄ documentation-generator.test.ts

src/lib/agents/__tests__/
‚îú‚îÄ‚îÄ base-agent.test.ts
‚îú‚îÄ‚îÄ analysis-agent.test.ts
‚îî‚îÄ‚îÄ documentation-agent.test.ts

e2e/
‚îú‚îÄ‚îÄ agent-investigation-flow.spec.ts
‚îú‚îÄ‚îÄ documentation-generation.spec.ts
‚îî‚îÄ‚îÄ code-analysis-workflow.spec.ts
```

## Dependencies et Pr√©requis
- **CRITIQUE :** Story 1.6.1 doit √™tre termin√©e (composant de chat universel)
- Story 1.5.2 doit √™tre compl√®tement termin√©e (composants universels)
- Tables Supabase chat_sessions et chat_messages avec extensions
- Configuration Claude Code SDK et API keys

## Strat√©gie d'Impl√©mentation

**Ordre de D√©veloppement :**
1. **Claude Code SDK** : Configuration et services de base
2. **Architecture Agents** : Structure modulaire et types
3. **Investigation Autonome** : Outils et orchestration
4. **Raisonnement Multi-√âtapes** : Transparence et processus
5. **Agents Sp√©cialis√©s** : Analysis et Documentation
6. **Int√©gration** : UniversalChatPanel et tests

**Avantages de cette Approche :**
- Agents intelligents avec raisonnement autonome
- Transparence totale du processus de pens√©e
- Investigation automatique sans intervention utilisateur
- R√©utilisabilit√© pour diff√©rentes pages de l'application
- Performance optimis√©e avec cache intelligent

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Cr√©ation initiale de la story 1.6.2 | Sarah (PO) |

## Dev Agent Record
*Section √† remplir par l'agent de d√©veloppement lors de l'impl√©mentation*
