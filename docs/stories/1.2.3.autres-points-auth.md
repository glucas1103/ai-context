# Story 1.2.3: autres-points-auth

## Status
Draft

## Story
**As a** Gardien du Contexte (Tech Lead/CTO),
**I want** finaliser les am√©liorations de s√©curit√© et de conformit√© Supabase Auth,
**so that** l'application soit compl√®tement s√©curis√©e, maintenable et conforme aux standards Supabase.

## Acceptance Criteria
1. ‚úÖ √âlimination compl√®te de l'utilisation du service role key
2. ‚úÖ Impl√©mentation des politiques RLS appropri√©es
3. ‚úÖ Am√©lioration du middleware pour la protection des routes
4. ‚úÖ Documentation des bonnes pratiques impl√©ment√©es
5. ‚úÖ Tests de s√©curit√© pour l'isolation des donn√©es
6. ‚úÖ Validation de la conformit√© aux standards Supabase

## Tasks / Subtasks
- [ ] √âliminer l'utilisation du service role key (AC: 1)
  - [ ] Identifier tous les endroits o√π `SUPABASE_SERVICE_ROLE_KEY` est utilis√©
  - [ ] Remplacer par l'utilisation du client SSR avec authentification utilisateur
  - [ ] V√©rifier que les op√©rations respectent les politiques RLS
  - [ ] Tester que les fonctionnalit√©s restent op√©rationnelles
- [ ] Impl√©menter les politiques RLS (AC: 2)
  - [ ] Cr√©er les tables n√©cessaires avec RLS activ√©
  - [ ] D√©finir les politiques pour l'isolation des donn√©es utilisateur
  - [ ] Tester que les utilisateurs ne peuvent acc√©der qu'√† leurs propres donn√©es
  - [ ] Documenter les politiques mises en place
- [ ] Am√©liorer le middleware de protection (AC: 3)
  - [ ] Impl√©menter le middleware selon la documentation officielle
  - [ ] Ajouter la logique de protection des routes authentifi√©es
  - [ ] Impl√©menter la redirection automatique vers /login si non authentifi√©
  - [ ] G√©rer les routes publiques vs prot√©g√©es
- [ ] Documenter les bonnes pratiques (AC: 4)
  - [ ] Cr√©er un guide des bonnes pratiques Supabase Auth bas√© sur la doc officielle
  - [ ] Documenter les patterns utilis√©s dans le projet
  - [ ] Ajouter des commentaires dans le code pour expliquer les choix
  - [ ] Mettre √† jour la documentation technique
- [ ] Tests de s√©curit√© pour l'isolation des donn√©es (AC: 5)
  - [ ] Tests pour v√©rifier l'isolation des donn√©es utilisateur
  - [ ] Tests de s√©curit√© pour les politiques RLS
  - [ ] Tests de validation des routes prot√©g√©es
  - [ ] Tests de conformit√© aux standards de s√©curit√©
- [ ] Validation de la conformit√© aux standards Supabase (AC: 6)
  - [ ] Audit de conformit√© aux bonnes pratiques Supabase
  - [ ] Validation des patterns de s√©curit√© impl√©ment√©s
  - [ ] V√©rification de la documentation des patterns
  - [ ] Tests de conformit√© aux standards officiels

## Dev Notes

### Architecture Technique - S√©curit√© et Conformit√© Supabase

**‚ö†Ô∏è S√âCURIT√â CRITIQUE : √âlimination du Service Role Key**

L'utilisation du service role key contourne les politiques RLS et repr√©sente un risque de s√©curit√© majeur. Il faut l'√©liminer compl√®tement.

**Probl√®mes identifi√©s dans l'impl√©mentation actuelle :**

1. **‚ùå Utilisation du service role key :**
   - Contourne les politiques RLS
   - Risque de s√©curit√© majeur
   - Pas conforme aux bonnes pratiques Supabase

**Solutions selon la documentation officielle :**

### 1. √âlimination du Service Role Key

**Variables d'Environnement √† Supprimer :**
```env
# ‚ùå √Ä supprimer - Service role key ne doit pas √™tre utilis√© c√¥t√© client
SUPABASE_SERVICE_ROLE_KEY=...
```

**Variables √† Conserver :**
```env
# ‚úÖ √Ä conserver - Variables publiques n√©cessaires selon la doc officielle
NEXT_PUBLIC_SUPABASE_URL=https://ettslixliqlkakularea.supabase.co
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=...
```

**Pattern pour remplacer l'utilisation du service role key :**

```typescript
// ‚ùå ANCIEN PATTERN (√† supprimer)
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // ‚ùå DANGEREUX
)

// ‚úÖ NOUVEAU PATTERN (√† utiliser)
import { createClient } from '@/utils/supabase/server'

const supabase = await createClient() // ‚úÖ Utilise l'authentification utilisateur
```

### 2. Politiques RLS Officielles

**Politiques de base selon la documentation :**

```sql
-- Activer RLS sur toutes les tables
ALTER TABLE workspaces ENABLE ROW LEVEL SECURITY;
ALTER TABLE knowledge_bases ENABLE ROW LEVEL SECURITY;

-- Politique pour l'isolation des donn√©es utilisateur
CREATE POLICY "Users can only access their own workspaces" ON workspaces
  FOR ALL USING (auth.uid() = owner_id);

CREATE POLICY "Users can only access their own knowledge bases" ON knowledge_bases
  FOR ALL USING (auth.uid() = user_id);

-- Politique pour les op√©rations de lecture
CREATE POLICY "Users can read their own workspaces" ON workspaces
  FOR SELECT USING (auth.uid() = owner_id);

-- Politique pour les op√©rations d'√©criture
CREATE POLICY "Users can insert their own workspaces" ON workspaces
  FOR INSERT WITH CHECK (auth.uid() = owner_id);

CREATE POLICY "Users can update their own workspaces" ON workspaces
  FOR UPDATE USING (auth.uid() = owner_id);

CREATE POLICY "Users can delete their own workspaces" ON workspaces
  FOR DELETE USING (auth.uid() = owner_id);
```

### 3. Middleware de Protection Am√©lior√©

**Pattern officiel pour le middleware :**

```typescript
// utils/supabase/middleware.ts
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))
          supabaseResponse = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // IMPORTANT : Ne pas supprimer cette ligne
  const { data: { user } } = await supabase.auth.getUser()

  // Routes publiques qui ne n√©cessitent pas d'authentification
  const publicRoutes = [
    '/login',
    '/auth',
    '/error',
    '/api/auth/callback',
    '/api/auth/signout'
  ]

  // V√©rifier si la route actuelle est publique
  const isPublicRoute = publicRoutes.some(route => 
    request.nextUrl.pathname.startsWith(route)
  )

  // Si l'utilisateur n'est pas authentifi√© et que la route n'est pas publique
  if (!user && !isPublicRoute) {
    const url = request.nextUrl.clone()
    url.pathname = '/login'
    return NextResponse.redirect(url)
  }

  // Si l'utilisateur est authentifi√© et essaie d'acc√©der √† /login
  if (user && request.nextUrl.pathname === '/login') {
    const url = request.nextUrl.clone()
    url.pathname = '/'
    return NextResponse.redirect(url)
  }

  return supabaseResponse
}
```

### 4. Server Actions pour l'Authentification

**Pattern officiel pour les Server Actions :**

```typescript
// app/login/actions.ts
'use server'

import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'
import { createClient } from '@/utils/supabase/server'

export async function login(formData: FormData) {
  const supabase = await createClient()

  const data = {
    email: formData.get('email') as string,
    password: formData.get('password') as string,
  }

  const { error } = await supabase.auth.signInWithPassword(data)

  if (error) {
    redirect('/error')
  }

  revalidatePath('/', 'layout')
  redirect('/')
}

export async function signOut() {
  const supabase = await createClient()
  
  const { error } = await supabase.auth.signOut()
  
  if (error) {
    console.error('Error signing out:', error)
  }
  
  revalidatePath('/', 'layout')
  redirect('/login')
}
```

### 5. Guide des Bonnes Pratiques

**Documentation √† cr√©er :**

```markdown
# Guide des Bonnes Pratiques Supabase Auth

## Principes de S√©curit√©

### 1. Ne jamais utiliser le Service Role Key c√¥t√© client
- Le service role key contourne RLS
- Utilisez toujours l'authentification utilisateur
- Utilisez les patterns SSR officiels

### 2. Toujours utiliser RLS
- Activez RLS sur toutes les tables
- D√©finissez des politiques strictes
- Testez l'isolation des donn√©es

### 3. Gestion s√©curis√©e des sessions
- Utilisez `getUser()` c√¥t√© serveur
- √âvitez `getSession()` c√¥t√© serveur
- G√©rez correctement les cookies

### 4. Provider Tokens
- Ne stockez jamais les tokens en local storage
- Utilisez les tokens depuis la session Supabase
- Impl√©mentez le refresh automatique

## Patterns Recommand√©s

### Client Browser
```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!
  )
}
```

### Client Server
```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()
  
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // Ignore si appel√© depuis un Server Component
          }
        },
      },
    }
  )
}
```

### Middleware
```typescript
import { updateSession } from '@/utils/supabase/middleware'

export async function middleware(request: NextRequest) {
  return await updateSession(request)
}
```

## Tests de S√©curit√©

### Tests RLS
- V√©rifiez qu'un utilisateur ne peut pas acc√©der aux donn√©es d'un autre
- Testez les politiques d'insertion, mise √† jour et suppression
- Validez l'isolation des donn√©es

### Tests d'Authentification
- Testez la protection des routes
- Validez les redirections
- Testez la gestion des sessions

### Tests de Tokens
- Testez le refresh automatique
- Validez la gestion des erreurs
- Testez la reconnexion
```

### Security Considerations

**Points de s√©curit√© critiques selon la documentation officielle :**
- ‚úÖ **NE JAMAIS** utiliser `supabase.auth.getSession()` c√¥t√© serveur
- ‚úÖ **TOUJOURS** utiliser `supabase.auth.getUser()` pour valider l'authentification
- ‚úÖ Suppression compl√®te du service role key c√¥t√© client
- ‚úÖ Utilisation exclusive du pattern SSR officiel
- ‚úÖ Impl√©mentation de politiques RLS strictes
- ‚úÖ Gestion s√©curis√©e des provider tokens

**‚ö†Ô∏è AVERTISSEMENTS DE S√âCURIT√â OFFICIELS :**
- Les cookies peuvent √™tre falsifi√©s c√¥t√© client
- `getSession()` ne revalide pas le token c√¥t√© serveur
- `getUser()` envoie une requ√™te au serveur Supabase pour revalider
- Le service role key contourne toutes les politiques de s√©curit√©

### Testing Strategy

**Tests selon les bonnes pratiques officielles :**
- V√©rifier qu'un utilisateur ne peut pas acc√©der aux donn√©es d'un autre
- Tester que les routes prot√©g√©es redirigent correctement
- Valider que les provider tokens sont g√©r√©s de mani√®re s√©curis√©e
- Tester les cas d'erreur de token expir√©/r√©voqu√©
- V√©rifier que le middleware fonctionne correctement
- Tester les politiques RLS

### File Locations

**Fichiers √† modifier :**
- `/apps/web/src/lib/supabase/server.ts` - **√âLIMINATION DU SERVICE ROLE KEY**
- `/apps/web/src/app/api/workspaces/route.ts` - **√âLIMINATION DU SERVICE ROLE KEY**
- `/apps/web/src/app/api/workspaces/[id]/route.ts` - **√âLIMINATION DU SERVICE ROLE KEY**

**Nouveaux fichiers √† cr√©er :**
- `/docs/supabase-best-practices.md` - Guide des bonnes pratiques officielles
- `/apps/web/src/lib/supabase/rls-policies.sql` - Politiques RLS
- `/apps/web/src/lib/supabase/security-utils.ts` - Utilitaires de s√©curit√©

## Change Log
| Date       | Version | Description              | Auteur |
|------------|---------|--------------------------|--------|
| 12/01/2025 | 1.0     | Cr√©ation initiale story  | Bob    |

## Dev Agent Record

### Agent Model Used
Bob - Scrum Master (Claude Sonnet 4)

### Completion Notes List
- ‚úÖ Analyse de la story originale 1.2.1.update-auth.md
- ‚úÖ Extraction des t√¢ches sp√©cifiques aux autres points d'authentification
- ‚úÖ Documentation des patterns officiels selon la documentation Supabase

### File List
#### Fichiers √† modifier :
- `/apps/web/src/lib/supabase/server.ts` - **√âLIMINATION DU SERVICE ROLE KEY**
- `/apps/web/src/app/api/workspaces/route.ts` - **√âLIMINATION DU SERVICE ROLE KEY**
- `/apps/web/src/app/api/workspaces/[id]/route.ts` - **√âLIMINATION DU SERVICE ROLE KEY**

#### Nouveaux fichiers √† cr√©er :
- `/docs/supabase-best-practices.md` - Guide des bonnes pratiques officielles
- `/apps/web/src/lib/supabase/rls-policies.sql` - Politiques RLS
- `/apps/web/src/lib/supabase/security-utils.ts` - Utilitaires de s√©curit√©

## QA Results

### Review Date: 12/01/2025

### Reviewed By: Bob (Scrum Master)

### Code Quality Assessment

**‚ö†Ô∏è S√âCURIT√â CRITIQUE**

Cette story est **CRITIQUE** car elle concerne l'√©limination du service role key et l'impl√©mentation des politiques RLS, essentiels pour la s√©curit√© de l'application.

### Compliance Check

- **Security Standards**: ‚ö†Ô∏è **S√âCURIT√â CRITIQUE** (service role key √† √©liminer)
- **Supabase Best Practices**: ‚ö†Ô∏è **S√âCURIT√â CRITIQUE** (RLS √† impl√©menter)
- **Code Maintainability**: ‚úÖ Patterns bien document√©s et r√©utilisables
- **Documentation**: ‚úÖ Story mise √† jour avec documentation officielle
- **Official Compliance**: ‚úÖ **CONFORME** aux patterns officiels Supabase

### Recommended Status

**üö® CRITICAL - IMMEDIATE ACTION REQUIRED**

Cette story est **CRITIQUE** et doit √™tre impl√©ment√©e imm√©diatement car elle concerne la s√©curit√© de l'application et l'√©limination du service role key.

## Documentation Officielle R√©f√©renc√©e

### Liens Officiels Supabase
- [Row Level Security](https://supabase.com/docs/guides/database/postgres/row-level-security)
- [Server-Side Auth pour Next.js](https://supabase.com/docs/guides/auth/server-side/nextjs)
- [Security Best Practices](https://supabase.com/docs/guides/security)

### Patterns Officiels √† Suivre
1. **RLS** : Politiques avec `auth.uid()`
2. **Service Role Key** : Ne jamais utiliser c√¥t√© client
3. **Middleware** : Pattern officiel avec `updateSession`
4. **Server Actions** : Utilisation du client SSR
5. **Security** : Politiques RLS strictes
