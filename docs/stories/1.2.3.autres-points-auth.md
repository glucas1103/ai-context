# Story 1.2.3: autres-points-auth

## Status
Draft

## Story
**As a** Gardien du Contexte (Tech Lead/CTO),
**I want** finaliser les améliorations de sécurité et de conformité Supabase Auth,
**so that** l'application soit complètement sécurisée, maintenable et conforme aux standards Supabase.

## Acceptance Criteria
1. ✅ Élimination complète de l'utilisation du service role key
2. ✅ Implémentation des politiques RLS appropriées
3. ✅ Amélioration du middleware pour la protection des routes
4. ✅ Documentation des bonnes pratiques implémentées
5. ✅ Tests de sécurité pour l'isolation des données
6. ✅ Validation de la conformité aux standards Supabase

## Tasks / Subtasks
- [ ] Éliminer l'utilisation du service role key (AC: 1)
  - [ ] Identifier tous les endroits où `SUPABASE_SERVICE_ROLE_KEY` est utilisé
  - [ ] Remplacer par l'utilisation du client SSR avec authentification utilisateur
  - [ ] Vérifier que les opérations respectent les politiques RLS
  - [ ] Tester que les fonctionnalités restent opérationnelles
- [ ] Implémenter les politiques RLS (AC: 2)
  - [ ] Créer les tables nécessaires avec RLS activé
  - [ ] Définir les politiques pour l'isolation des données utilisateur
  - [ ] Tester que les utilisateurs ne peuvent accéder qu'à leurs propres données
  - [ ] Documenter les politiques mises en place
- [ ] Améliorer le middleware de protection (AC: 3)
  - [ ] Implémenter le middleware selon la documentation officielle
  - [ ] Ajouter la logique de protection des routes authentifiées
  - [ ] Implémenter la redirection automatique vers /login si non authentifié
  - [ ] Gérer les routes publiques vs protégées
- [ ] Documenter les bonnes pratiques (AC: 4)
  - [ ] Créer un guide des bonnes pratiques Supabase Auth basé sur la doc officielle
  - [ ] Documenter les patterns utilisés dans le projet
  - [ ] Ajouter des commentaires dans le code pour expliquer les choix
  - [ ] Mettre à jour la documentation technique
- [ ] Tests de sécurité pour l'isolation des données (AC: 5)
  - [ ] Tests pour vérifier l'isolation des données utilisateur
  - [ ] Tests de sécurité pour les politiques RLS
  - [ ] Tests de validation des routes protégées
  - [ ] Tests de conformité aux standards de sécurité
- [ ] Validation de la conformité aux standards Supabase (AC: 6)
  - [ ] Audit de conformité aux bonnes pratiques Supabase
  - [ ] Validation des patterns de sécurité implémentés
  - [ ] Vérification de la documentation des patterns
  - [ ] Tests de conformité aux standards officiels

## Dev Notes

### Architecture Technique - Sécurité et Conformité Supabase

**⚠️ SÉCURITÉ CRITIQUE : Élimination du Service Role Key**

L'utilisation du service role key contourne les politiques RLS et représente un risque de sécurité majeur. Il faut l'éliminer complètement.

**Problèmes identifiés dans l'implémentation actuelle :**

1. **❌ Utilisation du service role key :**
   - Contourne les politiques RLS
   - Risque de sécurité majeur
   - Pas conforme aux bonnes pratiques Supabase

**Solutions selon la documentation officielle :**

### 1. Élimination du Service Role Key

**Variables d'Environnement à Supprimer :**
```env
# ❌ À supprimer - Service role key ne doit pas être utilisé côté client
SUPABASE_SERVICE_ROLE_KEY=...
```

**Variables à Conserver :**
```env
# ✅ À conserver - Variables publiques nécessaires selon la doc officielle
NEXT_PUBLIC_SUPABASE_URL=https://ettslixliqlkakularea.supabase.co
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=...
```

**Pattern pour remplacer l'utilisation du service role key :**

```typescript
// ❌ ANCIEN PATTERN (à supprimer)
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // ❌ DANGEREUX
)

// ✅ NOUVEAU PATTERN (à utiliser)
import { createClient } from '@/utils/supabase/server'

const supabase = await createClient() // ✅ Utilise l'authentification utilisateur
```

### 2. Politiques RLS Officielles

**Politiques de base selon la documentation :**

```sql
-- Activer RLS sur toutes les tables
ALTER TABLE workspaces ENABLE ROW LEVEL SECURITY;
ALTER TABLE knowledge_bases ENABLE ROW LEVEL SECURITY;

-- Politique pour l'isolation des données utilisateur
CREATE POLICY "Users can only access their own workspaces" ON workspaces
  FOR ALL USING (auth.uid() = owner_id);

CREATE POLICY "Users can only access their own knowledge bases" ON knowledge_bases
  FOR ALL USING (auth.uid() = user_id);

-- Politique pour les opérations de lecture
CREATE POLICY "Users can read their own workspaces" ON workspaces
  FOR SELECT USING (auth.uid() = owner_id);

-- Politique pour les opérations d'écriture
CREATE POLICY "Users can insert their own workspaces" ON workspaces
  FOR INSERT WITH CHECK (auth.uid() = owner_id);

CREATE POLICY "Users can update their own workspaces" ON workspaces
  FOR UPDATE USING (auth.uid() = owner_id);

CREATE POLICY "Users can delete their own workspaces" ON workspaces
  FOR DELETE USING (auth.uid() = owner_id);
```

### 3. Middleware de Protection Amélioré

**Pattern officiel pour le middleware :**

```typescript
// utils/supabase/middleware.ts
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))
          supabaseResponse = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // IMPORTANT : Ne pas supprimer cette ligne
  const { data: { user } } = await supabase.auth.getUser()

  // Routes publiques qui ne nécessitent pas d'authentification
  const publicRoutes = [
    '/login',
    '/auth',
    '/error',
    '/api/auth/callback',
    '/api/auth/signout'
  ]

  // Vérifier si la route actuelle est publique
  const isPublicRoute = publicRoutes.some(route => 
    request.nextUrl.pathname.startsWith(route)
  )

  // Si l'utilisateur n'est pas authentifié et que la route n'est pas publique
  if (!user && !isPublicRoute) {
    const url = request.nextUrl.clone()
    url.pathname = '/login'
    return NextResponse.redirect(url)
  }

  // Si l'utilisateur est authentifié et essaie d'accéder à /login
  if (user && request.nextUrl.pathname === '/login') {
    const url = request.nextUrl.clone()
    url.pathname = '/'
    return NextResponse.redirect(url)
  }

  return supabaseResponse
}
```

### 4. Server Actions pour l'Authentification

**Pattern officiel pour les Server Actions :**

```typescript
// app/login/actions.ts
'use server'

import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'
import { createClient } from '@/utils/supabase/server'

export async function login(formData: FormData) {
  const supabase = await createClient()

  const data = {
    email: formData.get('email') as string,
    password: formData.get('password') as string,
  }

  const { error } = await supabase.auth.signInWithPassword(data)

  if (error) {
    redirect('/error')
  }

  revalidatePath('/', 'layout')
  redirect('/')
}

export async function signOut() {
  const supabase = await createClient()
  
  const { error } = await supabase.auth.signOut()
  
  if (error) {
    console.error('Error signing out:', error)
  }
  
  revalidatePath('/', 'layout')
  redirect('/login')
}
```

### 5. Guide des Bonnes Pratiques

**Documentation à créer :**

```markdown
# Guide des Bonnes Pratiques Supabase Auth

## Principes de Sécurité

### 1. Ne jamais utiliser le Service Role Key côté client
- Le service role key contourne RLS
- Utilisez toujours l'authentification utilisateur
- Utilisez les patterns SSR officiels

### 2. Toujours utiliser RLS
- Activez RLS sur toutes les tables
- Définissez des politiques strictes
- Testez l'isolation des données

### 3. Gestion sécurisée des sessions
- Utilisez `getUser()` côté serveur
- Évitez `getSession()` côté serveur
- Gérez correctement les cookies

### 4. Provider Tokens
- Ne stockez jamais les tokens en local storage
- Utilisez les tokens depuis la session Supabase
- Implémentez le refresh automatique

## Patterns Recommandés

### Client Browser
```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!
  )
}
```

### Client Server
```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()
  
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // Ignore si appelé depuis un Server Component
          }
        },
      },
    }
  )
}
```

### Middleware
```typescript
import { updateSession } from '@/utils/supabase/middleware'

export async function middleware(request: NextRequest) {
  return await updateSession(request)
}
```

## Tests de Sécurité

### Tests RLS
- Vérifiez qu'un utilisateur ne peut pas accéder aux données d'un autre
- Testez les politiques d'insertion, mise à jour et suppression
- Validez l'isolation des données

### Tests d'Authentification
- Testez la protection des routes
- Validez les redirections
- Testez la gestion des sessions

### Tests de Tokens
- Testez le refresh automatique
- Validez la gestion des erreurs
- Testez la reconnexion
```

### Security Considerations

**Points de sécurité critiques selon la documentation officielle :**
- ✅ **NE JAMAIS** utiliser `supabase.auth.getSession()` côté serveur
- ✅ **TOUJOURS** utiliser `supabase.auth.getUser()` pour valider l'authentification
- ✅ Suppression complète du service role key côté client
- ✅ Utilisation exclusive du pattern SSR officiel
- ✅ Implémentation de politiques RLS strictes
- ✅ Gestion sécurisée des provider tokens

**⚠️ AVERTISSEMENTS DE SÉCURITÉ OFFICIELS :**
- Les cookies peuvent être falsifiés côté client
- `getSession()` ne revalide pas le token côté serveur
- `getUser()` envoie une requête au serveur Supabase pour revalider
- Le service role key contourne toutes les politiques de sécurité

### Testing Strategy

**Tests selon les bonnes pratiques officielles :**
- Vérifier qu'un utilisateur ne peut pas accéder aux données d'un autre
- Tester que les routes protégées redirigent correctement
- Valider que les provider tokens sont gérés de manière sécurisée
- Tester les cas d'erreur de token expiré/révoqué
- Vérifier que le middleware fonctionne correctement
- Tester les politiques RLS

### File Locations

**Fichiers à modifier :**
- `/apps/web/src/lib/supabase/server.ts` - **ÉLIMINATION DU SERVICE ROLE KEY**
- `/apps/web/src/app/api/workspaces/route.ts` - **ÉLIMINATION DU SERVICE ROLE KEY**
- `/apps/web/src/app/api/workspaces/[id]/route.ts` - **ÉLIMINATION DU SERVICE ROLE KEY**

**Nouveaux fichiers à créer :**
- `/docs/supabase-best-practices.md` - Guide des bonnes pratiques officielles
- `/apps/web/src/lib/supabase/rls-policies.sql` - Politiques RLS
- `/apps/web/src/lib/supabase/security-utils.ts` - Utilitaires de sécurité

## Change Log
| Date       | Version | Description              | Auteur |
|------------|---------|--------------------------|--------|
| 12/01/2025 | 1.0     | Création initiale story  | Bob    |

## Dev Agent Record

### Agent Model Used
Bob - Scrum Master (Claude Sonnet 4)

### Completion Notes List
- ✅ Analyse de la story originale 1.2.1.update-auth.md
- ✅ Extraction des tâches spécifiques aux autres points d'authentification
- ✅ Documentation des patterns officiels selon la documentation Supabase

### File List
#### Fichiers à modifier :
- `/apps/web/src/lib/supabase/server.ts` - **ÉLIMINATION DU SERVICE ROLE KEY**
- `/apps/web/src/app/api/workspaces/route.ts` - **ÉLIMINATION DU SERVICE ROLE KEY**
- `/apps/web/src/app/api/workspaces/[id]/route.ts` - **ÉLIMINATION DU SERVICE ROLE KEY**

#### Nouveaux fichiers à créer :
- `/docs/supabase-best-practices.md` - Guide des bonnes pratiques officielles
- `/apps/web/src/lib/supabase/rls-policies.sql` - Politiques RLS
- `/apps/web/src/lib/supabase/security-utils.ts` - Utilitaires de sécurité

## QA Results

### Review Date: 12/01/2025

### Reviewed By: Bob (Scrum Master)

### Code Quality Assessment

**⚠️ SÉCURITÉ CRITIQUE**

Cette story est **CRITIQUE** car elle concerne l'élimination du service role key et l'implémentation des politiques RLS, essentiels pour la sécurité de l'application.

### Compliance Check

- **Security Standards**: ⚠️ **SÉCURITÉ CRITIQUE** (service role key à éliminer)
- **Supabase Best Practices**: ⚠️ **SÉCURITÉ CRITIQUE** (RLS à implémenter)
- **Code Maintainability**: ✅ Patterns bien documentés et réutilisables
- **Documentation**: ✅ Story mise à jour avec documentation officielle
- **Official Compliance**: ✅ **CONFORME** aux patterns officiels Supabase

### Recommended Status

**🚨 CRITICAL - IMMEDIATE ACTION REQUIRED**

Cette story est **CRITIQUE** et doit être implémentée immédiatement car elle concerne la sécurité de l'application et l'élimination du service role key.

## Documentation Officielle Référencée

### Liens Officiels Supabase
- [Row Level Security](https://supabase.com/docs/guides/database/postgres/row-level-security)
- [Server-Side Auth pour Next.js](https://supabase.com/docs/guides/auth/server-side/nextjs)
- [Security Best Practices](https://supabase.com/docs/guides/security)

### Patterns Officiels à Suivre
1. **RLS** : Politiques avec `auth.uid()`
2. **Service Role Key** : Ne jamais utiliser côté client
3. **Middleware** : Pattern officiel avec `updateSession`
4. **Server Actions** : Utilisation du client SSR
5. **Security** : Politiques RLS strictes
