# Story 1.5.1: refacto-creation-structure-documentation-personnalisee

## Status
Draft

## Story
**As a** Développeur,
**I want** refactoriser le composant monolithique DocumentationPage en structure modulaire cohérente avec WorkspaceContextPage,
**so that** les deux pages partagent une architecture similaire et maintenable.

## Acceptance Criteria
1. Le composant `page.tsx` devient un coordinateur simple (<120 lignes, légèrement plus que context car plus de logique CRUD)
2. 3 composants spécialisés créés : `DocumentationTreeEditor`, `DocumentationContentEditor`, `DocumentationChatPanel`
3. Types harmonisés avec une interface commune `TreeNodeBase` dont héritent `FileTreeNode` et `DocumentationNode`
4. Structure API cohérente dans `api/workspaces/[id]/documentation/` (déjà existante)
5. Tous les tests existants continuent de passer après le refactoring
6. Aucune régression fonctionnelle n'est introduite
7. Préparation pour la factorisation commune future (Story 1.5.2)

## Business Value
- **Cohérence :** Architecture unifiée entre les pages context et documentation
- **Maintenabilité :** Code plus facile à comprendre et à modifier
- **Évolutivité :** Préparation pour la factorisation commune et l'intégration IA
- **Qualité :** Respect des standards établis dans le refactoring context

## Tasks / Subtasks

### Phase 1: Harmonisation des Types (AC: 3)
- [ ] Créer interface commune `TreeNodeBase` dans `lib/types/common.ts`
- [ ] Faire hériter `FileTreeNode` et `DocumentationNode` de `TreeNodeBase`
- [ ] Créer `lib/types/documentation-components.ts` pour les props des nouveaux composants
- [ ] Mettre à jour les imports dans `page.tsx` et composants existants

### Phase 2: Création du Composant DocumentationTreeEditor (AC: 2)
- [ ] Créer `components/DocumentationTreeEditor.tsx` (~120 lignes)
- [ ] Intégrer react-arborist avec fonctionnalités CRUD (create, rename, delete, move)
- [ ] Implémenter la gestion des événements d'édition inline
- [ ] Ajouter les boutons d'actions contextuelles (nouveau dossier/fichier)

### Phase 3: Création du Composant DocumentationContentEditor (AC: 2)  
- [ ] Créer `components/DocumentationContentEditor.tsx` (~100 lignes)
- [ ] Intégrer TipTap Editor avec auto-sauvegarde
- [ ] Gérer les états de chargement et sauvegarde
- [ ] Maintenir la logique d'auto-save existante

### Phase 4: Création du Composant DocumentationChatPanel (AC: 2)
- [ ] Créer `components/DocumentationChatPanel.tsx` (~80 lignes)
- [ ] Intégrer le ChatPanel existant avec contexte documentation
- [ ] Préparer l'interface pour les prompts IA spécialisés documentation
- [ ] Maintenir la simulation de chat existante

### Phase 5: Refactoring page.tsx (AC: 1)
- [ ] Réduire `page.tsx` à un coordinateur simple (<120 lignes)
- [ ] Extraire la logique de gestion CRUD vers les composants appropriés
- [ ] Maintenir la logique d'état centrale (selectedFile, treeData, etc.)
- [ ] Conserver la layout responsive existante

### Phase 6: Tests et Validation (AC: 5, 6, 7)
- [ ] Valider tous les tests existants passent
- [ ] Tester les fonctionnalités CRUD (create, rename, delete, move)
- [ ] Valider l'auto-sauvegarde et l'édition TipTap
- [ ] Tests de régression sur le parcours utilisateur complet

## Dev Notes

### Analyse de l'État Actuel

Le fichier `page.tsx` (402 lignes) est plus complexe que context car il gère les opérations CRUD :

**Problème Principal :**
- Logique CRUD mélangée avec le rendering (createFolder, createFile, renameItem, deleteItem)
- Interface similaire à context mais avec des types différents
- Duplication potentielle de logique UI avec la page context

**Structure Actuelle :**
```
apps/web/src/app/(pages)/workspaces/[id]/documentation/page.tsx (402 lignes)
├── State management (treeData, selectedFile, fileContent, etc.)
├── CRUD operations (createFolder, createFile, renameItem, deleteItem, moveItems)
├── Content management (loadFileContent, saveFileContent, handleAutoSave)
└── Render logic (3 panneaux avec DocumentationTree, RichTextEditor, ChatPanel)
```

### Architecture Cible Cohérente

**Structure Après Refactoring :**
```
apps/web/src/
├── lib/types/
│   ├── common.ts                           # Interface TreeNodeBase commune
│   ├── context.ts                          # Types context (existant)
│   ├── documentation.ts                    # Types documentation (existant)
│   └── documentation-components.ts         # Props des nouveaux composants
├── components/
│   ├── [Context Components]                # TreeContext, FileContext, ChatContext (existants)
│   ├── DocumentationTreeEditor.tsx         # Arborescence éditable (~120 lignes)
│   ├── DocumentationContentEditor.tsx     # Éditeur TipTap (~100 lignes)
│   └── DocumentationChatPanel.tsx         # Chat documentation (~80 lignes)
└── app/(pages)/workspaces/[id]/documentation/page.tsx  # Coordinateur (<120 lignes)
```

### Spécifications des 3 Nouveaux Composants

#### 1. `DocumentationTreeEditor.tsx` - Panneau Gauche (~120 lignes)
**Responsabilités :**
- Affichage arborescence avec react-arborist
- Gestion des opérations CRUD (create, rename, delete, move)
- Édition inline des noms
- Boutons d'actions contextuelles

**Props Interface :**
```typescript
interface DocumentationTreeEditorProps {
  data: DocumentationNode[]
  selectedId?: string
  onSelect: (node: DocumentationNode | null) => void
  onCreateFolder: (parentId?: string) => Promise<void>
  onCreateFile: (parentId?: string) => Promise<void>
  onRename: (id: string, newName: string) => Promise<void>
  onDelete: (id: string) => Promise<void>
  onMove: (dragIds: string[], parentId?: string, index?: number) => Promise<void>
  isLoading?: boolean
}
```

#### 2. `DocumentationContentEditor.tsx` - Panneau Central (~100 lignes)
**Responsabilités :**
- Intégration TipTap Editor
- Gestion auto-sauvegarde
- États de chargement et sauvegarde
- Interface utilisateur d'édition

**Props Interface :**
```typescript
interface DocumentationContentEditorProps {
  selectedFile: DocumentationNode | null
  content: string
  onChange: (content: string) => void
  onAutoSave: (content: string) => Promise<void>
  isLoading?: boolean
  isSaving?: boolean
}
```

#### 3. `DocumentationChatPanel.tsx` - Panneau Droit (~80 lignes)
**Responsabilités :**
- Interface de chat spécialisée documentation
- Contexte documentation pour l'IA
- Préparation pour prompts spécialisés
- Actions spécifiques à la documentation

**Props Interface :**
```typescript
interface DocumentationChatPanelProps {
  selectedFile: DocumentationNode | null
  onSendMessage: (message: string) => Promise<void>
  messages: ChatMessage[]
  isLoading?: boolean
  workspaceId: string
}
```

### Interface Commune TreeNodeBase

Pour préparer la factorisation future, création d'une interface de base :

```typescript
// lib/types/common.ts
export interface TreeNodeBase {
  id: string
  name: string
  path: string
  type: 'file' | 'directory' | 'folder' // 'folder' = 'directory' pour documentation
  children?: TreeNodeBase[]
}

// lib/types/context.ts
export interface FileTreeNode extends TreeNodeBase {
  type: 'file' | 'directory'
  size?: number
  sha?: string
  language?: string
  url?: string
  download_url?: string
}

// lib/types/documentation.ts  
export interface DocumentationNode extends TreeNodeBase {
  type: 'file' | 'folder'
  fileExtension?: string
  parent_id?: string
  content?: string
  metadata?: DocumentationMetadata
  order_index: number
  created_at: string
  updated_at: string
}
```

### Avantages du Refactoring Cohérent

1. **Architecture Unifiée**
   - Même pattern de composition entre context et documentation
   - Préparation pour factorisation commune (Story 1.5.2)
   - Types harmonisés avec interface commune

2. **Maintenabilité Améliorée**
   - Logique CRUD encapsulée dans DocumentationTreeEditor
   - Séparation claire des responsabilités
   - Composants réutilisables et testables

3. **Évolutivité Préparée**
   - Interface commune pour futures optimisations
   - Composants prêts pour intégration IA différenciée
   - Structure cohérente pour nouvelles fonctionnalités

### Plan de Migration Pragmatique

1. **Phase 1 :** Interface commune et harmonisation types (impact minimal)
2. **Phase 2-4 :** Création des 3 composants spécialisés (extraction progressive)
3. **Phase 5 :** Refactoring page.tsx en coordinateur simple
4. **Phase 6 :** Validation complète et tests de régression

**Durée Estimée :** 2-3 jours de développement.
**Complexité :** Moyenne - extraction avec logique CRUD à maintenir.

## Dependencies et Prérequis
- Story 1.5 doit être complètement terminée et validée
- Story 1.3.1 (refactoring context) doit être validée comme référence
- Tests existants documentation doivent passer avant refactoring

## Acceptance Tests
1. **Test de Non-Régression :** Toutes fonctionnalités documentation identiques après refactoring
2. **Test CRUD :** Create, rename, delete, move fonctionnent parfaitement
3. **Test Auto-Save :** Sauvegarde automatique TipTap fonctionnelle
4. **Test Structure :** 3 composants séparés + coordinateur page.tsx <120 lignes
5. **Test Types :** Interface commune TreeNodeBase utilisée correctement
