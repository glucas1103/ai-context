# Story 1.6.1: Composant de Chat Universel Réutilisable

## Status
Draft (Dépend de Stories 1.5.1 & 1.5.2)

## Story
**As a** Développeur Frontend,
**I want** un composant de chat universel réutilisable qui peut être intégré dans différentes pages de l'application,
**so that** je puisse avoir une interface de chat cohérente et fonctionnelle pour toutes les interactions avec les agents IA, sans dupliquer le code.

## Acceptance Criteria

1. **Composant UniversalChatPanel Réutilisable**
   - Le composant `UniversalChatPanel` est complètement indépendant de la logique métier
   - Interface de chat fonctionnelle avec streaming des réponses en temps réel
   - Support markdown et coloration syntaxique du code dans les réponses
   - Gestion des états de chargement, erreur, et succès
   - Design cohérent avec l'architecture universelle (Story 1.5.2)

2. **Système de Messages et Sessions**
   - Structure de données standardisée pour les messages (user, assistant, system)
   - Gestion des sessions de chat avec persistance dans Supabase
   - Historique des conversations maintenu et récupérable
   - Support des métadonnées pour les messages (actions, fichiers, etc.)

3. **Interface Utilisateur Avancée**
   - Zone de saisie avec support markdown et raccourcis clavier
   - Affichage des messages avec timestamps et indicateurs de statut
   - Support des messages système (notifications, erreurs, actions)
   - Indicateurs visuels pour les actions en cours (typing, processing)
   - Responsive design pour différentes tailles d'écran

4. **Intégration avec Architecture Universelle**
   - Compatible avec `ThreePanelsLayout` et autres composants universels
   - Props configurables pour adapter le comportement selon le contexte
   - Callbacks standardisés pour les événements (message envoyé, reçu, etc.)
   - Support des thèmes et styles cohérents avec le design system

5. **Gestion des Erreurs et États**
   - Gestion gracieuse des erreurs de connexion et d'API
   - États de chargement appropriés pour chaque action
   - Retry automatique pour les échecs temporaires
   - Messages d'erreur informatifs pour l'utilisateur

6. **Extensibilité et Configuration**
   - Interface extensible pour ajouter de nouveaux types de messages
   - Configuration flexible pour les comportements (auto-scroll, notifications, etc.)
   - Support des plugins et extensions futures
   - Documentation complète pour les développeurs

## Tasks / Subtasks

### Phase 1: Architecture et Types (AC: 1, 2)
- [ ] Définir les types TypeScript pour les messages et sessions
- [ ] Créer l'interface `UniversalChatPanelProps` avec configuration
- [ ] Définir les callbacks et événements standardisés
- [ ] Créer les types pour les métadonnées et états

### Phase 2: Composant de Base (AC: 1, 3)
- [ ] Implémenter le composant `UniversalChatPanel` de base
- [ ] Créer les sous-composants (MessageList, MessageInput, ChatHeader)
- [ ] Implémenter la gestion des états (loading, error, success)
- [ ] Ajouter le support markdown avec `react-markdown`

### Phase 3: Interface Utilisateur (AC: 3, 4)
- [ ] Implémenter la zone de saisie avec support markdown
- [ ] Créer l'affichage des messages avec coloration syntaxique
- [ ] Ajouter les indicateurs visuels et animations
- [ ] Implémenter le design responsive

### Phase 4: Gestion des Sessions (AC: 2, 5)
- [ ] Créer les services pour la persistance Supabase
- [ ] Implémenter la gestion des sessions de chat
- [ ] Ajouter la gestion des erreurs et retry
- [ ] Créer les hooks React pour la gestion d'état

### Phase 5: Intégration et Tests (AC: 4, 6)
- [ ] Intégrer avec `ThreePanelsLayout` et composants universels
- [ ] Créer les tests unitaires et d'intégration
- [ ] Documenter l'API et les exemples d'utilisation
- [ ] Valider la compatibilité avec les pages existantes

## Dev Notes

### Architecture Technique

**Structure de Fichiers :**
```
src/components/universal/
├── UniversalChatPanel.tsx          # Composant principal
├── chat/
│   ├── MessageList.tsx             # Liste des messages
│   ├── MessageInput.tsx            # Zone de saisie
│   ├── ChatHeader.tsx              # En-tête du chat
│   ├── Message.tsx                 # Composant message individuel
│   └── ChatControls.tsx            # Contrôles (clear, export, etc.)
└── hooks/
    ├── useChatSession.ts           # Gestion session
    └── useChatMessages.ts          # Gestion messages
```

**Types TypeScript :**
```typescript
interface UniversalChatPanelProps {
  // Configuration
  sessionId?: string;
  agentType?: string;
  context?: ChatContext;
  
  // Callbacks
  onMessageSent?: (message: ChatMessage) => void;
  onMessageReceived?: (message: ChatMessage) => void;
  onSessionCreated?: (sessionId: string) => void;
  onError?: (error: ChatError) => void;
  
  // UI Configuration
  showHeader?: boolean;
  showControls?: boolean;
  autoScroll?: boolean;
  maxHeight?: string;
  
  // Styling
  className?: string;
  theme?: 'light' | 'dark';
}

interface ChatMessage {
  id: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: Date;
  metadata?: {
    actions?: string[];
    files?: string[];
    agentType?: string;
    [key: string]: any;
  };
  status?: 'sending' | 'sent' | 'error';
}

interface ChatSession {
  id: string;
  agentType: string;
  context: ChatContext;
  messages: ChatMessage[];
  createdAt: Date;
  updatedAt: Date;
}
```

**Intégration avec Architecture Universelle :**
- Utilise les patterns établis dans Story 1.5.2
- Compatible avec `ThreePanelsLayout` et autres composants
- Respecte les conventions de design et d'accessibilité
- Réutilise les services et types existants

### Base de Données

**Tables Supabase (déjà existantes) :**
```sql
-- Utilisation des tables existantes sans modification
-- chat_sessions et chat_messages déjà définies
```

**Extensions pour UniversalChatPanel :**
```typescript
// Services pour la persistance
interface ChatService {
  createSession(agentType: string, context: ChatContext): Promise<string>;
  getSession(sessionId: string): Promise<ChatSession>;
  addMessage(sessionId: string, message: ChatMessage): Promise<void>;
  getMessages(sessionId: string): Promise<ChatMessage[]>;
  updateSession(sessionId: string, updates: Partial<ChatSession>): Promise<void>;
}
```

### Testing

**Tests Requis :**
- Tests unitaires pour chaque sous-composant
- Tests d'intégration pour les interactions utilisateur
- Tests des callbacks et événements
- Tests de persistance avec Supabase
- Tests de responsive design

**Fichiers de Test :**
```
src/components/universal/__tests__/
├── UniversalChatPanel.test.tsx
├── chat/
│   ├── MessageList.test.tsx
│   ├── MessageInput.test.tsx
│   └── Message.test.tsx
└── hooks/
    ├── useChatSession.test.ts
    └── useChatMessages.test.ts
```

## Dependencies et Prérequis
- **CRITIQUE :** Story 1.5.2 doit être terminée (composants universels)
- Story 1.5.1 doit être complètement terminée (migration Documentation)
- Tables Supabase chat_sessions et chat_messages fonctionnelles
- Validation architecture universelle

## Stratégie d'Implémentation

**Ordre de Développement :**
1. **Types et Interfaces** : Définir la structure de données
2. **Composant de Base** : Implémenter la logique principale
3. **Interface Utilisateur** : Créer l'UI et les interactions
4. **Persistance** : Intégrer avec Supabase
5. **Tests et Documentation** : Valider et documenter

**Avantages de cette Approche :**
- Composant réutilisable pour toutes les pages
- Séparation claire entre UI et logique métier
- Facilité de maintenance et d'évolution
- Cohérence dans l'expérience utilisateur

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Création initiale de la story 1.6.1 | Sarah (PO) |

## Dev Agent Record
*Section à remplir par l'agent de développement lors de l'implémentation*
